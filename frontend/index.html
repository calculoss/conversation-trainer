<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversation Trainer - Professional Development Platform</title>
             <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Conversation Trainer - Professional Development Platform</title>

            <!-- External CSS Files -->
            <link rel="stylesheet" href="css/main.css">
            <link rel="stylesheet" href="css/tabs.css">
            <link rel="stylesheet" href="css/cards.css">
            <link rel="stylesheet" href="css/components.css">
            <link rel="stylesheet" href="css/email.css">
    <script src="config.js"></script>
</head>

<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">CT</div>
                    <div class="logo-text">
                        <h1>Conversation Trainer</h1>
                        <p>NSW Local Government Professional Development</p>
                    </div>
                </div>
                <div class="header-actions">
                    <div class="status-indicator">
                        <div class="status-dot"></div>
                        <span>Service Online</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Setup Screen -->
            <!-- Tab Navigation -->
            <div class="tab-navigation">
                <div class="tab-nav-container">
                    <button class="tab-button active" data-tab="quick-start">
                        <span class="tab-icon">üöÄ</span>
                        <span class="tab-label">Quick Start</span>
                    </button>
                    <button class="tab-button" data-tab="my-colleagues">
                        <span class="tab-icon">üë•</span>
                        <span class="tab-label">My Colleagues</span>
                        <span class="tab-count" id="colleaguesTabCount">0</span>
                    </button>
                    <button class="tab-button" data-tab="my-scenarios">
                        <span class="tab-icon">üìã</span>
                        <span class="tab-label">My Scenarios</span>
                        <span class="tab-count" id="scenariosTabCount">0</span>
                    </button>
                    <button class="tab-button" data-tab="disc-explorer">
                        <span class="tab-icon">üß†</span>
                        <span class="tab-label">DISC Explorer</span>
                    </button>
                    <button class="tab-button" data-tab="email-practice">
                        <span class="tab-icon">üìß</span>
                        <span class="tab-label">Email Practice</span>
                        <span class="tab-count" id="emailTabCount">0</span>
                    </button>
                </div>
            </div>

            <!-- Tab Content Areas -->
            <div class="tab-content-container">

                <!-- Quick Start Tab -->
                <div class="tab-content active" id="quick-start-tab">
                    <div class="tab-header">
                        <h2>Quick Start Practice Session</h2>
                        <p>Get started quickly with built-in personalities and scenarios</p>
                    </div>

                    <!-- Move existing setup-container content here -->
                    <div class="setup-container">
                        <!-- Role Selection -->
                        <div class="setup-panel">
                            <div class="panel-header">
                                <div class="panel-icon role">üë§</div>
                                <h2 class="panel-title">Your Role</h2>
                            </div>
                            <div class="selection-grid">
                                <div class="option-card" data-role="director">
                                    <div class="option-title">Director</div>
                                    <div class="option-description">Practice strategic leadership, mentoring conversations, and budget discussions with senior stakeholders.</div>
                                </div>
                                <div class="option-card" data-role="manager">
                                    <div class="option-title">Manager</div>
                                    <div class="option-description">Handle performance reviews, team conflicts, and operational discussions with staff and colleagues.</div>
                                </div>
                                <div class="option-card" data-role="customer-service">
                                    <div class="option-title">Customer Service Officer</div>
                                    <div class="option-description">Manage resident complaints, billing disputes, and challenging service-related conversations.</div>
                                </div>
                                <div class="option-card" data-role="project-manager">
                                    <div class="option-title">Project Manager</div>
                                    <div class="option-description">Navigate stakeholder negotiations, contractor management, and cross-departmental coordination.</div>
                                </div>
                            </div>
                        </div>

                        <!-- Scenario Selection -->
                        <div class="setup-panel">
                            <div class="panel-header">
                                <div class="panel-icon scenario">üìã</div>
                                <h2 class="panel-title">Practice Scenario</h2>
                            </div>
                            <div class="selection-grid">
                                <div class="option-card" data-scenario="budget_cuts">
                                    <div class="option-title">Budget Reduction Discussion</div>
                                    <div class="option-description">Practice explaining budget cuts while maintaining team morale and finding creative solutions to resource constraints.</div>
                                </div>
                                <div class="option-card" data-scenario="angry_resident">
                                    <div class="option-title">Challenging Resident Interaction</div>
                                    <div class="option-description">Handle frustrated ratepayer complaints about service levels, rate increases, and council decisions.</div>
                                </div>
                            </div>
                        </div>

                        <!-- Built-in Personalities Only (for quick start) -->
                        <div class="setup-panel full-width">
                            <div class="panel-header">
                                <div class="panel-icon personality">üé≠</div>
                                <h2 class="panel-title">Built-in Personalities</h2>
                            </div>
                            <div class="personality-grid" id="quickStartPersonalities">
                                <!-- Built-in personalities will be loaded here -->
                            </div>
                        </div>

                        <!-- Quick Start Action Panel -->
                        <div class="action-panel">
                            <button class="start-button" id="quickStartButton" disabled>
                                <span>üöÄ</span>
                                <span>Begin Practice Session</span>
                            </button>
                            <p style="margin-top: 1rem; color: #64748b; font-size: 0.875rem;">
                                Quick practice with built-in personalities and scenarios
                            </p>
                        </div>
                    </div>
                </div>

                <!-- My Colleagues Tab -->
                <div class="tab-content" id="my-colleagues-tab">
                    <div class="tab-header">
                        <h2>My Colleague Library</h2>
                        <p>Manage your saved colleagues and create new ones</p>
                    </div>

                    <div class="colleague-management">
                        <div class="colleagues-toolbar">
                            <div class="search-filter-section">
                                <input type="text" class="search-input" placeholder="Search colleagues..." id="colleagueSearch">
                                <select class="filter-select" id="colleagueFilter">
                                    <option value="">All Colleagues</option>
                                    <option value="recent">Recently Used</option>
                                    <option value="unused">Never Used</option>
                                </select>
                            </div>
                            <div class="action-buttons">
                                <button class="btn btn-primary" onclick="showCustomCharacterModal()">
                                    ‚ûï Create New Colleague
                                </button>
                                <button class="btn btn-secondary" onclick="importColleagues()">
                                    üìÇ Import
                                </button>
                            </div>
                        </div>

                        <div class="colleagues-grid" id="colleaguesGrid">
                            <!-- Enhanced colleague cards will be loaded here -->
                        </div>

                        <div class="empty-state colleagues-empty" id="colleaguesEmpty">
                            <h3>No colleagues yet</h3>
                            <p>Create your first colleague to start building your practice library</p>
                            <button class="btn btn-primary" onclick="showCustomCharacterModal()">
                                Create First Colleague
                            </button>
                        </div>
                    </div>
                </div>

                <!-- My Scenarios Tab -->
                <div class="tab-content" id="my-scenarios-tab">
                    <div class="tab-header">
                        <h2>My Scenario Library</h2>
                        <p>Manage your saved scenarios and create new ones</p>
                    </div>

                    <div class="scenario-management">
                        <div class="scenarios-toolbar">
                            <div class="search-filter-section">
                                <input type="text" class="search-input" placeholder="Search scenarios..." id="scenarioSearch">
                                <select class="filter-select" id="scenarioFilter">
                                    <option value="">All Scenarios</option>
                                    <option value="budget_review">Budget Review</option>
                                    <option value="project_planning">Project Planning</option>
                                    <option value="performance_discussion">Performance Discussion</option>
                                </select>
                            </div>
                            <div class="action-buttons">
                                <button class="btn btn-primary" onclick="showCustomScenarioModal()">
                                    ‚ûï Create New Scenario
                                </button>
                                <button class="btn btn-secondary" onclick="importScenarios()">
                                    üìÇ Import
                                </button>
                            </div>
                        </div>

                        <div class="scenarios-grid" id="scenariosGrid">
                            <!-- Enhanced scenario cards will be loaded here -->
                        </div>

                        <div class="empty-state scenarios-empty" id="scenariosEmpty">
                            <h3>No scenarios yet</h3>
                            <p>Create your first scenario to start building your practice library</p>
                            <button class="btn btn-primary" onclick="showCustomScenarioModal()">
                                Create First Scenario
                            </button>
                        </div>
                    </div>
                </div>

                <!-- DISC Explorer Tab -->
                <div class="tab-content" id="disc-explorer-tab">
                    <div class="tab-header">
                        <h2>DISC Explorer</h2>
                        <p>Learn about DISC personality types and their workplace behaviors</p>
                    </div>

                    <div class="disc-content">
                        <div class="disc-overview">
                            <h3>Understanding DISC Personalities</h3>
                            <p>DISC is a behavioral assessment tool that helps understand how people prefer to communicate and work. The four types represent different behavioral styles:</p>
                        </div>

                        <div class="disc-types-grid">
                            <div class="disc-type-card" data-type="D">
                                <div class="disc-type-header">
                                    <div class="disc-type-icon dominant">D</div>
                                    <h4>Dominance</h4>
                                    <span class="disc-percentage">3-11% of population</span>
                                </div>
                                <div class="disc-type-content">
                                    <p><strong>Key Traits:</strong> Results-focused, direct, decisive, competitive</p>
                                    <p><strong>In Meetings:</strong> Takes charge, challenges ideas, pushes for quick decisions</p>
                                    <p><strong>Communication:</strong> Prefers brief, bottom-line focused discussions</p>
                                </div>
                            </div>

                            <div class="disc-type-card" data-type="I">
                                <div class="disc-type-header">
                                    <div class="disc-type-icon influence">I</div>
                                    <h4>Influence</h4>
                                    <span class="disc-percentage">11-40% of population</span>
                                </div>
                                <div class="disc-type-content">
                                    <p><strong>Key Traits:</strong> Enthusiastic, optimistic, social, persuasive</p>
                                    <p><strong>In Meetings:</strong> Builds consensus, shares ideas openly, motivates others</p>
                                    <p><strong>Communication:</strong> Enjoys interaction, storytelling, relationship-building</p>
                                </div>
                            </div>

                            <div class="disc-type-card" data-type="S">
                                <div class="disc-type-header">
                                    <div class="disc-type-icon steadiness">S</div>
                                    <h4>Steadiness</h4>
                                    <span class="disc-percentage">69% of population</span>
                                </div>
                                <div class="disc-type-content">
                                    <p><strong>Key Traits:</strong> Patient, reliable, supportive, good listener</p>
                                    <p><strong>In Meetings:</strong> Asks clarifying questions, seeks consensus, supports team</p>
                                    <p><strong>Communication:</strong> Prefers one-on-one, thoughtful discussion, avoids conflict</p>
                                </div>
                            </div>

                            <div class="disc-type-card" data-type="C">
                                <div class="disc-type-header">
                                    <div class="disc-type-icon conscientiousness">C</div>
                                    <h4>Conscientiousness</h4>
                                    <span class="disc-percentage">17% of population</span>
                                </div>
                                <div class="disc-type-content">
                                    <p><strong>Key Traits:</strong> Analytical, precise, systematic, quality-focused</p>
                                    <p><strong>In Meetings:</strong> Asks detailed questions, wants data, ensures accuracy</p>
                                    <p><strong>Communication:</strong> Prefers facts, data, written follow-up, thorough analysis</p>
                                </div>
                            </div>
                        </div>

                        <div class="disc-workplace-section">
                            <h3>DISC in NSW Local Government</h3>
                            <p>Different roles tend to attract different DISC types. Understanding these patterns helps you practice more realistic conversations:</p>

                            <div class="workplace-examples">
                                <div class="workplace-example">
                                    <h4>üèóÔ∏è Engineering & Infrastructure</h4>
                                    <p>Typically High C personalities who value technical accuracy and detailed analysis</p>
                                </div>
                                <div class="workplace-example">
                                    <h4>üë• Community Services</h4>
                                    <p>Often High I and S personalities focused on relationships and service delivery</p>
                                </div>
                                <div class="workplace-example">
                                    <h4>üí∞ Finance & Administration</h4>
                                    <p>Usually High C personalities with attention to detail and process accuracy</p>
                                </div>
                                <div class="workplace-example">
                                    <h4>üìã Customer Service</h4>
                                    <p>Commonly High S personalities with patience and people-helping focus</p>
                                </div>
                            </div>
                        </div>

                        <div class="interactive-quadrant-section">
                            <h3>üéØ Interactive DISC Quadrant</h3>
                            <p>Explore realistic population distribution and NSW Local Government insights</p>

                            <div class="quadrant-controls">
                                <div class="view-toggles">
                                    <button class="toggle-btn active" data-view="population">Population View</button>
                                    <button class="toggle-btn" data-view="department">Department View</button>
                                    <button class="toggle-btn" data-view="generation">Generation View</button>
                                </div>
                                <div class="filter-info">
                                    <span id="currentViewInfo">Showing: General Population Distribution</span>
                                </div>
                            </div>

                            <div class="disc-quadrant-container">
                                <div class="quadrant-grid">
                                    <!-- D Quadrant -->
                                    <div class="quadrant d-quadrant" data-type="D">
                                        <div class="quadrant-header">
                                            <div class="quadrant-icon">D</div>
                                            <div class="quadrant-title">Dominance</div>
                                        </div>
                                        <div class="population-display">
                                            <div class="population-bar">
                                                <div class="population-fill d-fill" style="width: 7%"></div>
                                            </div>
                                            <span class="population-text">3-11% of population</span>
                                        </div>
                                        <div class="quadrant-examples">
                                            <div class="example-role">Infrastructure Directors</div>
                                            <div class="example-role">Project Managers</div>
                                            <div class="example-role">Crisis Managers</div>
                                        </div>
                                    </div>

                                    <!-- I Quadrant -->
                                    <div class="quadrant i-quadrant" data-type="I">
                                        <div class="quadrant-header">
                                            <div class="quadrant-icon">I</div>
                                            <div class="quadrant-title">Influence</div>
                                        </div>
                                        <div class="population-display">
                                            <div class="population-bar">
                                                <div class="population-fill i-fill" style="width: 25%"></div>
                                            </div>
                                            <span class="population-text">11-40% of population</span>
                                        </div>
                                        <div class="quadrant-examples">
                                            <div class="example-role">Community Engagement</div>
                                            <div class="example-role">Customer Service</div>
                                            <div class="example-role">Elected Councillors</div>
                                        </div>
                                    </div>

                                    <!-- S Quadrant -->
                                    <div class="quadrant s-quadrant" data-type="S">
                                        <div class="quadrant-header">
                                            <div class="quadrant-icon">S</div>
                                            <div class="quadrant-title">Steadiness</div>
                                        </div>
                                        <div class="population-display">
                                            <div class="population-bar">
                                                <div class="population-fill s-fill" style="width: 69%"></div>
                                            </div>
                                            <span class="population-text">69% of population</span>
                                        </div>
                                        <div class="quadrant-examples">
                                            <div class="example-role">Administrative Staff</div>
                                            <div class="example-role">Service Delivery</div>
                                            <div class="example-role">Policy Implementation</div>
                                        </div>
                                    </div>

                                    <!-- C Quadrant -->
                                    <div class="quadrant c-quadrant" data-type="C">
                                        <div class="quadrant-header">
                                            <div class="quadrant-icon">C</div>
                                            <div class="quadrant-title">Conscientiousness</div>
                                        </div>
                                        <div class="population-display">
                                            <div class="population-bar">
                                                <div class="population-fill c-fill" style="width: 17%"></div>
                                            </div>
                                            <span class="population-text">17% of population</span>
                                        </div>
                                        <div class="quadrant-examples">
                                            <div class="example-role">Budget Analysts</div>
                                            <div class="example-role">Engineers</div>
                                            <div class="example-role">Compliance Officers</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="quadrant-insights">
                                    <div class="insight-panel" id="insightPanel">
                                        <h4>üí° NSW Local Government Insights</h4>
                                        <p>Click on any quadrant above to explore specific insights for that DISC type in NSW councils.</p>
                                        <div class="insight-stats">
                                            <div class="stat-item">
                                                <span class="stat-number">69%</span>
                                                <span class="stat-label">S-types form the backbone of council operations</span>
                                            </div>
                                            <div class="stat-item">
                                                <span class="stat-number">43</span>
                                                <span class="stat-label">Median age in NSW councils</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Email Practice Tab -->
                <div class="tab-content" id="email-practice-tab">
                    <div class="tab-header">
                        <h2>üìß Email Practice & Analysis</h2>
                        <p>Improve your email communication with AI-powered analysis and DISC insights</p>
                    </div>

                    <!-- Email Mode Selector -->
                    <div class="email-mode-selector">
                        <div class="mode-buttons">
                            <button class="mode-button active" data-mode="analysis">
                                <span class="mode-icon">üìä</span>
                                <span class="mode-label">Email Analysis</span>
                                <span class="mode-desc">Analyze and improve your emails</span>
                            </button>
                            <button class="mode-button" data-mode="templates">
                                <span class="mode-icon">üìù</span>
                                <span class="mode-label">Email Templates</span>
                                <span class="mode-desc">Save and manage email templates</span>
                            </button>
                            <button class="mode-button" data-mode="simulation" disabled>
                                <span class="mode-icon">üí¨</span>
                                <span class="mode-label">Email Simulation</span>
                                <span class="mode-desc">Coming Soon - Practice conversations</span>
                            </button>
                        </div>
                    </div>

                    <!-- Email Analysis Mode -->
                    <div class="email-mode-content active" id="analysis-mode">
                        <div class="email-analysis-workspace">
                            <!-- Left Side: Email Composer -->
                            <div class="email-composer-section">
                                <div class="composer-card">
                                    <div class="composer-header">
                                        <h3>üìù Compose Email</h3>
                                        <div class="composer-actions-header">
                                            <button class="btn btn-secondary btn-sm" id="loadTemplateBtn">
                                                üìã Load Template
                                            </button>
                                            <button class="btn btn-secondary btn-sm" id="clearEmailBtn">
                                                üóëÔ∏è Clear
                                            </button>
                                        </div>
                                    </div>

                                    <div class="composer-form">
                                        <div class="form-row">
                                            <div class="form-field">
                                                <label for="emailRecipient">To:</label>
                                                <select id="emailRecipient" class="form-input">
                                                    <option value="">Select colleague...</option>
                                                    <!-- Will be populated from your existing colleague library -->
                                                </select>
                                            </div>
                                            <div class="form-field">
                                                <label for="emailSubject">Subject:</label>
                                                <input type="text" id="emailSubject" class="form-input"
                                                       placeholder="Enter email subject">
                                            </div>
                                        </div>

                                        <div class="form-field">
                                            <label for="emailContent">Email Content:</label>
                                            <textarea id="emailContent" class="form-textarea" rows="12"
                                                      placeholder="Dear [Name],

I hope this email finds you well.

[Your message here]

Best regards,
[Your name]"></textarea>
                                        </div>

                                        <div class="composer-actions">
                                            <button class="btn btn-primary" id="analyzeEmailBtn">
                                                üìä Analyze Email
                                            </button>
                                            <button class="btn btn-secondary" id="saveAsTemplateBtn">
                                                üíæ Save as Template
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Right Side: Analysis Results -->
                            <div class="email-analysis-section">
                                <!-- Colleague Info Panel -->
                                <div class="colleague-info-panel" id="colleagueInfoPanel" style="display: none;">
                                    <div class="panel-header">
                                        <h4>üë§ Recipient Profile</h4>
                                    </div>
                                    <div class="panel-content">
                                        <div class="colleague-avatar" id="colleagueAvatar">SC</div>
                                        <div class="colleague-details">
                                            <h5 id="colleagueName">Sarah Chen</h5>
                                            <p id="colleagueRole">Community Engagement Officer</p>
                                            <div class="colleague-disc">
                                                <span class="disc-badge" id="colleagueDisc">I-Type</span>
                                                <span class="disc-description">People-focused, collaborative</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Analysis Results Panel -->
                                <div class="analysis-results-panel" id="analysisResultsPanel" style="display: none;">
                                    <div class="panel-header">
                                        <h4>üìä Analysis Results</h4>
                                        <button class="close-btn" id="closeAnalysisBtn">√ó</button>
                                    </div>

                                    <div class="analysis-content">
                                        <!-- Overall Score -->
                                        <div class="overall-score-section">
                                            <div class="score-circle">
                                                <span class="score-number" id="overallScore">8.5</span>
                                                <span class="score-label">Overall</span>
                                            </div>
                                            <div class="score-description">
                                                <h5>Communication Effectiveness</h5>
                                                <p id="overallFeedback">Great collaborative tone for this recipient!</p>
                                            </div>
                                        </div>

                                        <!-- DISC Compatibility -->
                                        <div class="disc-analysis-section">
                                            <h5>üé≠ DISC Compatibility</h5>
                                            <div class="disc-scores">
                                                <div class="disc-score-item">
                                                    <div class="disc-icon d-type">D</div>
                                                    <div class="disc-details">
                                                        <span class="disc-score" id="discScoreD">7</span>
                                                        <span class="disc-feedback" id="discFeedbackD">Good directness</span>
                                                    </div>
                                                </div>
                                                <div class="disc-score-item">
                                                    <div class="disc-icon i-type">I</div>
                                                    <div class="disc-details">
                                                        <span class="disc-score" id="discScoreI">9</span>
                                                        <span class="disc-feedback" id="discFeedbackI">Excellent engagement</span>
                                                    </div>
                                                </div>
                                                <div class="disc-score-item">
                                                    <div class="disc-icon s-type">S</div>
                                                    <div class="disc-details">
                                                        <span class="disc-score" id="discScoreS">8</span>
                                                        <span class="disc-feedback" id="discFeedbackS">Respectful tone</span>
                                                    </div>
                                                </div>
                                                <div class="disc-score-item">
                                                    <div class="disc-icon c-type">C</div>
                                                    <div class="disc-details">
                                                        <span class="disc-score" id="discScoreC">6</span>
                                                        <span class="disc-feedback" id="discFeedbackC">Add more details</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Suggestions -->
                                        <div class="suggestions-section">
                                            <h5>üí° Improvement Suggestions</h5>
                                            <div class="suggestions-list" id="suggestionsList">
                                                <!-- Suggestions will be populated here -->
                                            </div>
                                        </div>

                                        <!-- Quick Tips -->
                                        <div class="quick-tips-section">
                                            <h5>üéØ Quick Tips for This Colleague</h5>
                                            <div class="tips-list" id="quickTipsList">
                                                <!-- Tips will be populated here -->
                                            </div>
                                        </div>
                                    </div>

                                    <div class="analysis-actions">
                                        <button class="btn btn-primary btn-sm" id="exportAnalysisBtn">
                                            üìÑ Export Analysis
                                        </button>
                                        <button class="btn btn-secondary btn-sm" id="improveEmailBtn">
                                            ‚ú® Apply Suggestions
                                        </button>
                                    </div>
                                </div>

                                <!-- Getting Started Panel (shown initially) -->
                                <div class="getting-started-panel" id="gettingStartedPanel">
                                    <div class="panel-content">
                                        <div class="getting-started-icon">üìß</div>
                                        <h4>Get Started with Email Analysis</h4>
                                        <p>Write an email and select a colleague to get personalized communication insights.</p>

                                        <div class="features-preview">
                                            <div class="feature-item">
                                                <span class="feature-icon">üé≠</span>
                                                <span class="feature-text">DISC Compatibility Analysis</span>
                                            </div>
                                            <div class="feature-item">
                                                <span class="feature-icon">üìä</span>
                                                <span class="feature-text">Communication Effectiveness Scoring</span>
                                            </div>
                                            <div class="feature-item">
                                                <span class="feature-icon">üí°</span>
                                                <span class="feature-text">Personalized Improvement Suggestions</span>
                                            </div>
                                            <div class="feature-item">
                                                <span class="feature-icon">üéØ</span>
                                                <span class="feature-text">NSW Council Context Awareness</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Email Templates Mode -->
                    <div class="email-mode-content" id="templates-mode">
                        <div class="templates-workspace">
                            <div class="templates-header">
                                <h3>üìù Email Templates Library</h3>
                                <div class="templates-actions">
                                    <button class="btn btn-primary" id="createTemplateBtn">
                                        ‚ûï Create New Template
                                    </button>
                                    <button class="btn btn-secondary" id="importTemplatesBtn">
                                        üìÇ Import Templates
                                    </button>
                                </div>
                            </div>

                            <div class="templates-search">
                                <input type="text" class="search-input" placeholder="Search templates..." id="templateSearch">
                                <select class="filter-select" id="templateFilter">
                                    <option value="">All Categories</option>
                                    <option value="budget">Budget & Finance</option>
                                    <option value="policy">Policy Updates</option>
                                    <option value="project">Project Management</option>
                                    <option value="meeting">Meeting Requests</option>
                                </select>
                            </div>

                            <div class="templates-grid" id="templatesGrid">
                                <!-- Templates will be loaded here -->
                            </div>

                            <div class="empty-state templates-empty" id="templatesEmpty">
                                <h4>No email templates yet</h4>
                                <p>Create your first template to build your professional email library</p>
                                <button class="btn btn-primary" id="createFirstTemplateBtn">
                                    Create First Template
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Simulation Mode (Coming Soon) -->
                    <div class="email-mode-content" id="simulation-mode">
                        <div class="coming-soon-panel">
                            <div class="coming-soon-content">
                                <h3>üí¨ Email Simulation</h3>
                                <p>Practice email conversations with AI colleagues</p>
                                <div class="coming-soon-features">
                                    <div class="feature">‚ú® Real-time conversation simulation</div>
                                    <div class="feature">üìà Live feedback and coaching</div>
                                    <div class="feature">üéØ Scenario-based practice sessions</div>
                                </div>
                                <p><strong>Coming Soon!</strong> We're working on this exciting feature.</p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="success-message" id="successMessage">
                ‚úÖ Connected to conversation service successfully
            </div>

            <div class="error-message" id="errorMessage">
                ‚ùå Error starting conversation
            </div>

        </main>

        <!-- Chat Screen -->
        <div id="chatScreen" class="chat-screen">
            <div class="chat-header">
                <div class="chat-info">
                    <div class="participant-avatar" id="participantAvatar">CS</div>
                    <div class="chat-details">
                        <h3 id="participantName">Practice Session</h3>
                        <p id="scenarioDescription">Preparing conversation...</p>
                    </div>
                </div>
                <div>
                    <button class="secondary-button" id="endConversation">End Session</button>
                </div>
            </div>

            <div class="messages-area" id="messagesArea">
                <!-- Messages will be added here dynamically -->
            </div>

            <div class="input-area">
                <div class="input-container">
                    <textarea class="message-input" id="messageInput" placeholder="Type your response..." rows="1" disabled></textarea>
                    <button class="send-button" id="sendButton" disabled>
                        <span>Send</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Enhanced Custom Character Modal -->
        <div class="modal-overlay" id="customCharacterModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Create Your Custom Colleague</h3>
                    <p style="color: #64748b; font-size: 0.9rem; margin-top: 0.5rem;">Build a realistic virtual version of someone from your workplace</p>
                </div>

                <!-- Character Creation Form -->
                <div id="characterCreationForm">
                    <!-- Basic Information -->
                    <div class="form-section">
                        <h4 class="section-title">üë§ Basic Information</h4>

                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label class="form-label">Full Name</label>
                                <input type="text" class="form-input" id="customName" placeholder="e.g., David Morrison">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Job Title/Role</label>
                                <input type="text" class="form-input" id="customRole" placeholder="e.g., Senior Engineer">
                            </div>
                        </div>
                    </div>

                    <!-- Workplace Behavior -->
                    <div class="form-section">
                        <h4 class="section-title">üè¢ Workplace Behavior</h4>

                        <div class="form-group">
                            <label class="form-label">How do they typically behave in meetings?</label>
                            <textarea class="form-input form-textarea" id="customPersonality" placeholder="e.g., Speaks first, asks lots of questions, interrupts when excited, focuses on technical details..."></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">What motivates them most?</label>
                            <textarea class="form-input form-textarea" id="customMotivations" placeholder="e.g., Recognition for achievements, job security, solving complex problems..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="modal-actions">
                    <button class="btn btn-secondary" id="cancelCustomCharacter">Cancel</button>
                    <button class="btn btn-primary" id="saveCustomCharacter">
                        üíæ Create Character
                    </button>
                </div>
            </div>
        </div>

        <!-- Custom Scenario Modal -->
        <div class="modal-overlay" id="customScenarioModal">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h3 class="modal-title">Create Your Custom Scenario</h3>
                </div>

                <div class="form-group">
                    <label class="form-label">Scenario Title</label>
                    <input type="text" class="form-input" id="customScenarioTitle" placeholder="e.g., Budget Approval Meeting - Q2 Infrastructure Spend">
                </div>

                <div class="form-group">
                    <label class="form-label">Meeting Context & Background</label>
                    <textarea class="form-input form-textarea" id="customScenarioContext" placeholder="Describe the situation leading up to this meeting. What decisions need to be made? What's happened before? What are the stakes?"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Your Role & Objective</label>
                    <textarea class="form-input form-textarea" id="customScenarioObjective" placeholder="What's your position in this meeting? What are you trying to achieve? What approach do you plan to take?"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Expected Challenges</label>
                    <textarea class="form-input form-textarea" id="customScenarioChallenges" placeholder="What resistance or difficulties do you anticipate? What objections might come up?"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Meeting Type</label>
                    <select class="form-input" id="customScenarioType">
                        <option value="budget_review">Budget Review</option>
                        <option value="project_planning">Project Planning</option>
                        <option value="performance_discussion">Performance Discussion</option>
                        <option value="policy_decision">Policy Decision</option>
                        <option value="stakeholder_negotiation">Stakeholder Negotiation</option>
                        <option value="crisis_management">Crisis Management</option>
                        <option value="vendor_meeting">Vendor/Contractor Meeting</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="modal-actions">
                    <button class="btn btn-secondary" id="cancelCustomScenario">Cancel</button>
                    <button class="btn btn-primary" id="saveCustomScenario">Create Scenario</button>
                </div>
            </div>
        </div>

<script>
// ============================================
// CONFIGURATION & STATE
// ============================================
const API_BASE_URL = 'https://conversation-trainer-production.up.railway.app';

let appState = {
    selectedRole: null,
    selectedScenario: null,
    selectedPersonality: null,
    currentConversation: null,
    conversationHistory: [],
    isConnected: false
};

let customCharacterData = null;
let customScenarioData = null;

// ============================================
// UTILITY FUNCTIONS
// ============================================
function debugLog(message, data = null) {
    const timestamp = new Date().toLocaleTimeString();
    console.log(`üîç [${timestamp}] ${message}`, data || '');
}

function showSuccessMessage(message) {
    const successMsg = document.getElementById('successMessage');
    if (successMsg) {
        successMsg.textContent = message;
        successMsg.style.display = 'block';
        setTimeout(() => {
            successMsg.style.display = 'none';
        }, 4000);
    }
}

function showErrorMessage(message) {
    const errorMsg = document.getElementById('errorMessage');
    if (errorMsg) {
        errorMsg.textContent = message;
        errorMsg.style.display = 'block';
        setTimeout(() => {
            errorMsg.style.display = 'none';
        }, 6000);
    }
}
// ============================================
// GOOGLE CLOUD TTS INTEGRATION FOR CONVERSATION TRAINER
// Add this code to your existing index.html JavaScript section
// ============================================

// Global variables for TTS management
let currentTTSAudio = null;
let isSpeaking = false;
let voiceEnabled = true; // User can toggle this

// ============================================
// GOOGLE CLOUD TEXT-TO-SPEECH FUNCTIONS
// ============================================

/**
 * Main function to speak AI responses using Google Cloud TTS
 * @param {string} text - Text to be spoken
 * @param {string} personalityType - The personality type for voice selection
 * @param {Object} options - Optional settings for speech
 */
async function speakWithGoogleTTS(text, personalityType = null, options = {}) {
    // Check if voice is enabled and we have an API key
    if (!voiceEnabled || !CONFIG?.GOOGLE_TTS_API_KEY || CONFIG.GOOGLE_TTS_API_KEY === 'YOUR_API_KEY_HERE') {
        debugLog('‚ö†Ô∏è Google TTS not available, falling back to browser TTS');
        fallbackToBrowserTTS(text, personalityType);
        return;
    }

    try {
        debugLog('üó£Ô∏è Speaking with Google TTS:', { text: text.substring(0, 50) + '...', personality: personalityType });

        // Stop any current audio
        stopCurrentTTS();

        // Get voice configuration for personality
        const voiceConfig = getVoiceForPersonality(personalityType);

        // Prepare the request
        const requestBody = {
            input: { text: cleanTextForTTS(text) },
            voice: {
                name: voiceConfig.name,
                languageCode: voiceConfig.languageCode
            },
            audioConfig: {
                ...CONFIG.AUDIO_CONFIG,
                ...options // Allow override of default settings
            }
        };

        debugLog('üì§ TTS Request:', requestBody);

        // Show speaking indicator
        updateTTSStatus('speaking', `Speaking as ${voiceConfig.description}...`);

        // Make API request
        const response = await fetch(`${CONFIG.GOOGLE_TTS_ENDPOINT}?key=${CONFIG.GOOGLE_TTS_API_KEY}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
            throw new Error(`TTS API Error: ${response.status} - ${response.statusText}`);
        }

        const data = await response.json();

        if (data.audioContent) {
            // Convert base64 audio to playable audio
            await playTTSAudio(data.audioContent, text);
        } else {
            throw new Error('No audio content received from Google TTS');
        }

    } catch (error) {
        debugLog('‚ùå Google TTS error:', error);

        // Fallback to browser TTS
        if (CONFIG.FEATURES?.fallbackToBrowserTTS) {
            debugLog('üîÑ Falling back to browser TTS');
            fallbackToBrowserTTS(text, personalityType);
        } else {
            updateTTSStatus('error', `TTS Error: ${error.message}`);
        }
    }
}

/**
 * Get the appropriate voice configuration for a personality type
 * @param {string} personalityType - The personality type
 * @returns {Object} Voice configuration object
 */
function getVoiceForPersonality(personalityType) {
    // Handle saved colleagues
    if (personalityType && personalityType.startsWith('saved_colleague_') && customCharacterData) {
        // For saved colleagues, we can use their DISC type or default
        debugLog('üé≠ Using voice for saved colleague:', customCharacterData.name);
        // Default to professional Australian voice for custom characters
        return CONFIG.DISC_VOICES.custom_character;
    }

    // Get voice from configuration or use default
    const voiceConfig = CONFIG.DISC_VOICES[personalityType] || CONFIG.DISC_VOICES.custom_character;

    debugLog('üéµ Selected voice:', { personality: personalityType, voice: voiceConfig });

    return voiceConfig;
}

/**
 * Clean and prepare text for TTS
 * @param {string} text - Raw text
 * @returns {string} Cleaned text suitable for TTS
 */
function cleanTextForTTS(text) {
    return text
        // Remove markdown formatting
        .replace(/\*\*(.*?)\*\*/g, '$1')     // Bold text
        .replace(/\*(.*?)\*/g, '$1')         // Italic text
        .replace(/`(.*?)`/g, '$1')           // Code blocks

        // Clean up common chat artifacts
        .replace(/https?:\/\/[^\s]+/g, 'link')  // Replace URLs
        .replace(/@\w+/g, '')                   // Remove mentions
        .replace(/#\w+/g, '')                   // Remove hashtags

        // Fix common abbreviations for better pronunciation
        .replace(/\bNSW\b/g, 'New South Wales')
        .replace(/\bCouncil\b/g, 'Council')
        .replace(/\bCEO\b/g, 'C E O')
        .replace(/\bCFO\b/g, 'C F O')
        .replace(/\bIT\b/g, 'I T')

        // Ensure proper sentence ending
        .trim()
        .replace(/([^.!?])$/, '$1.');
}

/**
 * Convert base64 audio to blob and play it
 * @param {string} base64Audio - Base64 encoded audio from Google TTS
 * @param {string} originalText - Original text for debugging
 */
async function playTTSAudio(base64Audio, originalText) {
    try {
        // Convert base64 to blob
        const audioBlob = base64ToBlob(base64Audio, 'audio/mp3');
        const audioUrl = URL.createObjectURL(audioBlob);

        // Create audio element
        currentTTSAudio = new Audio(audioUrl);
        isSpeaking = true;

        // Set up event handlers
        currentTTSAudio.onended = function() {
            debugLog('‚úÖ TTS playback completed');
            isSpeaking = false;
            updateTTSStatus('idle', 'Voice ready');

            // Clean up
            URL.revokeObjectURL(audioUrl);
            currentTTSAudio = null;
        };

        currentTTSAudio.onerror = function(error) {
            debugLog('‚ùå TTS audio playback error:', error);
            isSpeaking = false;
            updateTTSStatus('error', 'Audio playback failed');
            currentTTSAudio = null;
        };

        // Start playback
        await currentTTSAudio.play();
        debugLog('üîä TTS audio playing');

    } catch (error) {
        debugLog('‚ùå Audio playback error:', error);
        isSpeaking = false;
        updateTTSStatus('error', 'Audio playback failed');
        throw error;
    }
}

/**
 * Stop any currently playing TTS audio
 */
function stopCurrentTTS() {
    if (currentTTSAudio) {
        currentTTSAudio.pause();
        currentTTSAudio = null;
    }

    // Also stop browser TTS as fallback
    if (window.speechSynthesis) {
        window.speechSynthesis.cancel();
    }

    isSpeaking = false;
    updateTTSStatus('idle', 'Voice ready');
}

/**
 * Toggle voice on/off
 */
function toggleVoice() {
    voiceEnabled = !voiceEnabled;
    debugLog(`üîä Voice ${voiceEnabled ? 'enabled' : 'disabled'}`);

    if (!voiceEnabled) {
        stopCurrentTTS();
    }

    // Update UI if voice toggle button exists
    const voiceToggle = document.getElementById('voiceToggle');
    if (voiceToggle) {
        voiceToggle.textContent = voiceEnabled ? 'üîä Voice On' : 'üîá Voice Off';
        voiceToggle.className = voiceEnabled ? 'voice-enabled' : 'voice-disabled';
    }

    updateTTSStatus('info', voiceEnabled ? 'Voice enabled' : 'Voice disabled');
}

// ============================================
// FALLBACK TO BROWSER TTS
// ============================================

/**
 * Fallback to browser TTS if Google TTS fails
 * @param {string} text - Text to speak
 * @param {string} personalityType - Personality for voice selection
 */
function fallbackToBrowserTTS(text, personalityType) {
    if (!window.speechSynthesis) {
        debugLog('‚ùå No TTS available');
        return;
    }

    try {
        // Stop any current speech
        window.speechSynthesis.cancel();

        // Create utterance
        const utterance = new SpeechSynthesisUtterance(cleanTextForTTS(text));

        // Try to select appropriate browser voice
        const voices = window.speechSynthesis.getVoices();
        const australianVoice = voices.find(voice =>
            voice.lang.includes('en-AU') || voice.name.toLowerCase().includes('australia')
        );

        if (australianVoice) {
            utterance.voice = australianVoice;
        }

        // Configure speech parameters
        utterance.rate = 1.0;
        utterance.pitch = 1.0;
        utterance.volume = 1.0;

        // Event handlers
        utterance.onstart = function() {
            isSpeaking = true;
            updateTTSStatus('speaking', 'Speaking (browser voice)...');
        };

        utterance.onend = function() {
            isSpeaking = false;
            updateTTSStatus('idle', 'Voice ready');
        };

        utterance.onerror = function(event) {
            debugLog('‚ùå Browser TTS error:', event.error);
            isSpeaking = false;
            updateTTSStatus('error', 'Speech failed');
        };

        // Start speaking
        window.speechSynthesis.speak(utterance);
        debugLog('üîä Browser TTS speaking');

    } catch (error) {
        debugLog('‚ùå Browser TTS fallback error:', error);
        updateTTSStatus('error', 'All TTS methods failed');
    }
}

// ============================================
// UTILITY FUNCTIONS
// ============================================

/**
 * Convert base64 string to Blob
 * @param {string} base64 - Base64 encoded data
 * @param {string} mimeType - MIME type for the blob
 * @returns {Blob} Blob object
 */
function base64ToBlob(base64, mimeType) {
    const byteCharacters = atob(base64);
    const byteNumbers = new Array(byteCharacters.length);

    for (let i = 0; i < byteCharacters.length; i++) {
        byteNumbers[i] = byteCharacters.charCodeAt(i);
    }

    const byteArray = new Uint8Array(byteNumbers);
    return new Blob([byteArray], { type: mimeType });
}

/**
 * Update TTS status display
 * @param {string} status - Status type: 'speaking', 'idle', 'error', 'info'
 * @param {string} message - Status message
 */
function updateTTSStatus(status, message) {
    // Update status indicator if it exists
    const statusElement = document.getElementById('ttsStatus');
    if (statusElement) {
        statusElement.className = `tts-status ${status}`;
        statusElement.textContent = message;
        statusElement.style.display = 'block';

        // Auto-hide non-critical messages
        if (status === 'idle' || status === 'info') {
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 3000);
        }
    }

    // Console log for debugging
    debugLog(`üé§ TTS Status: ${status} - ${message}`);
}

// ============================================
// INTEGRATION WITH EXISTING CHAT SYSTEM
// ============================================

/**
 * Enhanced addAIMessage function that includes TTS
 * Replace your existing addAIMessage function with this one
 */
function addAIMessageWithTTS(content) {
    // First add the message to chat (existing functionality)
    addAIMessage(content);

    // Then speak it if voice is enabled
    if (voiceEnabled && content.trim()) {
        // Small delay to let the message appear first
        setTimeout(() => {
            speakWithGoogleTTS(content, appState.selectedPersonality);
        }, 500);
    }
}

/**
 * Initialize TTS system
 * Call this in your existing initializeApp() function
 */
function initializeTTS() {
    debugLog('üé§ Initializing TTS system');

    // Check configuration
    if (!CONFIG) {
        debugLog('‚ùå Configuration not loaded');
        return;
    }

    // Log available voices
    debugLog('üé≠ Available DISC voices:', Object.keys(CONFIG.DISC_VOICES));

    // Add voice toggle button to chat interface if it doesn't exist
    addVoiceControls();

    // Test API key if provided
    if (CONFIG.GOOGLE_TTS_API_KEY && CONFIG.GOOGLE_TTS_API_KEY !== 'YOUR_API_KEY_HERE') {
        testGoogleTTSConnection();
    } else {
        debugLog('‚ö†Ô∏è Google TTS API key not configured');
        updateTTSStatus('info', 'Enter API key for premium voices');
    }

    debugLog('‚úÖ TTS system initialized');
}

/**
 * Add voice control buttons to the chat interface
 */
function addVoiceControls() {
    const chatHeader = document.querySelector('.chat-header');
    if (!chatHeader) return;

    // Check if controls already exist
    if (document.getElementById('voiceControls')) return;

    const voiceControls = document.createElement('div');
    voiceControls.id = 'voiceControls';
    voiceControls.innerHTML = `
        <button id="voiceToggle" class="voice-enabled" onclick="toggleVoice()">
            üîä Voice On
        </button>
        <div id="ttsStatus" class="tts-status idle" style="display: none;">
            Voice ready
        </div>
    `;

    // Add some basic styling
    voiceControls.style.cssText = `
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-left: auto;
    `;

    chatHeader.appendChild(voiceControls);
}

/**
 * Test Google TTS API connection
 */
async function testGoogleTTSConnection() {
    try {
        const response = await fetch(`https://texttospeech.googleapis.com/v1/voices?key=${CONFIG.GOOGLE_TTS_API_KEY}`);

        if (response.ok) {
            debugLog('‚úÖ Google TTS API connected successfully');
            updateTTSStatus('success', 'Premium voices ready');
        } else {
            throw new Error(`API test failed: ${response.status}`);
        }
    } catch (error) {
        debugLog('‚ùå Google TTS API test failed:', error);
        updateTTSStatus('error', 'API connection failed - using browser voices');
    }
}

// ============================================
// DEVELOPMENT HELPERS
// ============================================

// Make functions available globally for debugging
window.speakWithGoogleTTS = speakWithGoogleTTS;
window.stopCurrentTTS = stopCurrentTTS;
window.toggleVoice = toggleVoice;
window.testTTS = function(text = 'G\'day! This is a test of the Google Cloud Text-to-Speech integration.') {
    speakWithGoogleTTS(text, appState.selectedPersonality || 'infrastructure_engineer');
};

console.log(`
üé§ Google TTS Integration Loaded!

Development commands:
- testTTS()                    // Test current personality voice
- testTTS('custom text')       // Test with custom text
- toggleVoice()               // Toggle voice on/off
- stopCurrentTTS()            // Stop current speech
- debugConfig()               // View configuration
`);
// ============================================
// STORAGE FUNCTIONS
// ============================================
function saveColleagueToStorage(colleagueData) {
    try {
        const colleagues = getStoredColleagues();
        const colleagueId = `colleague_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

        colleagueData.id = colleagueId;
        colleagueData.saved_at = new Date().toISOString();

        colleagues[colleagueId] = colleagueData;
        localStorage.setItem('conversation_trainer_colleagues', JSON.stringify(colleagues));

        debugLog('‚úÖ Colleague saved to storage', colleagueData);
        updateStorageCounts();
        return colleagueId;
    } catch (error) {
        debugLog('‚ùå Error saving colleague', error);
        throw error;
    }
}

function getStoredColleagues() {
    try {
        const stored = localStorage.getItem('conversation_trainer_colleagues');
        return stored ? JSON.parse(stored) : {};
    } catch (error) {
        debugLog('‚ö†Ô∏è Error reading stored colleagues, returning empty object', error);
        return {};
    }
}

function saveScenarioToStorage(scenarioData) {
    try {
        const scenarios = getStoredScenarios();
        const scenarioId = `scenario_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

        scenarioData.id = scenarioId;
        scenarioData.saved_at = new Date().toISOString();

        scenarios[scenarioId] = scenarioData;
        localStorage.setItem('conversation_trainer_scenarios', JSON.stringify(scenarios));

        debugLog('‚úÖ Scenario saved to storage', scenarioData);
        updateStorageCounts();
        return scenarioId;
    } catch (error) {
        debugLog('‚ùå Error saving scenario', error);
        throw error;
    }
}

function getStoredScenarios() {
    try {
        const stored = localStorage.getItem('conversation_trainer_scenarios');
        return stored ? JSON.parse(stored) : {};
    } catch (error) {
        debugLog('‚ö†Ô∏è Error reading stored scenarios, returning empty object', error);
        return {};
    }
}

function updateStorageCounts() {
    try {
        const colleagues = getStoredColleagues();
        const scenarios = getStoredScenarios();

        const colleagueCount = Object.keys(colleagues).length;
        const scenarioCount = Object.keys(scenarios).length;

        const colleagueCountElement = document.getElementById('colleagueCount');
        const scenarioCountElement = document.getElementById('scenarioCount');

        if (colleagueCountElement) colleagueCountElement.textContent = colleagueCount;
        if (scenarioCountElement) scenarioCountElement.textContent = scenarioCount;

    } catch (error) {
        debugLog('Error updating storage counts', error);
    }
}

// ============================================
// STORAGE MANAGEMENT FUNCTIONS
// ============================================
function showStoredColleagues() {
    const colleagues = getStoredColleagues();
    const count = Object.keys(colleagues).length;

    if (count === 0) {
        showSuccessMessage('No saved colleagues yet. Create some custom characters to build your library!');
        return;
    }

    console.log('üìö Stored Colleagues:', colleagues);
    showSuccessMessage(`You have ${count} saved colleague${count === 1 ? '' : 's'}. Check console for details.`);
}

function showStoredScenarios() {
    const scenarios = getStoredScenarios();
    const count = Object.keys(scenarios).length;

    if (count === 0) {
        showSuccessMessage('No saved scenarios yet. Create some custom scenarios to build your library!');
        return;
    }

    console.log('üìã Stored Scenarios:', scenarios);
    showSuccessMessage(`You have ${count} saved scenario${count === 1 ? '' : 's'}. Check console for details.`);
}

function exportColleagues() {
    try {
        const colleagues = getStoredColleagues();
        const count = Object.keys(colleagues).length;

        if (count === 0) {
            showErrorMessage('No colleagues to export. Create some custom characters first.');
            return;
        }

        const exportData = {
            type: 'conversation_trainer_colleagues',
            version: '1.0',
            exported_at: new Date().toISOString(),
            count: count,
            colleagues: colleagues
        };

        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});

        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `conversation_trainer_colleagues_${new Date().toISOString().split('T')[0]}.json`;
        link.click();

        showSuccessMessage(`Successfully exported ${count} colleague${count === 1 ? '' : 's'}!`);
        debugLog('‚úÖ Colleagues exported', exportData);

    } catch (error) {
        debugLog('‚ùå Error exporting colleagues', error);
        showErrorMessage('Error exporting colleagues. Please try again.');
    }
}

function exportScenarios() {
    try {
        const scenarios = getStoredScenarios();
        const count = Object.keys(scenarios).length;

        if (count === 0) {
            showErrorMessage('No scenarios to export. Create some custom scenarios first.');
            return;
        }

        const exportData = {
            type: 'conversation_trainer_scenarios',
            version: '1.0',
            exported_at: new Date().toISOString(),
            count: count,
            scenarios: scenarios
        };

        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});

        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `conversation_trainer_scenarios_${new Date().toISOString().split('T')[0]}.json`;
        link.click();

        showSuccessMessage(`Successfully exported ${count} scenario${count === 1 ? '' : 's'}!`);
        debugLog('‚úÖ Scenarios exported', exportData);

    } catch (error) {
        debugLog('‚ùå Error exporting scenarios', error);
        showErrorMessage('Error exporting scenarios. Please try again.');
    }
}

function testStorage() {
    console.log('üìö Stored Colleagues:', getStoredColleagues());
    console.log('üìã Stored Scenarios:', getStoredScenarios());
    console.log('üìä Storage Status:', {
        colleagues: Object.keys(getStoredColleagues()).length,
        scenarios: Object.keys(getStoredScenarios()).length
    });
}

// ============================================
// SCREEN SWITCHING
// ============================================
function switchToChat() {
    debugLog('üé¨ SWITCHING TO CHAT SCREEN FROM TABS');

    try {
        // Hide all tab content
        document.querySelectorAll('.tab-content').forEach(content => {
            content.style.display = 'none';
        });

        // Hide tab navigation
        const tabNavigation = document.querySelector('.tab-navigation');
        if (tabNavigation) {
            tabNavigation.style.display = 'none';
        }

        // Show chat screen
        const chatScreen = document.getElementById('chatScreen');
        if (chatScreen) {
            chatScreen.style.display = 'flex';
            chatScreen.classList.add('active');
        }

        debugLog('üéØ Chat screen activated, tabs hidden');
        return true;

    } catch (error) {
        debugLog('‚ùå Error switching to chat screen:', error);
        return false;
    }
}

function switchToSetup() {
    debugLog('üè† Switching back to setup screen');

    const setupScreen = document.getElementById('setupScreen');
    const chatScreen = document.getElementById('chatScreen');

    if (chatScreen) {
        chatScreen.style.display = 'none';
        chatScreen.classList.remove('active');
    }

    if (setupScreen) {
        setupScreen.style.display = 'block';
        setupScreen.classList.remove('hidden');
    }
}

// ============================================
// CUSTOM CHARACTER FUNCTIONS
// ============================================
function showCustomCharacterModal() {
    debugLog('üìù Opening custom character modal');

    const modal = document.getElementById('customCharacterModal');
    if (!modal) {
        debugLog('‚ùå Custom character modal not found in DOM');
        showErrorMessage('Custom character modal not found. Please refresh the page.');
        return;
    }

    clearCustomCharacterForm();
    modal.style.display = 'block';

    setTimeout(() => {
        const nameInput = document.getElementById('customName');
        if (nameInput) nameInput.focus();
    }, 100);

    debugLog('‚úÖ Custom character modal opened');
}

function cancelCustomCharacter() {
    debugLog('‚ùå Cancelling custom character creation');

    const modal = document.getElementById('customCharacterModal');
    if (modal) {
        modal.style.display = 'none';
    }

    clearCustomCharacterForm();

    if (appState.selectedPersonality === 'custom_character') {
        const customOption = document.getElementById('customCharacterOption');
        if (customOption) {
            customOption.classList.remove('selected');
            resetCustomCharacterCard();
        }
        appState.selectedPersonality = null;
        customCharacterData = null;
        updateStartButton();
    }

    debugLog('‚úÖ Custom character creation cancelled');
}

function saveCustomCharacter() {
    debugLog('üíæ Attempting to save custom character');

    try {
        const nameInput = document.getElementById('customName');
        const roleInput = document.getElementById('customRole');
        const personalityInput = document.getElementById('customPersonality');
        const motivationsInput = document.getElementById('customMotivations');

        if (!nameInput || !roleInput || !personalityInput || !motivationsInput) {
            throw new Error('Form elements not found. Please refresh the page.');
        }

        const name = nameInput.value?.trim() || '';
        const role = roleInput.value?.trim() || '';
        const personality = personalityInput.value?.trim() || '';
        const motivations = motivationsInput.value?.trim() || '';

        debugLog('üìù Form data collected', { name, role, personality, motivations });

        if (!name) {
            showErrorMessage('Please provide a name for the colleague.');
            nameInput.focus();
            return false;
        }

        if (!role) {
            showErrorMessage('Please provide a job title/role for the colleague.');
            roleInput.focus();
            return false;
        }

        if (!personality) {
            showErrorMessage('Please describe how this person behaves in meetings.');
            personalityInput.focus();
            return false;
        }

        const characterData = {
            name: name,
            role: role,
            personality: personality,
            motivations: motivations || 'Professional success and recognition',
            type: 'custom',
            created: new Date().toISOString()
        };

        debugLog('‚úÖ Character data created', characterData);

        const colleagueId = saveColleagueToStorage(characterData);
        characterData.id = colleagueId;

        customCharacterData = characterData;
        updateCustomCharacterCard(characterData);

        appState.selectedPersonality = 'custom_character';
        debugLog('üéØ App state updated', appState);

        const modal = document.getElementById('customCharacterModal');
        if (modal) {
            modal.style.display = 'none';
        }

        updateStartButton();

        debugLog('üéâ Custom character created successfully:', name);
        showSuccessMessage(`Custom colleague "${name}" created and saved! You can now start a practice session.`);

        return true;

    } catch (error) {
        debugLog('üí• Error creating custom character:', error);
        showErrorMessage(`Error creating custom character: ${error.message}`);
        return false;
    }
}

function updateCustomCharacterCard(characterData) {
    debugLog('üé® Updating custom character card UI');

    const customOption = document.getElementById('customCharacterOption');
    if (!customOption) {
        debugLog('‚ùå Custom character card not found');
        return;
    }

    document.querySelectorAll('.personality-card').forEach(card => {
        if (card !== customOption) {
            card.classList.remove('selected');
        }
    });

    customOption.classList.add('selected');

    const nameElement = customOption.querySelector('.personality-name');
    const roleElement = customOption.querySelector('.personality-role');
    const descElement = customOption.querySelector('.personality-description');

    if (nameElement) {
        nameElement.textContent = characterData.name;
    }
    if (roleElement) {
        roleElement.textContent = characterData.role;
    }
    if (descElement) {
        const description = characterData.personality.length > 80
            ? characterData.personality.substring(0, 80) + '...'
            : characterData.personality;
        descElement.textContent = `Custom colleague: ${description}`;
    }

    debugLog('‚úÖ Custom character card updated');
}

function resetCustomCharacterCard() {
    debugLog('üîÑ Resetting custom character card to default');

    const customOption = document.getElementById('customCharacterOption');
    if (!customOption) return;

    const nameElement = customOption.querySelector('.personality-name');
    const roleElement = customOption.querySelector('.personality-role');
    const descElement = customOption.querySelector('.personality-description');

    if (nameElement) nameElement.textContent = 'Create Custom';
    if (roleElement) roleElement.textContent = 'Build Your Own';
    if (descElement) descElement.textContent = 'Design a virtual version of someone from your workplace with custom DISC profile and behaviors.';
}

function clearCustomCharacterForm() {
    debugLog('üßπ Clearing custom character form');

    const fields = ['customName', 'customRole', 'customPersonality', 'customMotivations'];
    fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.value = '';
        }
    });
}

// ============================================
// CUSTOM SCENARIO FUNCTIONS
// ============================================
function showCustomScenarioModal() {
    debugLog('üìã Opening custom scenario modal');

    const modal = document.getElementById('customScenarioModal');
    if (!modal) {
        debugLog('‚ùå Custom scenario modal not found in DOM');
        showErrorMessage('Custom scenario modal not found. Please refresh the page.');
        return;
    }

    clearCustomScenarioForm();
    modal.style.display = 'block';

    setTimeout(() => {
        const titleInput = document.getElementById('customScenarioTitle');
        if (titleInput) titleInput.focus();
    }, 100);

    debugLog('‚úÖ Custom scenario modal opened');
}

function cancelCustomScenario() {
    debugLog('‚ùå Cancelling custom scenario creation');

    const modal = document.getElementById('customScenarioModal');
    if (modal) {
        modal.style.display = 'none';
    }

    clearCustomScenarioForm();

    if (appState.selectedScenario === 'custom_scenario') {
        const customOption = document.getElementById('customScenarioOption');
        if (customOption) {
            customOption.classList.remove('selected');
            resetCustomScenarioCard();
        }
        appState.selectedScenario = null;
        customScenarioData = null;
        updateStartButton();
    }

    debugLog('‚úÖ Custom scenario creation cancelled');
}

function saveCustomScenario() {
    debugLog('üíæ Attempting to save custom scenario');

    try {
        const titleInput = document.getElementById('customScenarioTitle');
        const contextInput = document.getElementById('customScenarioContext');
        const objectiveInput = document.getElementById('customScenarioObjective');
        const challengesInput = document.getElementById('customScenarioChallenges');
        const typeInput = document.getElementById('customScenarioType');

        if (!titleInput || !contextInput || !objectiveInput || !challengesInput || !typeInput) {
            throw new Error('Form elements not found. Please refresh the page.');
        }

        const title = titleInput.value?.trim() || '';
        const context = contextInput.value?.trim() || '';
        const objective = objectiveInput.value?.trim() || '';
        const challenges = challengesInput.value?.trim() || '';
        const type = typeInput.value || 'budget_review';

        debugLog('üìù Scenario form data collected', { title, context, objective, challenges, type });

        if (!title) {
            showErrorMessage('Please provide a title for the scenario.');
            titleInput.focus();
            return false;
        }

        if (!context) {
            showErrorMessage('Please describe the meeting context and background.');
            contextInput.focus();
            return false;
        }

        if (!objective) {
            showErrorMessage('Please describe your role and objective in this meeting.');
            objectiveInput.focus();
            return false;
        }

        const scenarioData = {
            title: title,
            context: context,
            objective: objective,
            challenges: challenges || 'Standard workplace challenges',
            type: type,
            created: new Date().toISOString()
        };

        debugLog('‚úÖ Scenario data created', scenarioData);

        const scenarioId = saveScenarioToStorage(scenarioData);
        scenarioData.id = scenarioId;

        customScenarioData = scenarioData;
        updateCustomScenarioCard(scenarioData);

        appState.selectedScenario = 'custom_scenario';
        debugLog('üéØ App state updated', appState);

        const modal = document.getElementById('customScenarioModal');
        if (modal) {
            modal.style.display = 'none';
        }

        updateStartButton();

        debugLog('üéâ Custom scenario created successfully:', title);
        showSuccessMessage(`Custom scenario "${title}" created and saved! You can now start a practice session.`);

        return true;

    } catch (error) {
        debugLog('üí• Error creating custom scenario:', error);
        showErrorMessage(`Error creating custom scenario: ${error.message}`);
        return false;
    }
}

function updateCustomScenarioCard(scenarioData) {
    debugLog('üé® Updating custom scenario card UI');

    const customOption = document.getElementById('customScenarioOption');
    if (!customOption) {
        debugLog('‚ùå Custom scenario card not found');
        return;
    }

    document.querySelectorAll('[data-scenario]').forEach(card => {
        if (card !== customOption) {
            card.classList.remove('selected');
        }
    });

    customOption.classList.add('selected');

    const titleElement = customOption.querySelector('.option-title');
    const descElement = customOption.querySelector('.option-description');

    if (titleElement) {
        titleElement.textContent = scenarioData.title;
    }
    if (descElement) {
        const description = scenarioData.context.length > 100
            ? scenarioData.context.substring(0, 100) + '...'
            : scenarioData.context;
        descElement.textContent = `Custom scenario: ${description}`;
    }

    debugLog('‚úÖ Custom scenario card updated');
}

function resetCustomScenarioCard() {
    debugLog('üîÑ Resetting custom scenario card to default');

    const customOption = document.getElementById('customScenarioOption');
    if (!customOption) return;

    const titleElement = customOption.querySelector('.option-title');
    const descElement = customOption.querySelector('.option-description');

    if (titleElement) titleElement.textContent = 'üéØ Create Custom Scenario';
    if (descElement) descElement.textContent = 'Design your specific meeting situation. Perfect for practicing upcoming real conversations.';
}

function clearCustomScenarioForm() {
    debugLog('üßπ Clearing custom scenario form');

    const fields = ['customScenarioTitle', 'customScenarioContext', 'customScenarioObjective', 'customScenarioChallenges'];
    fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.value = '';
        }
    });

    const typeField = document.getElementById('customScenarioType');
    if (typeField) {
        typeField.value = 'budget_review';
    }
}

// ============================================
// SELECTION HANDLING
// ============================================
function handleSelection(event) {
    debugLog('Selection handler called');
    const card = event.currentTarget;
    const parent = card.parentElement;

    parent.querySelectorAll('.option-card, .personality-card').forEach(c => c.classList.remove('selected'));
    card.classList.add('selected');

    if (card.dataset.role) {
        appState.selectedRole = card.dataset.role;
        debugLog('Selected role', appState.selectedRole);
    } else if (card.dataset.scenario) {
        appState.selectedScenario = card.dataset.scenario;
        debugLog('Selected scenario', appState.selectedScenario);
    } else if (card.dataset.personality) {
        appState.selectedPersonality = card.dataset.personality;
        debugLog('Selected personality', appState.selectedPersonality);
    }

    updateStartButton();
}

// ============================================
// REQUEST DATA BUILDING
// ============================================
function buildCustomScenarioDescription(scenarioData) {
    return `${scenarioData.title}

CONTEXT: ${scenarioData.context}

YOUR OBJECTIVE: ${scenarioData.objective}

EXPECTED CHALLENGES: ${scenarioData.challenges}

MEETING TYPE: ${scenarioData.type}`;
}

function getScenarioDescription(scenarioKey) {
    const scenarios = {
        'budget_cuts': 'You need to discuss budget reductions with your team while maintaining morale and finding creative solutions.',
        'angry_resident': 'Handle a frustrated ratepayer who is upset about service levels and rate increases.'
    };
    return scenarios[scenarioKey] || 'Practice conversation scenario';
}

function getRequestData() {
    debugLog('Building request data');
    const baseData = {
        user_name: `${appState.selectedRole}_user`,
        personality_type: appState.selectedPersonality
    };

    debugLog('üîç REQUEST DATA DEBUG:', {
        selectedRole: appState.selectedRole,
        selectedScenario: appState.selectedScenario,
        selectedPersonality: appState.selectedPersonality,
        hasCustomCharacter: !!customCharacterData,
        hasCustomScenario: !!customScenarioData
    });

    // Handle saved colleagues (NEW)
    if (appState.selectedPersonality && appState.selectedPersonality.startsWith('saved_colleague_')) {
        baseData.custom_character = customCharacterData;
        debugLog('Added saved colleague data:', customCharacterData.name);
    } else if (appState.selectedPersonality === 'custom_character' && customCharacterData) {
        baseData.custom_character = customCharacterData;
        debugLog('Added custom character data');
    }

    // Handle saved scenarios (NEW)
    if (appState.selectedScenario && appState.selectedScenario.startsWith('saved_scenario_')) {
        baseData.custom_scenario = customScenarioData;
        baseData.scenario = buildCustomScenarioDescription(customScenarioData);
        debugLog('Added saved scenario data:', customScenarioData.title);
    } else if (appState.selectedScenario === 'custom_scenario' && customScenarioData) {
        baseData.custom_scenario = customScenarioData;
        baseData.scenario = buildCustomScenarioDescription(customScenarioData);
        debugLog('Added custom scenario data');
    } else {
        baseData.scenario = getScenarioDescription(appState.selectedScenario);
        debugLog('Added standard scenario');
    }

    debugLog('üöÄ FINAL REQUEST DATA:', baseData);
    return baseData;
}

// ============================================
// START BUTTON MANAGEMENT
// ============================================
function updateStartButton() {
    // Try to find either button
    let startBtn = document.getElementById('quickStartButton');
    if (!startBtn) {
        startBtn = document.getElementById('startConversation');
    }

    if (!startBtn) {
        debugLog('‚ö†Ô∏è No start button found');
        return;
    }

    const isReady = appState.selectedRole && appState.selectedScenario && appState.selectedPersonality;

    startBtn.disabled = !isReady || !appState.isConnected;

    if (!appState.isConnected) {
        startBtn.innerHTML = '<span>‚ö†Ô∏è</span><span>Connecting to Service...</span>';
    } else if (!isReady) {
        startBtn.innerHTML = '<span>üöÄ</span><span>Begin Practice Session</span>';
    } else {
        startBtn.innerHTML = '<span>üöÄ</span><span>Begin Practice Session</span>';
    }

    debugLog('Start button updated', { ready: isReady, connected: appState.isConnected, buttonFound: !!startBtn });
}

// ============================================
// API CONNECTION
// ============================================
async function testAPIConnection() {
    try {
        debugLog('Testing API connection');
        const response = await fetch(`${API_BASE_URL}/health`);
        const data = await response.json();

        if (response.ok) {
            appState.isConnected = true;
            showSuccessMessage('‚úÖ Connected to conversation service successfully');
            debugLog('API connection successful', data);
        } else {
            throw new Error('API health check failed');
        }
    } catch (error) {
        debugLog('API Connection Error', error);
        appState.isConnected = false;
        showConnectionError();
        showErrorMessage('‚ö†Ô∏è Cannot connect to conversation service. Please check your internet connection.');
    } finally {
        updateStartButton();
    }
}

function showConnectionError() {
    const statusIndicator = document.querySelector('.status-indicator');
    statusIndicator.innerHTML = '<div style="width: 8px; height: 8px; background: #dc2626; border-radius: 50%;"></div><span>Service Offline</span>';
    statusIndicator.style.background = '#fef2f2';
    statusIndicator.style.borderColor = '#fecaca';
    statusIndicator.style.color = '#dc2626';
}

// ============================================
// CONVERSATION MANAGEMENT
// ============================================
async function startConversation() {
    debugLog('üöÄ START CONVERSATION CALLED');
    debugLog('üéØ Current app state:', appState);

    try {
        // Find the correct start button (could be either ID)
        let startBtn = document.getElementById('quickStartButton');
        if (!startBtn) {
            startBtn = document.getElementById('startConversation');
        }

        if (startBtn) {
            startBtn.disabled = true;
            startBtn.innerHTML = '<span>‚è≥</span><span>Starting Session...</span>';
        }

        const requestData = getRequestData();
        debugLog('üì§ Sending request to backend:', requestData);

        const response = await fetch(`${API_BASE_URL}/api/conversations/start`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });

        debugLog('üì• Backend response status:', response.status);

        if (!response.ok) {
            const errorText = await response.text();
            debugLog('‚ùå Backend error response:', errorText);
            throw new Error(`Backend error (${response.status}): ${errorText}`);
        }

        const data = await response.json();
        debugLog('‚úÖ Backend success response:', data);

        if (data.success) {
            appState.currentConversation = data;
            appState.conversationHistory = [{
                sender: data.personality_name,
                content: data.opening_message,
                timestamp: data.timestamp || new Date().toISOString(),
                sender_type: 'ai_personality'
            }];

            const switchSuccess = switchToChat();
            if (!switchSuccess) {
                throw new Error('Failed to switch to chat screen');
            }

            const messagesArea = document.getElementById('messagesArea');
            if (messagesArea) {
                messagesArea.innerHTML = '';
            }

            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');

            if (messageInput) messageInput.disabled = false;
            if (sendButton) sendButton.disabled = false;

            updateChatHeader();
            addSystemMessage('Practice session started. Your conversation partner is ready.');
            addAIMessageWithTTS(data.opening_message);

            debugLog('üéâ Conversation started successfully');

        } else {
            throw new Error(data.error || 'Backend reported failure');
        }
    } catch (error) {
        debugLog('üí• CONVERSATION START ERROR:', error);
        showErrorMessage(`Failed to start conversation: ${error.message}`);

        // Reset button safely
        let startBtn = document.getElementById('quickStartButton');
        if (!startBtn) {
            startBtn = document.getElementById('startConversation');
        }

        if (startBtn) {
            startBtn.disabled = false;
            startBtn.innerHTML = '<span>üöÄ</span><span>Begin Practice Session</span>';
        }
    }
}

async function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();

    if (!message || !appState.currentConversation) return;

    try {
        debugLog('Sending message', message);

        addUserMessage(message);
        input.value = '';

        input.disabled = true;
        document.getElementById('sendButton').disabled = true;

        const requestData = {
            conversation_id: appState.currentConversation.conversation_id,
            user_message: message,
            personality_data: appState.currentConversation.conversation_data.personality,
            conversation_history: appState.conversationHistory
        };

        debugLog('Sending message request', requestData);

        const response = await fetch(`${API_BASE_URL}/api/conversations/message`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });

        const data = await response.json();
        debugLog('Message response', data);

        if (data.success) {
            addAIMessageWithTTS(data.ai_response);

            appState.conversationHistory.push({
                sender: 'user',
                content: message,
                timestamp: new Date().toISOString(),
                sender_type: 'user'
            });

            appState.conversationHistory.push({
                sender: appState.currentConversation.personality_name,
                content: data.ai_response,
                timestamp: data.timestamp,
                sender_type: 'ai_personality'
            });

            debugLog('Message exchange completed');
        } else {
            throw new Error(data.error || 'Failed to get AI response');
        }
    } catch (error) {
        debugLog('Error sending message', error);
        addSystemMessage('Sorry, there was an error processing your message. Please try again.');
        showErrorMessage('Error sending message. Please try again.');
    } finally {
        input.disabled = false;
        document.getElementById('sendButton').disabled = false;
        input.focus();
    }
}

function endConversation() {
    if (confirm('Are you sure you want to end this practice session?')) {
        debugLog('üèÅ Ending conversation and returning to tabs');

        // Hide chat screen
        const chatScreen = document.getElementById('chatScreen');
        if (chatScreen) {
            chatScreen.style.display = 'none';
            chatScreen.classList.remove('active');
        }

        // Show tab navigation
        const tabNavigation = document.querySelector('.tab-navigation');
        if (tabNavigation) {
            tabNavigation.style.display = 'block';
        }

        // Show tab content
        document.querySelectorAll('.tab-content').forEach(content => {
            content.style.display = 'block';
        });

        // Return to Quick Start tab
        switchToTab('quick-start');

        // Clear messages and reset state
        document.getElementById('messagesArea').innerHTML = '';

        // Clear Quick Start selections
        document.querySelectorAll('#quick-start-tab .option-card, #quick-start-tab .personality-card').forEach(card => {
            card.classList.remove('selected');
        });

        // Reset state
        appState.selectedRole = null;
        appState.selectedScenario = null;
        appState.selectedPersonality = null;
        appState.currentConversation = null;
        appState.conversationHistory = [];

        const messageInput = document.getElementById('messageInput');
        messageInput.value = '';
        messageInput.disabled = true;
        document.getElementById('sendButton').disabled = true;

        updateQuickStartButton();
        debugLog('‚úÖ Returned to Quick Start tab');
    }
}

// ============================================
// CHAT UI FUNCTIONS
// ============================================
function updateChatHeader() {
    const personalities = {
        'infrastructure_engineer': {
            name: 'Terry Mitchell',
            avatar: 'TM',
            description: 'Senior Infrastructure Engineer ‚Ä¢ Technical expert, detail-oriented'
        },
        'community_engagement': {
            name: 'Sarah Chen',
            avatar: 'SC',
            description: 'Community Engagement Officer ‚Ä¢ People-focused, diplomatic'
        },
        'budget_director': {
            name: 'David Walsh',
            avatar: 'DW',
            description: 'Budget & Finance Director ‚Ä¢ Numbers-driven, direct about constraints'
        },
        'union_rep': {
            name: 'Maria Santos',
            avatar: 'MS',
            description: 'Union Representative ‚Ä¢ Assertive advocate for workers\' rights'
        },
        'councillor_thompson': {
            name: 'Robert Thompson',
            avatar: 'RT',
            description: 'Long-term Councillor ‚Ä¢ Steady, consensus-building approach'
        },
        'strategic_planner': {
            name: 'Emily Kim',
            avatar: 'EK',
            description: 'Strategic Planner ‚Ä¢ Analytical yet enthusiastic about new ideas'
        },
        'custom_character': {
            name: customCharacterData ? customCharacterData.name : 'Custom Character',
            avatar: customCharacterData ? customCharacterData.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2) : 'CC',
            description: customCharacterData ? `Custom colleague ‚Ä¢ ${customCharacterData.role || 'Custom character'}` : 'Custom character'
        }
    };

    // NEW: Handle saved colleagues
    let personality;
    if (appState.selectedPersonality && appState.selectedPersonality.startsWith('saved_colleague_') && customCharacterData) {
        personality = {
            name: customCharacterData.name,
            avatar: customCharacterData.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2),
            description: `Saved colleague ‚Ä¢ ${customCharacterData.role || 'Custom character'}`
        };
        console.log('Using saved colleague for chat header:', personality);
    } else {
        personality = personalities[appState.selectedPersonality];
        console.log('Using built-in personality for chat header:', personality);
    }

    if (personality) {
        document.getElementById('participantAvatar').textContent = personality.avatar;
        document.getElementById('participantName').textContent = personality.name;
        document.getElementById('scenarioDescription').textContent = personality.description;
        debugLog('Chat header updated', { selectedPersonality: appState.selectedPersonality, personality });
    } else {
        debugLog('‚ö†Ô∏è Unknown personality type', appState.selectedPersonality);
        document.getElementById('participantAvatar').textContent = 'AI';
        document.getElementById('participantName').textContent = 'Practice Partner';
        document.getElementById('scenarioDescription').textContent = 'Conversation practice session';
    }
}

function addSystemMessage(content) {
    const messagesArea = document.getElementById('messagesArea');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'system-message';
    messageDiv.textContent = content;
    messagesArea.appendChild(messageDiv);
    scrollToBottom();
}

function addUserMessage(content) {
    addMessage('user', content, 'You');
}

function addAIMessage(content) {
    const personalities = {
        'infrastructure_engineer': 'TM',
        'community_engagement': 'SC',
        'budget_director': 'DW',
        'union_rep': 'MS',
        'councillor_thompson': 'RT',
        'strategic_planner': 'EK',
        'custom_character': customCharacterData ? customCharacterData.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2) : 'CC'
    };

    // NEW: Handle saved colleagues
    let avatar;
    if (appState.selectedPersonality && appState.selectedPersonality.startsWith('saved_colleague_') && customCharacterData) {
        avatar = customCharacterData.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
        console.log('Using saved colleague avatar for AI message:', avatar, 'from:', customCharacterData.name);
    } else {
        avatar = personalities[appState.selectedPersonality] || 'AI';
        console.log('Using built-in avatar for AI message:', avatar);
    }

    debugLog('Adding AI message', { personality: appState.selectedPersonality, avatar, content: content.substring(0, 50) + '...' });
    addMessage('ai', content, avatar);
}

function addMessage(type, content, avatar) {
    const messagesArea = document.getElementById('messagesArea');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}`;

    const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

    messageDiv.innerHTML = [
        '<div class="message-avatar">' + avatar + '</div>',
        '<div class="message-content">',
            '<div class="message-text">' + content + '</div>',
            '<div class="message-time">' + timestamp + '</div>',
        '</div>'
    ].join('');

    messagesArea.appendChild(messageDiv);
    scrollToBottom();
}

function scrollToBottom() {
    const messagesArea = document.getElementById('messagesArea');
    messagesArea.scrollTop = messagesArea.scrollHeight;
}

function handleInputKeydown(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
    }
}

// ============================================
// EVENT LISTENERS SETUP
// ============================================
// Update setupEventListeners to include Quick Start handlers
function setupEventListeners() {
    debugLog('üîß Setting up all event listeners including tab system');

    // Quick Start role and scenario selection
    document.querySelectorAll('#quick-start-tab .option-card').forEach(card => {
        card.addEventListener('click', handleQuickStartSelection);
    });

    // UPDATED: Connect both start buttons
    const quickStartBtn = document.getElementById('quickStartButton');
    const originalStartBtn = document.getElementById('startConversation');

    if (quickStartBtn) {
        quickStartBtn.addEventListener('click', startConversation);
    }
    if (originalStartBtn) {
        originalStartBtn.addEventListener('click', startConversation);
    }

    // Rest of existing event listeners...
    document.getElementById('endConversation').addEventListener('click', endConversation);
    document.getElementById('sendButton').addEventListener('click', sendMessage);

    const messageInput = document.getElementById('messageInput');
    if (messageInput) {
        messageInput.addEventListener('keydown', handleInputKeydown);
    }

    setupCustomCharacterListeners();
    setupCustomScenarioListeners();

    debugLog('‚úÖ All event listeners set up including Quick Start integration');
}
function handleQuickStartSelection(event) {
    debugLog('üöÄ Quick Start selection handler called');
    const card = event.currentTarget;
    const parent = card.parentElement;

    // Clear selections within this panel only
    parent.querySelectorAll('.option-card, .personality-card').forEach(c => c.classList.remove('selected'));
    card.classList.add('selected');

    if (card.dataset.role) {
        appState.selectedRole = card.dataset.role;
        debugLog('‚úÖ Selected role in Quick Start:', appState.selectedRole);
    } else if (card.dataset.scenario) {
        appState.selectedScenario = card.dataset.scenario;
        debugLog('‚úÖ Selected scenario in Quick Start:', appState.selectedScenario);
    } else if (card.dataset.personality) {
        appState.selectedPersonality = card.dataset.personality;
        debugLog('‚úÖ Selected personality in Quick Start:', appState.selectedPersonality);
    }

    updateQuickStartButton();
}
function setupCustomCharacterListeners() {
    debugLog('üîß Setting up custom character event listeners');

    const customCharacterOption = document.getElementById('customCharacterOption');
    if (customCharacterOption) {
        customCharacterOption.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            debugLog('üé≠ Custom character option clicked');
            showCustomCharacterModal();
        });
        debugLog('‚úÖ Custom character option listener attached');
    }

    // Modal buttons
    const cancelBtn = document.getElementById('cancelCustomCharacter');
    const saveBtn = document.getElementById('saveCustomCharacter');

    if (cancelBtn) {
        cancelBtn.addEventListener('click', function(e) {
            e.preventDefault();
            cancelCustomCharacter();
        });
        debugLog('‚úÖ Cancel button listener attached');
    }

    if (saveBtn) {
        saveBtn.addEventListener('click', function(e) {
            e.preventDefault();
            saveCustomCharacter();
        });
        debugLog('‚úÖ Save button listener attached');
    }

    // Modal overlay click to close
    const modal = document.getElementById('customCharacterModal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                cancelCustomCharacter();
            }
        });
        debugLog('‚úÖ Modal overlay listener attached');
    }

    // Form keyboard shortcuts
    const form = document.getElementById('characterCreationForm');
    if (form) {
        form.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.ctrlKey) {
                e.preventDefault();
                saveCustomCharacter();
            }
            if (e.key === 'Escape') {
                e.preventDefault();
                cancelCustomCharacter();
            }
        });
        debugLog('‚úÖ Form keyboard handlers attached');
    }
}

function setupCustomScenarioListeners() {
    debugLog('üîß Setting up custom scenario event listeners');

    const customScenarioOption = document.getElementById('customScenarioOption');
    if (customScenarioOption) {
        customScenarioOption.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            debugLog('üìã Custom scenario option clicked');
            showCustomScenarioModal();
        });
        debugLog('‚úÖ Custom scenario option listener attached');
    }

    // Modal buttons
    const cancelBtn = document.getElementById('cancelCustomScenario');
    const saveBtn = document.getElementById('saveCustomScenario');

    if (cancelBtn) {
        cancelBtn.addEventListener('click', function(e) {
            e.preventDefault();
            cancelCustomScenario();
        });
        debugLog('‚úÖ Scenario cancel button listener attached');
    }

    if (saveBtn) {
        saveBtn.addEventListener('click', function(e) {
            e.preventDefault();
            saveCustomScenario();
        });
        debugLog('‚úÖ Scenario save button listener attached');
    }

    // Modal overlay
    const modal = document.getElementById('customScenarioModal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                cancelCustomScenario();
            }
        });
        debugLog('‚úÖ Scenario modal overlay listener attached');
    }
}
// ============================================
// DYNAMIC CONTENT LOADING (PHASE 1)
// ============================================
function loadSavedColleagues() {
    debugLog('üìö Loading saved colleagues into personality grid');

    try {
        const savedColleagues = getStoredColleagues();
        const colleagueCount = Object.keys(savedColleagues).length;

        console.log(`Phase 1: Found ${colleagueCount} saved colleagues in storage`);

        if (colleagueCount === 0) {
            console.log('No saved colleagues found - create some to test!');
            return;
        }

        const personalityGrid = document.querySelector('.personality-grid');
        if (!personalityGrid) {
            console.error('‚ùå Personality grid not found');
            return;
        }

        // Add saved colleagues to the grid
        Object.values(savedColleagues).forEach(colleague => {
            console.log('Creating card for:', colleague.name);
            const colleagueCard = createSavedColleagueCard(colleague);
            personalityGrid.insertBefore(colleagueCard, personalityGrid.lastElementChild);
        });

        console.log(`‚úÖ Added ${colleagueCount} saved colleague cards to personality grid`);

    } catch (error) {
        console.error('‚ùå Error loading saved colleagues:', error);
    }
}
function createSavedColleagueCard(colleague) {
    debugLog('üé® Creating card for saved colleague:', colleague.name);

    const cardDiv = document.createElement('div');
    cardDiv.className = 'personality-card saved-colleague';
    cardDiv.dataset.personality = `saved_colleague_${colleague.id}`;

    // Create avatar initials
    const initials = colleague.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);

    cardDiv.innerHTML = `
        <div class="personality-header">
            <div class="personality-avatar saved-avatar">${initials}</div>
            <div class="personality-info">
                <div class="personality-name">${colleague.name}</div>
                <div class="personality-role">${colleague.role}</div>
            </div>
            <div class="saved-badge">üíæ Saved</div>
        </div>
        <div class="saved-personality-preview">
            <p class="saved-description">${colleague.personality.length > 80 ? colleague.personality.substring(0, 80) + '...' : colleague.personality}</p>
        </div>
        <div class="personality-description">
            <strong>Custom colleague:</strong> ${colleague.motivations || 'Professional development focused'}
        </div>
    `;

    // Add click handler for saved colleague
    cardDiv.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();

        // Clear other selections
        document.querySelectorAll('.personality-card').forEach(card => {
            card.classList.remove('selected');
        });

        // Select this card
        cardDiv.classList.add('selected');

        // Set app state
        appState.selectedPersonality = `saved_colleague_${colleague.id}`;

        // Store the colleague data for use in conversation
        customCharacterData = colleague;

        debugLog('‚úÖ Selected saved colleague:', colleague.name);
        updateStartButton();
    });

    return cardDiv;
}
function loadSavedScenarios() {
    debugLog('üìã Loading saved scenarios into scenario grid');

    try {
        const savedScenarios = getStoredScenarios();
        const scenarioCount = Object.keys(savedScenarios).length;

        console.log(`Phase 1: Found ${scenarioCount} saved scenarios in storage`);

        if (scenarioCount === 0) {
            console.log('No saved scenarios found - create some to test!');
            return;
        }

        const scenarioGrid = document.querySelector('[data-scenario="budget_cuts"]').parentElement;
        if (!scenarioGrid) {
            console.error('‚ùå Scenario grid not found');
            return;
        }

        // Add saved scenarios to the grid
        Object.values(savedScenarios).forEach(scenario => {
            console.log('Creating card for scenario:', scenario.title);
            const scenarioCard = createSavedScenarioCard(scenario);
            scenarioGrid.insertBefore(scenarioCard, scenarioGrid.lastElementChild);
        });

        console.log(`‚úÖ Added ${scenarioCount} saved scenario cards to scenario grid`);

    } catch (error) {
        console.error('‚ùå Error loading saved scenarios:', error);
    }
}

function createSavedScenarioCard(scenario) {
    debugLog('üé® Creating card for saved scenario:', scenario.title);

    const cardDiv = document.createElement('div');
    cardDiv.className = 'option-card saved-scenario';
    cardDiv.dataset.scenario = `saved_scenario_${scenario.id}`;

    cardDiv.innerHTML = `
        <div class="option-title">
            <span class="saved-badge-small">üíæ</span> ${scenario.title}
        </div>
        <div class="option-description">
            <strong>Type:</strong> ${scenario.type.replace('_', ' ')} ‚Ä¢ ${scenario.context.length > 80 ? scenario.context.substring(0, 80) + '...' : scenario.context}
        </div>
    `;

    // Add click handler for saved scenario
    cardDiv.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();

        // Clear other selections
        document.querySelectorAll('[data-scenario]').forEach(card => {
            card.classList.remove('selected');
        });

        // Select this card
        cardDiv.classList.add('selected');

        // Set app state
        appState.selectedScenario = `saved_scenario_${scenario.id}`;

        // Store the scenario data for use in conversation
        customScenarioData = scenario;

        debugLog('‚úÖ Selected saved scenario:', scenario.title);
        updateStartButton();
    });

    return cardDiv;
}
// ============================================
        // TAB SYSTEM FUNCTIONALITY (PHASE 2)
        // ============================================

        function initializeTabs() {
            debugLog('üóÇÔ∏è Initializing tab system');

            // Add click handlers to tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    const targetTab = this.dataset.tab;
                    switchToTab(targetTab);
                });
            });

            // Load built-in personalities into Quick Start
            loadQuickStartPersonalities();

            // Update tab counts
            updateTabCounts();

            debugLog('‚úÖ Tab system initialized');
        }

        function switchToTab(tabId) {
            debugLog(`üóÇÔ∏è Switching to tab: ${tabId}`);

            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabId}-tab`).classList.add('active');

            // Load tab-specific content
            switch(tabId) {
                case 'my-colleagues':
                    loadColleaguesTab();
                    break;
                case 'my-scenarios':
                    loadScenariosTab();
                    break;
                case 'disc-explorer':
                    loadDiscExplorerTab();
                    break;
            }
        }

        function loadQuickStartPersonalities() {
            debugLog('üöÄ Loading built-in personalities for Quick Start');

            const quickStartGrid = document.getElementById('quickStartPersonalities');
            if (!quickStartGrid) {
                debugLog('‚ùå Quick start personalities grid not found');
                return;
            }

            // Clear existing content
            quickStartGrid.innerHTML = '';

            // Built-in personalities (excluding custom option)
            const builtInPersonalities = [
                {
                    id: 'infrastructure_engineer',
                    name: 'Terry Mitchell',
                    avatar: 'TM',
                    role: 'Senior Infrastructure Engineer',
                    description: 'Technical expert, detail-oriented'
                },
                {
                    id: 'community_engagement',
                    name: 'Sarah Chen',
                    avatar: 'SC',
                    role: 'Community Engagement Officer',
                    description: 'People-focused, diplomatic'
                },
                {
                    id: 'budget_director',
                    name: 'David Walsh',
                    avatar: 'DW',
                    role: 'Budget & Finance Director',
                    description: 'Numbers-driven, direct about constraints'
                },
                {
                    id: 'union_rep',
                    name: 'Maria Santos',
                    avatar: 'MS',
                    role: 'Union Representative',
                    description: 'Assertive advocate for workers\' rights'
                },
                {
                    id: 'councillor_thompson',
                    name: 'Robert Thompson',
                    avatar: 'RT',
                    role: 'Long-term Councillor',
                    description: 'Steady, consensus-building approach'
                },
                {
                    id: 'strategic_planner',
                    name: 'Emily Kim',
                    avatar: 'EK',
                    role: 'Strategic Planner',
                    description: 'Analytical yet enthusiastic about new ideas'
                }
            ];

            // Create cards for built-in personalities
            builtInPersonalities.forEach(personality => {
                const card = createBuiltInPersonalityCard(personality);
                quickStartGrid.appendChild(card);
            });
        }

        function createBuiltInPersonalityCard(personality) {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'personality-card';
            cardDiv.dataset.personality = personality.id;

            cardDiv.innerHTML = `
                <div class="personality-header">
                    <div class="personality-avatar">${personality.avatar}</div>
                    <div class="personality-info">
                        <div class="personality-name">${personality.name}</div>
                        <div class="personality-role">${personality.role}</div>
                    </div>
                </div>
                <div class="personality-description">
                    ${personality.description}
                </div>
            `;

            // Add click handler
            cardDiv.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();

                // Clear other selections in Quick Start
                document.querySelectorAll('#quickStartPersonalities .personality-card').forEach(card => {
                    card.classList.remove('selected');
                });

                // Select this card
                cardDiv.classList.add('selected');

                // Set app state
                appState.selectedPersonality = personality.id;

                debugLog('‚úÖ Selected built-in personality for Quick Start:', personality.name);
                updateQuickStartButton();
            });

            return cardDiv;
        }

        function updateQuickStartButton() {
            const quickStartBtn = document.getElementById('quickStartButton');

            if (!quickStartBtn) {
                debugLog('‚ö†Ô∏è Quick Start button not found');
                return;
            }

            const isReady = appState.selectedRole && appState.selectedScenario && appState.selectedPersonality;

            quickStartBtn.disabled = !isReady || !appState.isConnected;

            if (!appState.isConnected) {
                quickStartBtn.innerHTML = '<span>‚ö†Ô∏è</span><span>Connecting to Service...</span>';
            } else if (!isReady) {
                quickStartBtn.innerHTML = '<span>üöÄ</span><span>Begin Practice Session</span>';
            } else {
                quickStartBtn.innerHTML = '<span>üöÄ</span><span>Begin Practice Session</span>';
            }

            debugLog('Quick Start button updated', { ready: isReady, connected: appState.isConnected });
        }

        function loadColleaguesTab() {
            debugLog('üë• Loading My Colleagues tab');

            const colleaguesGrid = document.getElementById('colleaguesGrid');
            const colleaguesEmpty = document.getElementById('colleaguesEmpty');

            if (!colleaguesGrid || !colleaguesEmpty) {
                debugLog('‚ùå Colleagues tab elements not found');
                return;
            }

            const savedColleagues = getStoredColleagues();
            const colleagueCount = Object.keys(savedColleagues).length;

            if (colleagueCount === 0) {
                colleaguesGrid.style.display = 'none';
                colleaguesEmpty.classList.remove('hidden');
            } else {
                colleaguesEmpty.classList.add('hidden');
                colleaguesGrid.style.display = 'grid';

                // Clear existing content
                colleaguesGrid.innerHTML = '';

                // Load enhanced colleague cards
                Object.values(savedColleagues).forEach(colleague => {
                    const card = createEnhancedColleagueCard(colleague);
                    colleaguesGrid.appendChild(card);
                });
            }
        }

        function createEnhancedColleagueCard(colleague) {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'enhanced-colleague-card';

            const initials = colleague.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
            const createdDate = new Date(colleague.created || colleague.saved_at || Date.now()).toLocaleDateString();

            cardDiv.innerHTML = `
                <div class="enhanced-card-header">
                    <div class="enhanced-avatar">${initials}</div>
                    <div class="enhanced-info">
                        <h4>${colleague.name}</h4>
                        <p>${colleague.role}</p>
                    </div>
                    <div class="enhanced-badge">üíæ</div>
                </div>
                <div class="enhanced-description">
                    ${colleague.personality.length > 100 ? colleague.personality.substring(0, 100) + '...' : colleague.personality}
                </div>
                <div class="enhanced-metadata">
                    <span class="metadata-item">Created: ${createdDate}</span>
                    <span class="metadata-item">Type: Custom</span>
                </div>
                <div class="enhanced-actions">
                    <button class="action-btn primary" onclick="useColleagueForPractice('${colleague.id}')">
                        üöÄ Use in Practice
                    </button>
                    <button class="action-btn secondary" onclick="editColleague('${colleague.id}')">
                        ‚úèÔ∏è Edit
                    </button>
                </div>
            `;

            return cardDiv;
        }

        function loadScenariosTab() {
            debugLog('üìã Loading My Scenarios tab');

            const scenariosGrid = document.getElementById('scenariosGrid');
            const scenariosEmpty = document.getElementById('scenariosEmpty');

            if (!scenariosGrid || !scenariosEmpty) {
                debugLog('‚ùå Scenarios tab elements not found');
                return;
            }

            const savedScenarios = getStoredScenarios();
            const scenarioCount = Object.keys(savedScenarios).length;

            if (scenarioCount === 0) {
                scenariosGrid.style.display = 'none';
                scenariosEmpty.classList.remove('hidden');
            } else {
                scenariosEmpty.classList.add('hidden');
                scenariosGrid.style.display = 'grid';

                // Clear existing content
                scenariosGrid.innerHTML = '';

                // Load enhanced scenario cards
                Object.values(savedScenarios).forEach(scenario => {
                    const card = createEnhancedScenarioCard(scenario);
                    scenariosGrid.appendChild(card);
                });
            }
        }

        function createEnhancedScenarioCard(scenario) {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'enhanced-scenario-card';

            const createdDate = new Date(scenario.created || scenario.saved_at || Date.now()).toLocaleDateString();
            const scenarioType = scenario.type ? scenario.type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'General';

            cardDiv.innerHTML = `
                <div class="enhanced-card-header">
                    <div class="scenario-type-badge">${scenarioType}</div>
                    <div class="enhanced-badge">üíæ</div>
                </div>
                <div class="enhanced-title">
                    <h4>${scenario.title}</h4>
                </div>
                <div class="enhanced-description">
                    ${scenario.context.length > 120 ? scenario.context.substring(0, 120) + '...' : scenario.context}
                </div>
                <div class="enhanced-metadata">
                    <span class="metadata-item">Created: ${createdDate}</span>
                    <span class="metadata-item">Type: ${scenarioType}</span>
                </div>
                <div class="enhanced-actions">
                    <button class="action-btn primary" onclick="useScenarioForPractice('${scenario.id}')">
                        üöÄ Use in Practice
                    </button>
                    <button class="action-btn secondary" onclick="editScenario('${scenario.id}')">
                        ‚úèÔ∏è Edit
                    </button>
                </div>
            `;

            return cardDiv;
        }

        function loadDiscExplorerTab() {
            debugLog('üß† Loading DISC Explorer tab');
            // DISC Explorer content is static for now
            // Future: Add interactive elements, quizzes, etc.
        }

        function updateTabCounts() {
            try {
                const colleagues = getStoredColleagues();
                const scenarios = getStoredScenarios();

                const colleagueCount = Object.keys(colleagues).length;
                const scenarioCount = Object.keys(scenarios).length;

                const colleaguesTabCount = document.getElementById('colleaguesTabCount');
                const scenariosTabCount = document.getElementById('scenariosTabCount');

                if (colleaguesTabCount) colleaguesTabCount.textContent = colleagueCount;
                if (scenariosTabCount) scenariosTabCount.textContent = scenarioCount;

            } catch (error) {
                debugLog('Error updating tab counts', error);
            }
        }

        // Quick action functions
        function useColleagueForPractice(colleagueId) {
            debugLog('üöÄ Using colleague for practice:', colleagueId);
            // Switch to Quick Start tab and select this colleague
            // Future implementation
            alert('Feature coming soon: Quick practice with selected colleague');
        }

        function editColleague(colleagueId) {
            debugLog('‚úèÔ∏è Editing colleague:', colleagueId);
            // Future implementation
            alert('Feature coming soon: Edit colleague in-place');
        }

        function useScenarioForPractice(scenarioId) {
            debugLog('üöÄ Using scenario for practice:', scenarioId);
            // Switch to Quick Start tab and select this scenario
            // Future implementation
            alert('Feature coming soon: Quick practice with selected scenario');
        }

        function editScenario(scenarioId) {
            debugLog('‚úèÔ∏è Editing scenario:', scenarioId);
            // Future implementation
            alert('Feature coming soon: Edit scenario in-place');
        }
// ============================================
// INITIALIZATION
// ============================================
// Update the existing initializeApp function
function initializeApp() {
    debugLog('üöÄ Initializing Professional Conversation Trainer with Tabs');

    // Initialize tab system FIRST
    initializeTabs();

    // Set up existing event listeners
    setupEventListeners();

    // Test API connection
    testAPIConnection();

    // Update storage counts (both old and new systems)
    updateStorageCounts();
    updateTabCounts();

    // Load saved content (Phase 1 functionality)
    loadSavedColleagues();
    loadSavedScenarios();

    debugLog('‚úÖ Full application initialized with tab system');
    initializeTTS();
}

// Initialize Application
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();

    // Update storage counts periodically
    setInterval(updateStorageCounts, 2000);
});
// ============================================
// IMPORT FUNCTIONS - Add these to your script
// ============================================

function importColleagues() {
    debugLog('üìÇ Starting colleague import process');

    // Create file input element
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.json';
    fileInput.style.display = 'none';

    fileInput.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) {
            debugLog('‚ùå No file selected');
            return;
        }

        debugLog('üìÑ File selected:', file.name);

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importData = JSON.parse(e.target.result);
                debugLog('üìã Import data parsed:', importData);

                // Validate file structure
                if (!importData.type || importData.type !== 'conversation_trainer_colleagues') {
                    throw new Error('Invalid file format. Please select a valid colleagues export file.');
                }

                if (!importData.colleagues || typeof importData.colleagues !== 'object') {
                    throw new Error('No colleague data found in file.');
                }

                // Get existing colleagues
                const existingColleagues = getStoredColleagues();
                const importedColleagues = importData.colleagues;

                let importedCount = 0;
                let duplicateCount = 0;

                // Process each imported colleague
                Object.values(importedColleagues).forEach(colleague => {
                    // Check for duplicates by name and role
                    const isDuplicate = Object.values(existingColleagues).some(existing =>
                        existing.name === colleague.name && existing.role === colleague.role
                    );

                    if (isDuplicate) {
                        duplicateCount++;
                        debugLog('‚ö†Ô∏è Duplicate found, skipping:', colleague.name);
                    } else {
                        // Generate new ID and add to storage
                        const newId = `colleague_imported_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                        colleague.id = newId;
                        colleague.imported_at = new Date().toISOString();

                        existingColleagues[newId] = colleague;
                        importedCount++;
                        debugLog('‚úÖ Imported colleague:', colleague.name);
                    }
                });

                // Save updated colleagues to storage
                localStorage.setItem('conversation_trainer_colleagues', JSON.stringify(existingColleagues));
                updateStorageCounts();

                // Show success message
                let message = `Successfully imported ${importedCount} colleague${importedCount === 1 ? '' : 's'}!`;
                if (duplicateCount > 0) {
                    message += ` (${duplicateCount} duplicate${duplicateCount === 1 ? '' : 's'} skipped)`;
                }

                showSuccessMessage(message);
                debugLog('üéâ Import completed', { imported: importedCount, duplicates: duplicateCount });

            } catch (error) {
                debugLog('‚ùå Import error:', error);
                showErrorMessage(`Import failed: ${error.message}`);
            }
        };

        reader.onerror = function() {
            debugLog('‚ùå File reading error');
            showErrorMessage('Error reading file. Please try again.');
        };

        reader.readAsText(file);
    };

    // Trigger file selection
    document.body.appendChild(fileInput);
    fileInput.click();
    document.body.removeChild(fileInput);
}

function importScenarios() {
    debugLog('üìÇ Starting scenario import process');

    // Create file input element
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.json';
    fileInput.style.display = 'none';

    fileInput.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) {
            debugLog('‚ùå No file selected');
            return;
        }

        debugLog('üìÑ File selected:', file.name);

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importData = JSON.parse(e.target.result);
                debugLog('üìã Import data parsed:', importData);

                // Validate file structure
                if (!importData.type || importData.type !== 'conversation_trainer_scenarios') {
                    throw new Error('Invalid file format. Please select a valid scenarios export file.');
                }

                if (!importData.scenarios || typeof importData.scenarios !== 'object') {
                    throw new Error('No scenario data found in file.');
                }

                // Get existing scenarios
                const existingScenarios = getStoredScenarios();
                const importedScenarios = importData.scenarios;

                let importedCount = 0;
                let duplicateCount = 0;

                // Process each imported scenario
                Object.values(importedScenarios).forEach(scenario => {
                    // Check for duplicates by title
                    const isDuplicate = Object.values(existingScenarios).some(existing =>
                        existing.title === scenario.title
                    );

                    if (isDuplicate) {
                        duplicateCount++;
                        debugLog('‚ö†Ô∏è Duplicate found, skipping:', scenario.title);
                    } else {
                        // Generate new ID and add to storage
                        const newId = `scenario_imported_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                        scenario.id = newId;
                        scenario.imported_at = new Date().toISOString();

                        existingScenarios[newId] = scenario;
                        importedCount++;
                        debugLog('‚úÖ Imported scenario:', scenario.title);
                    }
                });

                // Save updated scenarios to storage
                localStorage.setItem('conversation_trainer_scenarios', JSON.stringify(existingScenarios));
                updateStorageCounts();

                // Show success message
                let message = `Successfully imported ${importedCount} scenario${importedCount === 1 ? '' : 's'}!`;
                if (duplicateCount > 0) {
                    message += ` (${duplicateCount} duplicate${duplicateCount === 1 ? '' : 's'} skipped)`;
                }

                showSuccessMessage(message);
                debugLog('üéâ Import completed', { imported: importedCount, duplicates: duplicateCount });

            } catch (error) {
                debugLog('‚ùå Import error:', error);
                showErrorMessage(`Import failed: ${error.message}`);
            }
        };

        reader.onerror = function() {
            debugLog('‚ùå File reading error');
            showErrorMessage('Error reading file. Please try again.');
        };

        reader.readAsText(file);
    };

    // Trigger file selection
    document.body.appendChild(fileInput);
    fileInput.click();
    document.body.removeChild(fileInput);
}
// Update the refreshSavedContent function to also refresh tab counts
function refreshSavedContent() {
    debugLog('üîÑ Refreshing saved content in UI and tabs');

    try {
        // Remove existing saved colleague cards (from Phase 1 grid)
        document.querySelectorAll('.personality-card.saved-colleague').forEach(card => {
            card.remove();
        });

        // Remove existing saved scenario cards (from Phase 1 grid)
        document.querySelectorAll('.option-card.saved-scenario').forEach(card => {
            card.remove();
        });

        // Reload saved content into Phase 1 grids
        loadSavedColleagues();
        loadSavedScenarios();

        // Update tab counts and content
        updateTabCounts();

        // Refresh tab content if currently viewing those tabs
        const activeTab = document.querySelector('.tab-content.active');
        if (activeTab) {
            const tabId = activeTab.id.replace('-tab', '');
            if (tabId === 'my-colleagues') {
                loadColleaguesTab();
            } else if (tabId === 'my-scenarios') {
                loadScenariosTab();
            }
        }

        debugLog('‚úÖ Saved content and tabs refreshed successfully');

    } catch (error) {
        debugLog('‚ùå Error refreshing saved content:', error);
    }
}
// ============================================
// BULK IMPORT FUNCTION (Import Both Types)
// ============================================

function importData() {
    debugLog('üìÇ Starting bulk data import process');

    // Create file input element
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.json';
    fileInput.style.display = 'none';

    fileInput.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) {
            debugLog('‚ùå No file selected');
            return;
        }

        debugLog('üìÑ File selected:', file.name);

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importData = JSON.parse(e.target.result);
                debugLog('üìã Import data parsed:', importData);

                // Determine file type and import accordingly
                if (importData.type === 'conversation_trainer_colleagues') {
                    // Import colleagues
                    importColleaguesData(importData);
                } else if (importData.type === 'conversation_trainer_scenarios') {
                    // Import scenarios
                    importScenariosData(importData);
                } else {
                    throw new Error('Unknown file format. Please select a valid export file.');
                }

            } catch (error) {
                debugLog('‚ùå Import error:', error);
                showErrorMessage(`Import failed: ${error.message}`);
            }
        };

        reader.onerror = function() {
            debugLog('‚ùå File reading error');
            showErrorMessage('Error reading file. Please try again.');
        };

        reader.readAsText(file);
    };

    // Trigger file selection
    document.body.appendChild(fileInput);
    fileInput.click();
    document.body.removeChild(fileInput);
}

// Helper functions for bulk import
function importColleaguesData(importData) {
    if (!importData.colleagues || typeof importData.colleagues !== 'object') {
        throw new Error('No colleague data found in file.');
    }

    const existingColleagues = getStoredColleagues();
    const importedColleagues = importData.colleagues;

    let importedCount = 0;
    let duplicateCount = 0;

    Object.values(importedColleagues).forEach(colleague => {
        const isDuplicate = Object.values(existingColleagues).some(existing =>
            existing.name === colleague.name && existing.role === colleague.role
        );

        if (isDuplicate) {
            duplicateCount++;
        } else {
            const newId = `colleague_imported_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            colleague.id = newId;
            colleague.imported_at = new Date().toISOString();
            existingColleagues[newId] = colleague;
            importedCount++;
        }
    });

    localStorage.setItem('conversation_trainer_colleagues', JSON.stringify(existingColleagues));
    updateStorageCounts();

    let message = `Successfully imported ${importedCount} colleague${importedCount === 1 ? '' : 's'}!`;
    if (duplicateCount > 0) {
        message += ` (${duplicateCount} duplicate${duplicateCount === 1 ? '' : 's'} skipped)`;
    }

    showSuccessMessage(message);
}

function importScenariosData(importData) {
    if (!importData.scenarios || typeof importData.scenarios !== 'object') {
        throw new Error('No scenario data found in file.');
    }

    const existingScenarios = getStoredScenarios();
    const importedScenarios = importData.scenarios;

    let importedCount = 0;
    let duplicateCount = 0;

    Object.values(importedScenarios).forEach(scenario => {
        const isDuplicate = Object.values(existingScenarios).some(existing =>
            existing.title === scenario.title
        );

        if (isDuplicate) {
            duplicateCount++;
        } else {
            const newId = `scenario_imported_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            scenario.id = newId;
            scenario.imported_at = new Date().toISOString();
            existingScenarios[newId] = scenario;
            importedCount++;
        }
    });

    localStorage.setItem('conversation_trainer_scenarios', JSON.stringify(existingScenarios));
    updateStorageCounts();

    let message = `Successfully imported ${importedCount} scenario${importedCount === 1 ? '' : 's'}!`;
    if (duplicateCount > 0) {
        message += ` (${duplicateCount} duplicate${duplicateCount === 1 ? '' : 's'} skipped)`;
    }

    showSuccessMessage(message);
}
// ============================================
// ADDITIONAL STORAGE MANAGEMENT FUNCTIONS
// ============================================

function clearAllStorage() {
    const colleagues = getStoredColleagues();
    const scenarios = getStoredScenarios();

    const colleagueCount = Object.keys(colleagues).length;
    const scenarioCount = Object.keys(scenarios).length;

    if (colleagueCount === 0 && scenarioCount === 0) {
        showSuccessMessage('No data to clear. Storage is already empty.');
        return;
    }

    const message = `Are you sure you want to delete all stored data?\n\nThis will permanently remove:\n‚Ä¢ ${colleagueCount} saved colleague${colleagueCount === 1 ? '' : 's'}\n‚Ä¢ ${scenarioCount} saved scenario${scenarioCount === 1 ? '' : 's'}\n\nThis action cannot be undone.`;

    if (confirm(message)) {
        try {
            localStorage.removeItem('conversation_trainer_colleagues');
            localStorage.removeItem('conversation_trainer_scenarios');
            updateStorageCounts();

            debugLog('üóëÔ∏è All storage cleared');
            showSuccessMessage('All stored data has been cleared successfully.');

        } catch (error) {
            debugLog('‚ùå Error clearing storage:', error);
            showErrorMessage('Error clearing storage. Please try again.');
        }
    }
}

// Enhanced test storage function with more details
function testStorage() {
    const colleagues = getStoredColleagues();
    const scenarios = getStoredScenarios();

    console.log('üìä === CONVERSATION TRAINER STORAGE REPORT ===');
    console.log('üìö Stored Colleagues:', colleagues);
    console.log('üìã Stored Scenarios:', scenarios);
    console.log('üìà Storage Statistics:', {
        colleagues: {
            count: Object.keys(colleagues).length,
            totalSize: JSON.stringify(colleagues).length + ' characters'
        },
        scenarios: {
            count: Object.keys(scenarios).length,
            totalSize: JSON.stringify(scenarios).length + ' characters'
        },
        lastUpdated: new Date().toISOString()
    });

    // Test localStorage availability
    try {
        localStorage.setItem('test', 'test');
        localStorage.removeItem('test');
        console.log('‚úÖ localStorage is working properly');
    } catch (error) {
        console.log('‚ùå localStorage error:', error);
    }

    console.log('================================================');

    showSuccessMessage('Storage report generated. Check browser console for detailed information.');
}
// ============================================
// ENHANCED DISC QUADRANT FUNCTIONALITY
// ============================================

// DISC insights data based on NSW research
const discInsights = {
    D: {
        population: {
            title: "Dominance (D) - 3-11% of Population",
            content: "The smallest but most visible group in NSW councils. These are your change agents and crisis leaders.",
            stats: [
                { number: "7%", label: "Average in NSW councils" },
                { number: "Fast", label: "Decision making style" }
            ],
            examples: "Infrastructure Directors pushing major projects, Crisis managers during natural disasters, Reform leaders driving organisational change"
        },
        department: {
            title: "D-Types by Department",
            content: "Dominance personalities gravitate toward leadership and project-driven roles across council departments.",
            stats: [
                { number: "Directors", label: "Senior leadership" },
                { number: "Projects", label: "Infrastructure focus" }
            ],
            examples: "Executive leadership, Major project managers, Emergency response coordinators, Reform implementation leaders"
        },
        generation: {
            title: "Generational D-Type Patterns",
            content: "Generation X (44-60) shows highest D-type representation in NSW councils, often in senior leadership.",
            stats: [
                { number: "Gen X", label: "Highest D representation" },
                { number: "Leadership", label: "Common career path" }
            ],
            examples: "Gen X: Results-focused directors. Millennials: Collaborative change agents. Boomers: Authoritative traditionalists"
        }
    },
    I: {
        population: {
            title: "Influence (I) - 11-40% of Population",
            content: "The people-connectors of councils. Essential for community engagement and stakeholder relationships.",
            stats: [
                { number: "25%", label: "Average in NSW councils" },
                { number: "High", label: "Community engagement" }
            ],
            examples: "Community consultation coordinators, Public relations specialists, Elected councillors in people-facing roles"
        },
        department: {
            title: "I-Types by Department",
            content: "Influence personalities dominate community-facing roles and collaborative departments.",
            stats: [
                { number: "Community", label: "Services focus" },
                { number: "External", label: "Stakeholder roles" }
            ],
            examples: "Community engagement, Customer service, Communications, Economic development, Tourism promotion"
        },
        generation: {
            title: "Generational I-Type Patterns",
            content: "Millennials (29-43) trending toward I-style behaviours, valuing collaboration and social connection.",
            stats: [
                { number: "Millennials", label: "Trending I-style" },
                { number: "Purpose", label: "Driven motivation" }
            ],
            examples: "Millennials: Purpose-driven collaborators. Gen Z: Authentic communicators. Gen X: Relationship builders"
        }
    },
    S: {
        population: {
            title: "Steadiness (S) - 69% of Population",
            content: "The backbone of NSW councils. These reliable team members ensure consistent service delivery.",
            stats: [
                { number: "69%", label: "Largest group" },
                { number: "Stable", label: "Service delivery" }
            ],
            examples: "Long-serving administrative staff, Service delivery coordinators, Policy implementation specialists"
        },
        department: {
            title: "S-Types by Department",
            content: "Steadiness personalities form the operational core across all council departments.",
            stats: [
                { number: "Operations", label: "Core strength" },
                { number: "Stability", label: "Key contribution" }
            ],
            examples: "Administrative support, Customer service, Records management, Asset maintenance, Library services"
        },
        generation: {
            title: "Generational S-Type Patterns",
            content: "Baby Boomers (61-79) show strong S-type tendencies, valuing security and institutional knowledge.",
            stats: [
                { number: "Boomers", label: "Strong S tendencies" },
                { number: "Institutional", label: "Knowledge holders" }
            ],
            examples: "Boomers: Security-focused veterans. Gen X: Work-life balance seekers. Millennials: Team-oriented supporters"
        }
    },
    C: {
        population: {
            title: "Conscientiousness (C) - 17% of Population",
            content: "The quality guardians ensuring accuracy, compliance, and technical excellence in council operations.",
            stats: [
                { number: "17%", label: "Technical specialists" },
                { number: "High", label: "Quality standards" }
            ],
            examples: "Budget analysts, Compliance officers, Strategic planners, Technical specialists, Quality assurance professionals"
        },
        department: {
            title: "C-Types by Department",
            content: "Conscientiousness personalities concentrate in technical, financial, and analytical roles.",
            stats: [
                { number: "Technical", label: "Roles focus" },
                { number: "Accuracy", label: "Core value" }
            ],
            examples: "Engineering, Finance, Legal, Strategic planning, IT, Environmental health, Building certification"
        },
        generation: {
            title: "Generational C-Type Patterns",
            content: "Generation Z (13-28) early data suggests trending toward C-style behaviours with digital-first thinking.",
            stats: [
                { number: "Gen Z", label: "Trending C-style" },
                { number: "Digital", label: "Native skills" }
            ],
            examples: "Gen Z: Data-driven analysts. Millennials: Process improvers. Gen X: Systems thinkers. Boomers: Detail masters"
        }
    }
};

function initializeDISCQuadrant() {
    debugLog('üß† Initializing interactive DISC quadrant');

    // Add click handlers to quadrants
    document.querySelectorAll('.quadrant').forEach(quadrant => {
        quadrant.addEventListener('click', function() {
            const discType = this.dataset.type;
            const currentView = document.querySelector('.toggle-btn.active').dataset.view;
            showDISCInsights(discType, currentView);
        });
    });

    // Add click handlers to view toggles
    document.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // Update active toggle
            document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');

            const view = this.dataset.view;
            updateQuadrantView(view);
        });
    });

    debugLog('‚úÖ DISC quadrant initialized with interactive features');
}

function showDISCInsights(discType, view) {
    debugLog(`üìä Showing ${discType} insights for ${view} view`);

    const insight = discInsights[discType][view];
    const insightPanel = document.getElementById('insightPanel');

    if (insight && insightPanel) {
        insightPanel.innerHTML = `
            <h4>üí° ${insight.title}</h4>
            <p>${insight.content}</p>
            <div class="insight-stats">
                ${insight.stats.map(stat => `
                    <div class="stat-item">
                        <span class="stat-number">${stat.number}</span>
                        <span class="stat-label">${stat.label}</span>
                    </div>
                `).join('')}
            </div>
            <div style="margin-top: 1rem; padding: 1rem; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border-left: 3px solid #3b82f6;">
                <strong>Examples in NSW Councils:</strong><br>
                <span style="font-size: 0.875rem; color: #374151;">${insight.examples}</span>
            </div>
        `;

        // Add visual feedback
        document.querySelectorAll('.quadrant').forEach(q => q.style.opacity = '0.7');
        document.querySelector(`[data-type="${discType}"]`).style.opacity = '1';

        setTimeout(() => {
            document.querySelectorAll('.quadrant').forEach(q => q.style.opacity = '1');
        }, 2000);
    }
}

function updateQuadrantView(view) {
    debugLog(`üîÑ Updating quadrant view to: ${view}`);

    const viewInfo = document.getElementById('currentViewInfo');
    const viewLabels = {
        population: 'General Population Distribution',
        department: 'NSW Council Department Patterns',
        generation: 'Generational DISC Trends'
    };

    if (viewInfo) {
        viewInfo.textContent = `Showing: ${viewLabels[view]}`;
    }

    // Update visual styling based on view
    const quadrants = document.querySelectorAll('.quadrant');
    quadrants.forEach(quadrant => {
        quadrant.classList.remove('population-view', 'department-view', 'generation-view');
        quadrant.classList.add(`${view}-view`);
    });

    // Reset insight panel
    const insightPanel = document.getElementById('insightPanel');
    if (insightPanel) {
        insightPanel.innerHTML = `
            <h4>üí° NSW Local Government Insights</h4>
            <p>Click on any quadrant above to explore specific insights for that DISC type in ${viewLabels[view].toLowerCase()}.</p>
            <div class="insight-stats">
                <div class="stat-item">
                    <span class="stat-number">69%</span>
                    <span class="stat-label">S-types form the backbone of council operations</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">43</span>
                    <span class="stat-label">Median age in NSW councils</span>
                </div>
            </div>
        `;
    }
}
// Force initialize DISC quadrant after page load
window.addEventListener('load', function() {
    setTimeout(() => {
        if (typeof initializeDISCQuadrant === 'function') {
            initializeDISCQuadrant();
            console.log('‚úÖ DISC Quadrant manually initialized');
        } else {
            console.log('‚ùå initializeDISCQuadrant function not found');
        }
    }, 1000);
});
// ============================================
// EMAIL PRACTICE MODULE FUNCTIONS
// ============================================

// Email module state
let emailState = {
    currentMode: 'analysis',
    selectedColleague: null,
    analysisResults: null,
    emailTemplates: {},
    isAnalyzing: false
};

// Initialize email module
function initializeEmailModule() {
    debugLog('üìß Initializing Email Practice module');

    try {
        // Load email templates from storage
        loadEmailTemplates();

        // Populate colleague dropdowns with existing colleagues
        populateEmailColleagueSelectors();

        // Set up email-specific event listeners
        setupEmailEventListeners();

        // Update tab count
        updateEmailTabCount();

        debugLog('‚úÖ Email module initialized successfully');
    } catch (error) {
        debugLog('‚ùå Error initializing email module:', error);
    }
}

// Set up email-specific event listeners
function setupEmailEventListeners() {
    debugLog('üîß Setting up email event listeners');

    try {
        // Mode switching buttons
        document.querySelectorAll('.mode-button').forEach(button => {
            button.addEventListener('click', function() {
                if (!this.disabled) {
                    const mode = this.dataset.mode;
                    switchEmailMode(mode);
                }
            });
        });

        // Email recipient selection
        const emailRecipient = document.getElementById('emailRecipient');
        if (emailRecipient) {
            emailRecipient.addEventListener('change', handleRecipientSelection);
        }

        // Email analysis button
        const analyzeBtn = document.getElementById('analyzeEmailBtn');
        if (analyzeBtn) {
            analyzeBtn.addEventListener('click', analyzeEmail);
        }

        // Clear email button
        const clearBtn = document.getElementById('clearEmailBtn');
        if (clearBtn) {
            clearBtn.addEventListener('click', clearEmailComposer);
        }

        // Close analysis button
        const closeAnalysisBtn = document.getElementById('closeAnalysisBtn');
        if (closeAnalysisBtn) {
            closeAnalysisBtn.addEventListener('click', closeAnalysisResults);
        }

        // Save as template button
        const saveTemplateBtn = document.getElementById('saveAsTemplateBtn');
        if (saveTemplateBtn) {
            saveTemplateBtn.addEventListener('click', saveCurrentEmailAsTemplate);
        }

        // Export analysis button
        const exportBtn = document.getElementById('exportAnalysisBtn');
        if (exportBtn) {
            exportBtn.addEventListener('click', exportAnalysisResults);
        }

        // Apply suggestions button
        const improveBtn = document.getElementById('improveEmailBtn');
        if (improveBtn) {
            improveBtn.addEventListener('click', applyEmailSuggestions);
        }

        debugLog('‚úÖ Email event listeners set up successfully');
    } catch (error) {
        debugLog('‚ùå Error setting up email event listeners:', error);
    }
}

// Switch email modes (analysis, templates, simulation)
function switchEmailMode(mode) {
    debugLog(`üìß Switching to email mode: ${mode}`);

    try {
        // Update mode buttons
        document.querySelectorAll('.mode-button').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-mode="${mode}"]`).classList.add('active');

        // Update mode content
        document.querySelectorAll('.email-mode-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(`${mode}-mode`).classList.add('active');

        emailState.currentMode = mode;

        // Mode-specific initialization
        if (mode === 'templates') {
            loadEmailTemplatesUI();
        }

        debugLog(`‚úÖ Switched to email mode: ${mode}`);
    } catch (error) {
        debugLog('‚ùå Error switching email mode:', error);
    }
}

// Populate colleague selector dropdowns with existing colleagues
function populateEmailColleagueSelectors() {
    debugLog('üë• Populating email colleague selectors');

    try {
        const colleagues = getStoredColleagues();
        const selector = document.getElementById('emailRecipient');

        if (selector) {
            // Clear existing options (keep first placeholder)
            selector.innerHTML = '<option value="">Select colleague...</option>';

            // Add stored colleagues
            Object.values(colleagues).forEach(colleague => {
                const option = document.createElement('option');
                option.value = colleague.id;
                option.textContent = `${colleague.name} (${colleague.role})`;
                option.dataset.colleagueData = JSON.stringify(colleague);
                selector.appendChild(option);
            });

            debugLog(`‚úÖ Added ${Object.keys(colleagues).length} colleagues to email selector`);
        }
    } catch (error) {
        debugLog('‚ùå Error populating colleague selectors:', error);
    }
}

// Handle recipient selection
function handleRecipientSelection(event) {
    const selectedValue = event.target.value;

    if (selectedValue) {
        try {
            // Get colleague data from the selected option
            const selectedOption = event.target.selectedOptions[0];
            const colleagueData = JSON.parse(selectedOption.dataset.colleagueData);

            emailState.selectedColleague = colleagueData;

            // Show colleague info panel
            displayColleagueInfo(colleagueData);

            debugLog('üë§ Selected colleague:', colleagueData.name);
        } catch (error) {
            debugLog('‚ùå Error handling recipient selection:', error);
        }
    } else {
        // Hide colleague info panel
        const colleaguePanel = document.getElementById('colleagueInfoPanel');
        if (colleaguePanel) {
            colleaguePanel.style.display = 'none';
        }
        emailState.selectedColleague = null;
    }
}

// Display colleague information in the side panel
function displayColleagueInfo(colleague) {
    try {
        const panel = document.getElementById('colleagueInfoPanel');
        const avatar = document.getElementById('colleagueAvatar');
        const name = document.getElementById('colleagueName');
        const role = document.getElementById('colleagueRole');
        const disc = document.getElementById('colleagueDisc');

        if (panel && avatar && name && role && disc) {
            // Generate avatar initials
            const initials = colleague.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);

            // Determine DISC type (simple heuristic based on personality)
            const discType = inferDISCType(colleague.personality || '');

            // Update panel content
            avatar.textContent = initials;
            name.textContent = colleague.name;
            role.textContent = colleague.role;
            disc.textContent = `${discType}-Type`;

            // Show the panel
            panel.style.display = 'block';

            debugLog('‚úÖ Displayed colleague info for:', colleague.name);
        }
    } catch (error) {
        debugLog('‚ùå Error displaying colleague info:', error);
    }
}

// Simple DISC type inference based on personality keywords
function inferDISCType(personalityText) {
    const text = personalityText.toLowerCase();

    const discPatterns = {
        'D': ['direct', 'decisive', 'results', 'action', 'challenge', 'fast', 'leadership'],
        'I': ['people', 'social', 'enthusiasm', 'team', 'collaborate', 'communicate', 'engaging'],
        'S': ['patient', 'support', 'steady', 'reliable', 'consensus', 'stable', 'consistent'],
        'C': ['detail', 'accurate', 'analytical', 'systematic', 'quality', 'data', 'precise']
    };

    let scores = { D: 0, I: 0, S: 0, C: 0 };

    // Count pattern matches
    Object.entries(discPatterns).forEach(([type, patterns]) => {
        patterns.forEach(pattern => {
            if (text.includes(pattern)) {
                scores[type]++;
            }
        });
    });

    // Return highest scoring type, default to 'I' if tie/no matches
    const maxScore = Math.max(...Object.values(scores));
    if (maxScore === 0) return 'I'; // Default to I-type

    return Object.keys(scores).find(key => scores[key] === maxScore) || 'I';
}

// ============================================
// ENHANCED EMAIL ANALYSIS - FRONTEND
// Replace your existing analyzeEmail() function with this
// ============================================

/**
 * Enhanced email analysis using backend Claude API
 * Replaces the mock analysis with real AI assessment
 */
async function analyzeEmailEnhanced() {
    const recipientId = document.getElementById('emailRecipient').value;
    const subject = document.getElementById('emailSubject').value.trim();
    const content = document.getElementById('emailContent').value.trim();

    // Validation
    if (!content) {
        showErrorMessage('Please enter email content to analyze');
        return;
    }

    if (emailState.isAnalyzing) {
        debugLog('‚ö†Ô∏è Analysis already in progress');
        return;
    }

    try {
        emailState.isAnalyzing = true;
        debugLog('ü§ñ Starting enhanced email analysis with Claude API via backend');

        // Show loading state
        const analyzeBtn = document.getElementById('analyzeEmailBtn');
        const originalText = analyzeBtn.innerHTML;
        analyzeBtn.innerHTML = '‚è≥ Analyzing with AI...';
        analyzeBtn.disabled = true;

        // Hide getting started panel
        const gettingStartedPanel = document.getElementById('gettingStartedPanel');
        if (gettingStartedPanel) {
            gettingStartedPanel.style.display = 'none';
        }

        // Prepare email data for backend
        const emailData = {
            subject: subject,
            content: content,
            colleague: emailState.selectedColleague,
            analysis_type: emailState.analysisType || 'outgoing',
            context: 'NSW Local Government workplace communication'
        };

        debugLog('üì§ Sending email data to backend:', emailData);

        // Call backend API for analysis
        const response = await fetch(`${CONFIG.BACKEND_API_URL}/api/email/analyze`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(emailData)
        });

        debugLog('üì• Backend response status:', response.status);

        if (!response.ok) {
            const errorData = await response.text();
            debugLog('‚ùå Backend error response:', errorData);
            throw new Error(`Backend analysis failed (${response.status}): ${errorData}`);
        }

        const analysisResults = await response.json();
        debugLog('‚úÖ Backend analysis results:', analysisResults);

        // Convert backend format to frontend format if needed
        const formattedResults = formatAnalysisForUI(analysisResults);

        // Display results using existing UI functions
        displayEnhancedAnalysisResults(formattedResults);

        // Store results
        emailState.analysisResults = formattedResults;

        debugLog('‚úÖ Enhanced email analysis completed successfully');
        showSuccessMessage(
            `Email analysis completed! ${analysisResults.claude_powered !== false ?
                'Powered by Claude AI for professional insights.' :
                'Using enhanced pattern analysis (Claude temporarily unavailable).'}`
        );

    } catch (error) {
        debugLog('‚ùå Enhanced email analysis error:', error);

        // Show user-friendly error message
        let errorMessage = 'Email analysis failed. ';
        if (error.message.includes('Failed to fetch')) {
            errorMessage += 'Please check your internet connection and try again.';
        } else if (error.message.includes('500')) {
            errorMessage += 'Analysis service temporarily unavailable. Please try again later.';
        } else {
            errorMessage += 'Please try again or contact support if the problem persists.';
        }

        showErrorMessage(errorMessage);

        // Fallback to basic frontend analysis if backend completely fails
        try {
            debugLog('üîÑ Attempting frontend fallback analysis');
            const fallbackResults = generateBasicFrontendAnalysis({
                content: content,
                subject: subject,
                colleague: emailState.selectedColleague
            });
            displayEnhancedAnalysisResults(fallbackResults);
            emailState.analysisResults = fallbackResults;
            showSuccessMessage('Analysis completed using basic pattern matching (AI service unavailable).');
        } catch (fallbackError) {
            debugLog('‚ùå Fallback analysis also failed:', fallbackError);
        }

    } finally {
        // Restore button state
        emailState.isAnalyzing = false;
        const analyzeBtn = document.getElementById('analyzeEmailBtn');
        if (analyzeBtn) {
            analyzeBtn.innerHTML = 'üìä Analyze Email';
            analyzeBtn.disabled = false;
        }
    }
}

/**
 * Format backend analysis results for frontend UI
 */
function formatAnalysisForUI(backendResults) {
    // If already in correct format, return as-is
    if (backendResults.overall_score !== undefined) {
        return backendResults;
    }

    // Convert any different backend format to expected frontend format
    return {
        overall_score: backendResults.score || backendResults.overall_assessment?.effectiveness_score || 5,
        overall_feedback: backendResults.feedback || backendResults.overall_feedback || 'Analysis completed',

        code_compliance: backendResults.code_compliance || {
            status: 'compliant',
            issues: [],
            risk_level: 'low'
        },

        disc_scores: backendResults.disc_scores || {
            D: 6, I: 6, S: 6, C: 6
        },

        disc_feedback: backendResults.disc_feedback || {
            D: 'Assessment completed',
            I: 'Assessment completed',
            S: 'Assessment completed',
            C: 'Assessment completed'
        },

        suggestions: backendResults.suggestions || [],
        strengths: backendResults.strengths || [],
        quick_tips: backendResults.quick_tips || generateDefaultQuickTips(),

        analysis_timestamp: backendResults.analysis_timestamp || new Date().toISOString(),
        analysis_type: backendResults.analysis_type || 'outgoing',
        claude_powered: backendResults.claude_powered !== false
    };
}

/**
 * Generate basic frontend analysis as ultimate fallback
 */
function generateBasicFrontendAnalysis(emailData) {
    const content = emailData.content || '';
    const subject = emailData.subject || '';

    // Basic pattern checks
    const hasGreeting = /\b(hi|hello|dear|good morning|good afternoon)\b/i.test(content);
    const hasClosing = /\b(regards|thanks|sincerely|best|cheers)\b/i.test(content);
    const hasPoliteness = /\b(please|thank you|would you|could you)\b/i.test(content);

    // Check for problematic patterns
    const problematicPatterns = [
        /\b(stupid|idiot|moron|pathetic|ridiculous)\b/i,
        /[A-Z]{4,}/g, // ALL CAPS
        /!{3,}/g // Multiple exclamation marks
    ];

    const hasProblems = problematicPatterns.some(pattern => pattern.test(content));

    // Calculate score
    let score = 5;
    if (hasGreeting) score += 0.5;
    if (hasClosing) score += 0.5;
    if (hasPoliteness) score += 1;
    if (subject && subject.length > 5) score += 0.5;
    if (hasProblems) score -= 3; // Significant penalty

    score = Math.max(1, Math.min(10, score));

    const suggestions = [];
    if (hasProblems) {
        suggestions.push({
            type: 'critical',
            category: 'Professional Standards',
            text: 'Review language for professional appropriateness - some phrases may be inappropriate',
            impact: 'High',
            reason: 'Professional workplace communication requires respectful language'
        });
    }
    if (!hasGreeting) {
        suggestions.push({
            type: 'improvement',
            category: 'Structure',
            text: 'Consider adding a professional greeting',
            impact: 'Medium',
            reason: 'Greetings help establish a respectful tone'
        });
    }
    if (!hasClosing) {
        suggestions.push({
            type: 'improvement',
            category: 'Structure',
            text: 'Add a professional closing',
            impact: 'Medium',
            reason: 'Professional closings complete the communication'
        });
    }

    return {
        overall_score: Math.round(score * 10) / 10,
        overall_feedback: hasProblems ?
            'This email contains language that may not meet professional standards.' :
            'Basic structure analysis completed. For detailed insights, please try again when the AI service is available.',

        code_compliance: {
            status: hasProblems ? 'concerning' : 'compliant',
            issues: hasProblems ? ['Potentially inappropriate language detected'] : [],
            risk_level: hasProblems ? 'high' : 'low'
        },

        disc_scores: { D: score, I: score, S: score, C: score },
        disc_feedback: {
            D: 'Basic assessment only',
            I: 'Basic assessment only',
            S: 'Basic assessment only',
            C: 'Basic assessment only'
        },

        suggestions: suggestions,
        strengths: hasGreeting && hasClosing ? ['Good email structure'] : [],
        quick_tips: [
            {
                icon: 'ü§ñ',
                text: 'AI Analysis Unavailable',
                detail: 'This is a basic pattern analysis. Try again later for AI-powered insights.'
            }
        ],

        analysis_timestamp: new Date().toISOString(),
        analysis_type: emailData.analysis_type || 'outgoing',
        claude_powered: false,
        fallback_analysis: true
    };
}

/**
 * Generate default quick tips
 */
function generateDefaultQuickTips() {
    return [
        {
            icon: 'üìß',
            text: 'Professional Email Best Practices',
            detail: 'Use clear subject lines, professional greetings, and respectful closings'
        },
        {
            icon: '‚è∞',
            text: 'Response Timing',
            detail: 'Council staff typically respond within 24-48 hours to professional emails'
        },
        {
            icon: 'üéØ',
            text: 'Clear Communication',
            detail: 'Be specific about what actions are needed and when'
        }
    ];
}

// ============================================
// UPDATE EXISTING FUNCTION REFERENCES
// ============================================

// Update your existing email analysis button handler
// Find where analyzeEmail is called and replace with analyzeEmailEnhanced

// If you have an existing setupEmailEventListeners function, update it:
function updateEmailAnalysisButtonHandler() {
    const analyzeBtn = document.getElementById('analyzeEmailBtn');
    if (analyzeBtn) {
        // Remove old event listeners
        analyzeBtn.replaceWith(analyzeBtn.cloneNode(true));

        // Add new event listener with enhanced function
        const newAnalyzeBtn = document.getElementById('analyzeEmailBtn');
        newAnalyzeBtn.addEventListener('click', analyzeEmailEnhanced);

        debugLog('‚úÖ Enhanced email analysis button handler updated');
    }
}

// Add this to your initialization code
document.addEventListener('DOMContentLoaded', function() {
    // Wait a bit for other initialization to complete
    setTimeout(() => {
        updateEmailAnalysisButtonHandler();
        debugLog('ü§ñ Enhanced email analysis system ready');
    }, 1000);
});

// ============================================
// BACKEND CONNECTION TESTING
// ============================================

/**
 * Test the backend email analysis endpoint
 */
async function testBackendEmailAnalysis() {
    try {
        debugLog('üß™ Testing backend email analysis endpoint');

        const response = await fetch(`${CONFIG.BACKEND_API_URL}/api/email/test`);
        const result = await response.json();

        if (response.ok) {
            debugLog('‚úÖ Backend email analysis test successful:', result);
            console.log('Backend Test Results:', result);
            return true;
        } else {
            debugLog('‚ùå Backend email analysis test failed:', result);
            console.log('Backend Test Failed:', result);
            return false;
        }
    } catch (error) {
        debugLog('‚ùå Backend email analysis test error:', error);
        console.log('Backend Test Error:', error);
        return false;
    }
}

// Make test function available globally
window.testBackendEmailAnalysis = testBackendEmailAnalysis;

debugLog('üöÄ Enhanced Email Analysis Frontend Module Loaded!');
debugLog('üß™ Use testBackendEmailAnalysis() to test the complete pipeline.');

// Display analysis results in the panel
function displayAnalysisResults(results) {
    console.log('üé® Displaying analysis results:', results);

    try {
        // Update overall score with Claude's actual result
        const overallScoreElement = document.getElementById('overallScore');
        const overallFeedbackElement = document.getElementById('overallFeedback');

        if (overallScoreElement) {
            overallScoreElement.textContent = results.overall_score || results.analysis?.overall_score || 5;
        }
        if (overallFeedbackElement) {
            overallFeedbackElement.textContent = results.overall_feedback || results.analysis?.overall_feedback || 'Analysis completed';
        }

        // Update DISC scores with Claude's actual scores
        const discScores = results.disc_scores || results.analysis?.disc_scores || {};
        const discFeedback = results.disc_feedback || results.analysis?.disc_feedback || {};

        Object.entries(discScores).forEach(([type, score]) => {
            const scoreElement = document.getElementById(`discScore${type}`);
            const feedbackElement = document.getElementById(`discFeedback${type}`);

            if (scoreElement) scoreElement.textContent = score;
            if (feedbackElement && discFeedback[type]) {
                feedbackElement.textContent = discFeedback[type];
            }
        });

        // Update suggestions with Claude's actual suggestions
        const suggestionsList = document.getElementById('suggestionsList');
        if (suggestionsList) {
            suggestionsList.innerHTML = '';
            const suggestions = results.suggestions || results.analysis?.suggestions || [];

            suggestions.forEach(suggestion => {
                const item = document.createElement('div');
                item.className = 'suggestion-item improvement';
                item.textContent = suggestion;
                suggestionsList.appendChild(item);
            });
        }

        // Update quick tips with Claude's actual tips
        const tipsList = document.getElementById('quickTipsList');
        if (tipsList) {
            tipsList.innerHTML = '';
            const tips = results.quick_tips || results.analysis?.quick_tips || [];

            tips.forEach(tip => {
                const item = document.createElement('div');
                item.className = 'tip-item';
                item.innerHTML = `
                    <div class="tip-icon">üí°</div>
                    <div class="tip-content">
                        <div class="tip-text">${tip}</div>
                    </div>
                `;
                tipsList.appendChild(item);
            });
        }

        // Show the analysis panel
        const analysisPanel = document.getElementById('analysisResultsPanel');
        const gettingStartedPanel = document.getElementById('gettingStartedPanel');

        if (gettingStartedPanel) gettingStartedPanel.style.display = 'none';
        if (analysisPanel) {
            analysisPanel.style.display = 'block';
            analysisPanel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        console.log('‚úÖ Claude analysis results properly displayed');

    } catch (error) {
        console.error('‚ùå Error displaying analysis results:', error);
    }
}

// Close analysis results panel
function closeAnalysisResults() {
    const analysisPanel = document.getElementById('analysisResultsPanel');
    const gettingStartedPanel = document.getElementById('gettingStartedPanel');

    if (analysisPanel) {
        analysisPanel.style.display = 'none';
    }

    if (gettingStartedPanel) {
        gettingStartedPanel.style.display = 'block';
    }

    emailState.analysisResults = null;
    debugLog('üìä Analysis results panel closed');
}

// Clear email composer
function clearEmailComposer() {
    if (confirm('Are you sure you want to clear the email? This cannot be undone.')) {
        document.getElementById('emailSubject').value = '';
        document.getElementById('emailContent').value = '';
        document.getElementById('emailRecipient').value = '';

        // Hide panels
        const colleaguePanel = document.getElementById('colleagueInfoPanel');
        const analysisPanel = document.getElementById('analysisResultsPanel');
        const gettingStartedPanel = document.getElementById('gettingStartedPanel');

        if (colleaguePanel) colleaguePanel.style.display = 'none';
        if (analysisPanel) analysisPanel.style.display = 'none';
        if (gettingStartedPanel) gettingStartedPanel.style.display = 'block';

        emailState.selectedColleague = null;
        emailState.analysisResults = null;

        debugLog('üìß Email composer cleared');
    }
}

// Save current email as template
function saveCurrentEmailAsTemplate() {
    const subject = document.getElementById('emailSubject').value.trim();
    const content = document.getElementById('emailContent').value.trim();

    if (!subject || !content) {
        showErrorMessage('Please enter both subject and content to save as template');
        return;
    }

    const templateTitle = prompt('Enter a name for this email template:', subject);
    if (!templateTitle) return;

    try {
        const template = {
            title: templateTitle,
            subject: subject,
            content: content,
            category: 'general',
            created: new Date().toISOString(),
            usage_count: 0
        };

        const templateId = saveEmailTemplateToStorage(template);

        showSuccessMessage(`Email template "${templateTitle}" saved successfully!`);
        updateEmailTabCount();
        debugLog('‚úÖ Email template saved:', templateTitle);

    } catch (error) {
        debugLog('‚ùå Error saving email template:', error);
        showErrorMessage('Failed to save email template. Please try again.');
    }
}

// Export analysis results
function exportAnalysisResults() {
    if (!emailState.analysisResults) {
        showErrorMessage('No analysis results to export');
        return;
    }

    try {
        const exportData = {
            email_subject: document.getElementById('emailSubject').value,
            recipient: emailState.selectedColleague?.name || 'Unknown',
            analysis_date: new Date().toISOString(),
            results: emailState.analysisResults
        };

        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });

        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `email_analysis_${new Date().toISOString().split('T')[0]}.json`;
        link.click();

        showSuccessMessage('Analysis results exported successfully!');
        debugLog('‚úÖ Analysis results exported');

    } catch (error) {
        debugLog('‚ùå Error exporting analysis results:', error);
        showErrorMessage('Failed to export analysis results.');
    }
}

// Apply email suggestions (placeholder)
//function applyEmailSuggestions() {
//    showSuccessMessage('Suggestion application feature coming soon!');
//    debugLog('üí° Apply suggestions clicked (feature pending)');
//}

// Storage functions for email templates
function loadEmailTemplates() {
    try {
        const stored = localStorage.getItem('conversation_trainer_email_templates');
        emailState.emailTemplates = stored ? JSON.parse(stored) : {};
        debugLog(`üìß Loaded ${Object.keys(emailState.emailTemplates).length} email templates`);
    } catch (error) {
        debugLog('‚ö†Ô∏è Error loading email templates:', error);
        emailState.emailTemplates = {};
    }
}

function saveEmailTemplateToStorage(templateData) {
    try {
        const templateId = `template_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        templateData.id = templateId;

        emailState.emailTemplates[templateId] = templateData;
        localStorage.setItem('conversation_trainer_email_templates', JSON.stringify(emailState.emailTemplates));

        debugLog('‚úÖ Email template saved to storage:', templateData.title);
        return templateId;
    } catch (error) {
        debugLog('‚ùå Error saving email template:', error);
        throw error;
    }
}

function loadEmailTemplatesUI() {
    // Placeholder for template UI loading
    debugLog('üìù Loading email templates UI (feature pending)');
}

function updateEmailTabCount() {
    const templateCount = Object.keys(emailState.emailTemplates).length;
    const emailTabCount = document.getElementById('emailTabCount');
    if (emailTabCount) {
        emailTabCount.textContent = templateCount;
    }
}

// Integration with existing app initialization
const originalInitializeTabs = initializeTabs;
initializeTabs = function() {
    originalInitializeTabs();

    // Initialize email module
    initializeEmailModule();

    // Enhance existing tab switching to handle email tab
    const originalSwitchToTab = switchToTab;
    switchToTab = function(tabId) {
        originalSwitchToTab(tabId);

        if (tabId === 'email-practice') {
            // Refresh colleague selectors when switching to email tab
            populateEmailColleagueSelectors();
        }
    };
};

// Refresh email colleague selectors when colleagues are updated
const originalSaveColleagueToStorage = saveColleagueToStorage;
saveColleagueToStorage = function(colleagueData) {
    const result = originalSaveColleagueToStorage(colleagueData);

    // Refresh email selectors if email module is active
    if (typeof populateEmailColleagueSelectors === 'function') {
        populateEmailColleagueSelectors();
    }

    return result;
};
// ============================================
// MISSING FUNCTIONS - Add this before your enhanced analysis code
// ============================================

function calculateDISCCompatibility(discScores, collegeDISC) {
    const typeWeights = {
        'D': { D: 1.0, I: 0.6, S: 0.4, C: 0.7 },
        'I': { D: 0.6, I: 1.0, S: 0.8, C: 0.5 },
        'S': { D: 0.4, I: 0.8, S: 1.0, C: 0.7 },
        'C': { D: 0.7, I: 0.5, S: 0.7, C: 1.0 }
    };

    const weights = typeWeights[collegeDISC] || typeWeights['I'];

    let totalCompatibility = 0;
    let totalWeight = 0;

    Object.entries(discScores).forEach(([type, score]) => {
        const weight = weights[type];
        totalCompatibility += score * weight;
        totalWeight += weight;
    });

    return Math.round((totalCompatibility / totalWeight) * 10) / 10;
}

function generateDISCRecommendations(discScores, colleague, collegeDISC) {
    const recommendations = {
        D: '',
        I: '',
        S: '',
        C: ''
    };

    // Generate recommendations based on scores and colleague type
    if (discScores.D < 7 && collegeDISC === 'D') {
        recommendations.D = 'Be more direct and action-oriented';
    } else {
        recommendations.D = discScores.D >= 7 ? 'Good directness level' : 'Consider being more decisive';
    }

    if (discScores.I < 7 && collegeDISC === 'I') {
        recommendations.I = 'Add more collaborative and engaging language';
    } else {
        recommendations.I = discScores.I >= 7 ? 'Great engaging tone' : 'Could be more interactive';
    }

    if (discScores.S < 7 && collegeDISC === 'S') {
        recommendations.S = 'Use more supportive and respectful language';
    } else {
        recommendations.S = discScores.S >= 7 ? 'Respectful and supportive' : 'Consider a gentler approach';
    }

    if (discScores.C < 7 && collegeDISC === 'C') {
        recommendations.C = 'Include more specific details and data';
    } else {
        recommendations.C = discScores.C >= 7 ? 'Good level of detail' : 'Add more supporting information';
    }

    return recommendations;
}

function analyzeProfessionalTone(content, subject) {
    // Simple professional tone analysis
    const professionalWords = ['please', 'thank you', 'regards', 'sincerely', 'appreciate', 'professional'];
    const casualWords = ['hey', 'hi there', 'thanks!', 'cheers', 'cool', 'awesome'];

    const contentLower = content.toLowerCase();
    const professionalCount = professionalWords.filter(word => contentLower.includes(word)).length;
    const casualCount = casualWords.filter(word => contentLower.includes(word)).length;

    let score = 7; // Base professional score
    score += professionalCount * 0.5;
    score -= casualCount * 0.8;

    return Math.max(1, Math.min(10, Math.round(score * 10) / 10));
}
// ============================================
// ENHANCED EMAIL ANALYSIS SYSTEM
// Add this to your existing JavaScript in index.html
// ============================================

// Enhanced analysis algorithm - replace your existing generateMockAnalysis function
function generateAdvancedEmailAnalysis(content, subject, colleague) {
    debugLog('üîç Running advanced email analysis');

    const analysis = {
        content: content,
        subject: subject,
        colleague: colleague,
        metrics: analyzeWritingMetrics(content, subject),
        discAnalysis: analyzeForDISC(content, colleague),
        suggestions: generateSmartSuggestions(content, subject, colleague),
        improvements: generateImprovements(content, colleague),
        professionalScore: analyzeProfessionalTone(content, subject)
    };

    return analysis;
}

// ============================================
// WRITING METRICS ANALYSIS
// ============================================
function analyzeWritingMetrics(content, subject) {
    const words = content.split(/\s+/).filter(word => word.length > 0);
    const sentences = content.split(/[.!?]+/).filter(s => s.trim().length > 0);
    const avgWordsPerSentence = words.length / sentences.length;

    // Readability analysis (simple Flesch reading ease approximation)
    const avgSentenceLength = avgWordsPerSentence;
    const readabilityScore = Math.max(0, Math.min(100,
        206.835 - (1.015 * avgSentenceLength) - (84.6 * (getSyllableCount(content) / words.length))
    ));

    // Professional language check
    const casualWords = ['hey', 'hi', 'thanks!', 'cheers', 'cool', 'awesome', 'yeah'];
    const formalWords = ['please', 'thank you', 'regards', 'sincerely', 'appreciate'];
    const casualCount = casualWords.filter(word => content.toLowerCase().includes(word)).length;
    const formalCount = formalWords.filter(word => content.toLowerCase().includes(word)).length;

    // Action clarity
    const actionWords = ['please', 'could you', 'would you', 'by', 'deadline', 'urgent', 'asap'];
    const hasDeadline = /\b(by|before|until|deadline)\b/i.test(content);
    const hasCallToAction = actionWords.some(word => content.toLowerCase().includes(word));

    return {
        wordCount: words.length,
        sentenceCount: sentences.length,
        avgSentenceLength: Math.round(avgSentenceLength * 10) / 10,
        readabilityScore: Math.round(readabilityScore),
        readabilityLevel: getReadabilityLevel(readabilityScore),
        professionalTone: calculateProfessionalTone(casualCount, formalCount),
        actionClarity: calculateActionClarity(hasDeadline, hasCallToAction),
        subjectEffectiveness: analyzeSubject(subject)
    };
}

function getSyllableCount(text) {
    // Simple syllable counting (not perfect but good enough)
    return text.toLowerCase().match(/[aeiouy]+/g)?.length || 1;
}

function getReadabilityLevel(score) {
    if (score >= 80) return 'Very Easy';
    if (score >= 70) return 'Easy';
    if (score >= 60) return 'Standard';
    if (score >= 50) return 'Somewhat Difficult';
    if (score >= 30) return 'Difficult';
    return 'Very Difficult';
}

function calculateProfessionalTone(casualCount, formalCount) {
    const total = casualCount + formalCount;
    if (total === 0) return { score: 7, level: 'Neutral', advice: 'Consider adding more engaging language' };

    const formalRatio = formalCount / total;
    if (formalRatio > 0.7) return { score: 9, level: 'Very Professional', advice: 'Excellent professional tone' };
    if (formalRatio > 0.4) return { score: 8, level: 'Professional', advice: 'Good balance of professional language' };
    if (formalRatio > 0.2) return { score: 6, level: 'Semi-Professional', advice: 'Could be more formal for council communication' };
    return { score: 4, level: 'Too Casual', advice: 'Use more professional language for workplace emails' };
}

function calculateActionClarity(hasDeadline, hasCallToAction) {
    if (hasDeadline && hasCallToAction) return { score: 9, level: 'Very Clear', advice: 'Excellent action clarity' };
    if (hasCallToAction) return { score: 7, level: 'Clear', advice: 'Consider adding specific deadlines' };
    if (hasDeadline) return { score: 6, level: 'Somewhat Clear', advice: 'Add clearer action requests' };
    return { score: 4, level: 'Unclear', advice: 'Add specific actions and deadlines' };
}

function analyzeSubject(subject) {
    if (!subject || subject.length < 3) {
        return { score: 2, advice: 'Add a descriptive subject line' };
    }
    if (subject.length > 50) {
        return { score: 6, advice: 'Subject line is quite long - consider shortening' };
    }
    if (/\b(urgent|asap|important)\b/i.test(subject)) {
        return { score: 7, advice: 'Good use of priority indicators' };
    }
    if (subject.includes('?')) {
        return { score: 8, advice: 'Question format is engaging' };
    }
    return { score: 7, advice: 'Subject line looks good' };
}

// ============================================
// ENHANCED DISC ANALYSIS
// ============================================
function analyzeForDISC(content, colleague) {
    const collegeDISC = inferDISCType(colleague.personality || '');
    const contentStyle = analyzeContentStyle(content);

    const discScores = {
        D: calculateDScore(content, contentStyle, collegeDISC),
        I: calculateIScore(content, contentStyle, collegeDISC),
        S: calculateSScore(content, contentStyle, collegeDISC),
        C: calculateCScore(content, contentStyle, collegeDISC)
    };

    const compatibility = calculateDISCCompatibility(discScores, collegeDISC);

    return {
        scores: discScores,
        compatibility: compatibility,
        colleagueDISC: collegeDISC,
        recommendations: generateDISCRecommendations(discScores, colleague, collegeDISC)
    };
}

function analyzeContentStyle(content) {
    const directWords = ['need', 'must', 'require', 'immediately', 'deadline'];
    const socialWords = ['team', 'together', 'collaborate', 'excited', 'great'];
    const supportWords = ['help', 'support', 'comfortable', 'gradual', 'step'];
    const analyticalWords = ['data', 'analysis', 'details', 'specific', 'accurate'];

    return {
        directness: directWords.filter(word => content.toLowerCase().includes(word)).length,
        sociability: socialWords.filter(word => content.toLowerCase().includes(word)).length,
        supportiveness: supportWords.filter(word => content.toLowerCase().includes(word)).length,
        analytical: analyticalWords.filter(word => content.toLowerCase().includes(word)).length
    };
}

function calculateDScore(content, style, collegeDISC) {
    let score = 5; // Base score
    score += style.directness * 0.8;
    score += content.includes('!') ? 1 : 0;
    score += /\b(now|urgent|asap)\b/i.test(content) ? 1 : 0;

    // Adjust for colleague's DISC type
    if (collegeDISC === 'D') score += 1;
    if (collegeDISC === 'S') score -= 0.5; // Too direct for S-types

    return Math.min(10, Math.max(1, Math.round(score * 10) / 10));
}

function calculateIScore(content, style, collegeDISC) {
    let score = 5;
    score += style.sociability * 1.2;
    score += /\b(we|us|team|together)\b/i.test(content) ? 1.5 : 0;
    score += content.includes('excited') || content.includes('looking forward') ? 1 : 0;

    if (collegeDISC === 'I') score += 1.5;
    if (collegeDISC === 'C') score -= 0.5; // Too social for C-types

    return Math.min(10, Math.max(1, Math.round(score * 10) / 10));
}

function calculateSScore(content, style, collegeDISC) {
    let score = 5;
    score += style.supportiveness * 1.0;
    score += /\b(please|thank|appreciate|comfortable)\b/i.test(content) ? 1.5 : 0;
    score += content.includes('when convenient') || content.includes('no rush') ? 1 : 0;

    if (collegeDISC === 'S') score += 1.5;
    if (collegeDISC === 'D') score -= 0.5; // Too gentle for D-types

    return Math.min(10, Math.max(1, Math.round(score * 10) / 10));
}

function calculateCScore(content, style, collegeDISC) {
    let score = 5;
    score += style.analytical * 1.0;
    score += /\b(data|analysis|report|details|specific)\b/i.test(content) ? 1.5 : 0;
    score += content.includes('attached') || content.includes('documentation') ? 1 : 0;

    if (collegeDISC === 'C') score += 1.5;
    if (collegeDISC === 'I') score -= 0.5; // Too analytical for I-types

    return Math.min(10, Math.max(1, Math.round(score * 10) / 10));
}

// ============================================
// SMART SUGGESTIONS GENERATOR
// ============================================
function generateSmartSuggestions(content, subject, colleague) {
    const suggestions = [];
    const metrics = analyzeWritingMetrics(content, subject);
    const collegeDISC = inferDISCType(colleague.personality || '');

    // Subject line suggestions
    if (!subject || subject.length < 5) {
        suggestions.push({
            type: 'critical',
            category: 'Subject Line',
            text: 'Add a clear, descriptive subject line',
            impact: 'High',
            reason: 'Subject lines help recipients prioritize and find emails later'
        });
    }

    // Readability suggestions
    if (metrics.avgSentenceLength > 20) {
        suggestions.push({
            type: 'improvement',
            category: 'Readability',
            text: 'Break up long sentences for better clarity',
            impact: 'Medium',
            reason: 'Shorter sentences are easier to understand and act upon'
        });
    }

    // DISC-specific suggestions
    const discSuggestions = generateDISCSpecificSuggestions(content, colleague, collegeDISC);
    suggestions.push(...discSuggestions);

    // Professional tone suggestions
    if (metrics.professionalTone.score < 6) {
        suggestions.push({
            type: 'improvement',
            category: 'Professional Tone',
            text: metrics.professionalTone.advice,
            impact: 'Medium',
            reason: 'Professional language builds credibility in council communications'
        });
    }

    // Action clarity suggestions
    if (metrics.actionClarity.score < 7) {
        suggestions.push({
            type: 'improvement',
            category: 'Action Clarity',
            text: metrics.actionClarity.advice,
            impact: 'High',
            reason: 'Clear actions and deadlines prevent confusion and delays'
        });
    }

    return suggestions;
}

function generateDISCSpecificSuggestions(content, colleague, discType) {
    const suggestions = [];
    const roleSuggestions = getRoleBasedSuggestions(colleague.role, discType);

    switch (discType) {
        case 'D':
            if (!content.includes('deadline') && !content.includes('by')) {
                suggestions.push({
                    type: 'disc',
                    category: 'DISC - Dominance',
                    text: `Add clear deadlines - ${colleague.name} appreciates direct timelines`,
                    impact: 'High',
                    reason: 'D-types prefer action-oriented communication with specific outcomes'
                });
            }
            break;

        case 'I':
            if (!/\b(we|team|collaboration)\b/i.test(content)) {
                suggestions.push({
                    type: 'disc',
                    category: 'DISC - Influence',
                    text: `Use collaborative language - try "we" or "team" to engage ${colleague.name}`,
                    impact: 'Medium',
                    reason: 'I-types respond well to inclusive, relationship-focused communication'
                });
            }
            break;

        case 'S':
            if (!content.includes('please') && !content.includes('appreciate')) {
                suggestions.push({
                    type: 'disc',
                    category: 'DISC - Steadiness',
                    text: `Add supportive language like "please" or "I appreciate" for ${colleague.name}`,
                    impact: 'Medium',
                    reason: 'S-types value respectful, considerate communication'
                });
            }
            break;

        case 'C':
            if (!/\b(data|details|analysis|specific)\b/i.test(content)) {
                suggestions.push({
                    type: 'disc',
                    category: 'DISC - Conscientiousness',
                    text: `Include specific details or data - ${colleague.name} values accuracy`,
                    impact: 'High',
                    reason: 'C-types prefer factual, detailed information for decision-making'
                });
            }
            break;
    }

    // Add role-specific suggestions
    if (roleSuggestions) {
        suggestions.push(...roleSuggestions);
    }

    return suggestions;
}

function getRoleBasedSuggestions(role, discType) {
    const roleMap = {
        'Business Analyst': [
            {
                type: 'role',
                category: 'Role-Specific',
                text: 'Reference data or analysis when possible - aligns with their analytical focus',
                impact: 'Medium',
                reason: 'Business analysts appreciate evidence-based communication'
            }
        ],
        'Community Engagement Officer': [
            {
                type: 'role',
                category: 'Role-Specific',
                text: 'Consider mentioning community impact or stakeholder benefits',
                impact: 'Medium',
                reason: 'Community officers focus on public value and engagement'
            }
        ],
        'Senior Engineer': [
            {
                type: 'role',
                category: 'Role-Specific',
                text: 'Include technical specifications or implementation details if relevant',
                impact: 'Medium',
                reason: 'Engineers need technical context for effective collaboration'
            }
        ]
    };

    return roleMap[role] || [];
}

// ============================================
// IMPROVEMENT GENERATOR
// ============================================
function generateImprovements(content, colleague) {
    const improvements = [];
    const discType = inferDISCType(colleague.personality || '');

    // Generate improved versions of key phrases
    const improvements_map = {
        'D': {
            'let me know': 'please confirm by [date]',
            'when you can': 'by [specific date]',
            'if possible': 'required for project completion'
        },
        'I': {
            'I need': 'we could really benefit from',
            'you should': 'what do you think about',
            'this is important': 'this would help our team succeed'
        },
        'S': {
            'I need this now': 'when you have a moment, could you please help with',
            'you must': 'would you be comfortable with',
            'immediately': 'at your earliest convenience'
        },
        'C': {
            'this should work': 'based on the analysis, this approach would',
            'I think': 'the data suggests',
            'probably': 'according to our specifications'
        }
    };

    // Find phrases that could be improved
    const typeImprovements = improvements_map[discType] || {};
    Object.keys(typeImprovements).forEach(phrase => {
        if (content.toLowerCase().includes(phrase.toLowerCase())) {
            improvements.push({
                original: phrase,
                improved: typeImprovements[phrase],
                reason: `Better matches ${colleague.name}'s ${discType}-type communication style`
            });
        }
    });

    return improvements;
}

// ============================================
// REPLACE EXISTING ANALYSIS FUNCTION
// ============================================

// Replace your existing analyzeEmail function with this enhanced version
async function analyzeEmailEnhanced() {
    const recipientId = document.getElementById('emailRecipient').value;
    const subject = document.getElementById('emailSubject').value.trim();
    const content = document.getElementById('emailContent').value.trim();

    // Validation
    if (!content) {
        showErrorMessage('Please enter email content to analyze');
        return;
    }

    if (!recipientId) {
        showErrorMessage('Please select a recipient for targeted analysis');
        return;
    }

    if (emailState.isAnalyzing) {
        debugLog('‚ö†Ô∏è Analysis already in progress');
        return;
    }

    try {
        emailState.isAnalyzing = true;
        debugLog('üìä Starting enhanced email analysis');

        // Show loading state
        const analyzeBtn = document.getElementById('analyzeEmailBtn');
        const originalText = analyzeBtn.innerHTML;
        analyzeBtn.innerHTML = '‚è≥ Analyzing...';
        analyzeBtn.disabled = true;

        // Hide getting started panel
        const gettingStartedPanel = document.getElementById('gettingStartedPanel');
        if (gettingStartedPanel) {
            gettingStartedPanel.style.display = 'none';
        }

        // Simulate API call delay
        await new Promise(resolve => setTimeout(resolve, 2500));

        // Run enhanced analysis
        const analysisResults = generateAdvancedEmailAnalysis(content, subject, emailState.selectedColleague);

        // Display enhanced results
        displayEnhancedAnalysisResults(analysisResults);

        // Store results
        emailState.analysisResults = analysisResults;

        debugLog('‚úÖ Enhanced email analysis completed');
        showSuccessMessage('Email analysis completed with enhanced insights!');

    } catch (error) {
        debugLog('‚ùå Email analysis error:', error);
        showErrorMessage('Email analysis failed. Please try again.');
    } finally {
        // Restore button
        emailState.isAnalyzing = false;
        const analyzeBtn = document.getElementById('analyzeEmailBtn');
        analyzeBtn.innerHTML = 'üìä Analyze Email';
        analyzeBtn.disabled = false;
    }
}
// ============================================
// ENHANCED EMAIL ANALYSIS WITH BACKEND INTEGRATION
// Add this function to your index.html
// ============================================

async function analyzeEmailEnhanced() {
    console.log('üöÄ ENHANCED FUNCTION CALLED - USING BACKEND CLAUDE API!');

    const recipientId = document.getElementById('emailRecipient').value;
    const subject = document.getElementById('emailSubject').value.trim();
    const content = document.getElementById('emailContent').value.trim();

    // Validation
    if (!content) {
        showErrorMessage('Please enter email content to analyze');
        return;
    }

    if (emailState.isAnalyzing) {
        debugLog('‚ö†Ô∏è Analysis already in progress');
        return;
    }

    try {
        emailState.isAnalyzing = true;
        debugLog('ü§ñ Starting enhanced email analysis with Claude API via backend');

        // Show loading state
        const analyzeBtn = document.getElementById('analyzeEmailBtn');
        const originalText = analyzeBtn.innerHTML;
        analyzeBtn.innerHTML = '‚è≥ Analyzing with AI...';
        analyzeBtn.disabled = true;

        // Hide getting started panel
        const gettingStartedPanel = document.getElementById('gettingStartedPanel');
        if (gettingStartedPanel) {
            gettingStartedPanel.style.display = 'none';
        }

        // Prepare email data for backend
        const emailData = {
            subject: subject,
            content: content,
            colleague: emailState.selectedColleague,
            analysis_type: emailState.analysisType || 'outgoing',
            context: 'NSW Local Government workplace communication'
        };

        debugLog('üì§ Sending email data to backend:', emailData);

        // Call backend API for analysis (using your existing API_BASE_URL)
        const response = await fetch(`${API_BASE_URL}/api/email/analyze`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(emailData)
        });

        debugLog('üì• Backend response status:', response.status);

        if (!response.ok) {
            const errorData = await response.text();
            debugLog('‚ùå Backend error response:', errorData);
            throw new Error(`Backend analysis failed (${response.status}): ${errorData}`);
        }

        const analysisResults = await response.json();
        debugLog('‚úÖ Backend analysis results:', analysisResults);

        // Convert backend format to frontend format if needed
        const formattedResults = formatBackendAnalysisForUI(analysisResults);

        // Display results using your existing displayAnalysisResults function
        displayAnalysisResults(formattedResults);

        // Store results
        emailState.analysisResults = formattedResults;

        debugLog('‚úÖ Enhanced email analysis completed successfully');
        showSuccessMessage(
            `Email analysis completed! ${analysisResults.claude_powered !== false ?
                'Powered by Claude AI for professional insights.' :
                'Using enhanced pattern analysis.'}`
        );

    } catch (error) {
        debugLog('‚ùå Enhanced email analysis error:', error);

        // Fallback to basic analysis if backend fails
        try {
            debugLog('üîÑ Attempting frontend fallback analysis');
            const fallbackResults = generateBasicFallbackAnalysis(emailData);
            displayAnalysisResults(fallbackResults);
            emailState.analysisResults = fallbackResults;
            showSuccessMessage('Analysis completed using basic pattern matching (backend unavailable).');
        } catch (fallbackError) {
            debugLog('‚ùå Fallback analysis also failed:', fallbackError);
            showErrorMessage('Email analysis failed. Please try again.');
        }

    } finally {
        // Restore button state
        emailState.isAnalyzing = false;
        const analyzeBtn = document.getElementById('analyzeEmailBtn');
        if (analyzeBtn) {
            analyzeBtn.innerHTML = 'üìä Analyze Email';
            analyzeBtn.disabled = false;
        }
    }
}

// Format backend analysis results for your existing UI
function formatBackendAnalysisForUI(backendResults) {
    // If already in correct format, return as-is
    if (backendResults.overall_score !== undefined && backendResults.disc_scores !== undefined) {
        return backendResults;
    }

    // Convert backend format to match your existing displayAnalysisResults function
    return {
        overall_score: backendResults.overall_score || 5,
        overall_feedback: backendResults.overall_feedback || 'Analysis completed',

        // Convert code compliance to format expected by UI
        code_compliance: backendResults.code_compliance || {
            status: 'compliant',
            issues: [],
            risk_level: 'low'
        },

        // Create DISC scores (your backend should provide these)
        disc_scores: backendResults.disc_scores || {
            D: backendResults.overall_score || 6,
            I: backendResults.overall_score || 6,
            S: backendResults.overall_score || 6,
            C: backendResults.overall_score || 6
        },

        // Create DISC feedback
        disc_feedback: backendResults.disc_feedback || {
            D: 'Analysis completed with Claude AI',
            I: 'Analysis completed with Claude AI',
            S: 'Analysis completed with Claude AI',
            C: 'Analysis completed with Claude AI'
        },

        suggestions: backendResults.suggestions || [],
        strengths: backendResults.strengths || [],
        quick_tips: backendResults.quick_tips || [
            `Professional communication analysis completed`,
            'Review feedback for improvement opportunities'
        ],

        analysis_timestamp: backendResults.analysis_timestamp || new Date().toISOString(),
        analysis_type: backendResults.analysis_type || 'outgoing',
        claude_powered: backendResults.claude_powered !== false
    };
}

// Basic fallback analysis for when backend is completely unavailable
function generateBasicFallbackAnalysis(emailData) {
    const content = emailData.content || '';

    // Check for problematic patterns - CODE OF CONDUCT VIOLATIONS
    const problematicPatterns = [
        /\b(stupid|idiot|moron|pathetic|ridiculous)\b/i,
        /\b(just do it|just approve|just fix)\b/i,
        /[A-Z]{4,}/g, // ALL CAPS
        /!{3,}/g // Multiple exclamation marks
    ];

    const hasProblems = problematicPatterns.some(pattern => pattern.test(content));

    // Basic professional structure checks
    const hasGreeting = /\b(hi|hello|dear|good morning|good afternoon)\b/i.test(content);
    const hasClosing = /\b(regards|thanks|sincerely|best|cheers)\b/i.test(content);
    const hasPoliteness = /\b(please|thank you|would you|could you)\b/i.test(content);

    // Calculate score with heavy penalty for CODE OF CONDUCT violations
    let score = 5;
    if (hasGreeting) score += 0.5;
    if (hasClosing) score += 0.5;
    if (hasPoliteness) score += 1;
    if (hasProblems) score -= 4; // HEAVY PENALTY for inappropriate language

    score = Math.max(1, Math.min(10, score));

    const suggestions = [];
    if (hasProblems) {
        suggestions.push({
            type: 'critical',
            text: 'CODE OF CONDUCT VIOLATION: This email contains inappropriate language that violates Lake Macquarie Council professional communication standards and must be revised before sending'
        });
    }

    if (!hasGreeting) {
        suggestions.push({
            type: 'improvement',
            text: 'Consider adding a professional greeting'
        });
    }

    if (!hasClosing) {
        suggestions.push({
            type: 'improvement',
            text: 'Add a professional closing'
        });
    }

    return {
        overall_score: Math.round(score * 10) / 10,
        overall_feedback: hasProblems ?
            'CODE OF CONDUCT VIOLATION: This email contains inappropriate language that violates Lake Macquarie Council professional communication standards.' :
            'Basic structure analysis completed. For detailed professional insights, Claude AI analysis is recommended.',

        disc_scores: {
            D: score,
            I: score,
            S: score,
            C: score
        },

        disc_feedback: {
            D: hasProblems ? 'Inappropriate demanding language violates professional standards' : 'Basic assessment completed',
            I: hasProblems ? 'Language not suitable for collaborative workplace relationships' : 'Basic assessment completed',
            S: hasProblems ? 'Disrespectful tone inappropriate for supportive work environment' : 'Basic assessment completed',
            C: hasProblems ? 'Unprofessional language violates quality communication standards' : 'Basic assessment completed'
        },

        suggestions: suggestions,

        quick_tips: hasProblems ? [
            'Review Lake Macquarie Council Code of Conduct for professional communication standards',
            'Use respectful, professional language in all workplace communications',
            'Consider if this message is necessary and appropriate before sending'
        ] : [
            'Email structure appears reasonable',
            'For detailed professional communication analysis, ensure backend is available'
        ],

        analysis_timestamp: new Date().toISOString(),
        claude_powered: false,
        fallback_analysis: true
    };
}

// ============================================
// UPDATE BUTTON TO USE NEW FUNCTION
// ============================================

// Force the analyze button to use the enhanced function
// Add this at the end of your JavaScript section
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        const btn = document.getElementById('analyzeEmailBtn');
        if (btn) {
            console.log('üîß Updating analyze button to use enhanced function');

            // Remove all existing event listeners by cloning the button
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);

            // Add new event listener for enhanced function
            document.getElementById('analyzeEmailBtn').addEventListener('click', analyzeEmailEnhanced);

            console.log('‚úÖ Button now uses analyzeEmailEnhanced with Claude backend!');
        } else {
            console.log('‚ùå Analyze button not found');
        }
    }, 2000); // Wait 2 seconds for page to fully load
});

// Update the existing analyze button to use the enhanced function
function updateAnalyzeButtonHandler() {
    const analyzeBtn = document.getElementById('analyzeEmailBtn');
    if (analyzeBtn) {
        // Remove old event listener and add new one
        analyzeBtn.removeEventListener('click', analyzeEmail);
        analyzeBtn.addEventListener('click', analyzeEmailEnhanced);
        debugLog('‚úÖ Updated analyze button to use enhanced analysis');
    }
}

// Call this after the page loads to update the button
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(updateAnalyzeButtonHandler, 1000);
});
// ============================================
// ENHANCED ANALYSIS DISPLAY SYSTEM
// Add this to your existing JavaScript after the enhanced analysis
// ============================================

// Enhanced display function - replaces displayAnalysisResults
function displayEnhancedAnalysisResults(analysis) {
    try {
        debugLog('üé® Displaying enhanced analysis results');

        // Calculate overall score from multiple metrics
        const overallScore = calculateOverallScore(analysis);

        // Update overall score section
        updateOverallScoreSection(overallScore, analysis);

        // Update DISC compatibility section
        updateDISCSection(analysis.discAnalysis);

        // Update suggestions with enhanced categories
        updateSuggestionsSection(analysis.suggestions);

        // Add new metrics section
        addMetricsSection(analysis.metrics);

        // Update quick tips with role-specific advice
        updateQuickTipsSection(analysis);

        // Show the analysis panel
        const analysisPanel = document.getElementById('analysisResultsPanel');
        if (analysisPanel) {
            analysisPanel.style.display = 'block';
            analysisPanel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        debugLog('‚úÖ Enhanced analysis results displayed');
    } catch (error) {
        debugLog('‚ùå Error displaying enhanced analysis results:', error);
    }
}

function calculateOverallScore(analysis) {
    const weights = {
        disc: 0.3,        // 30% - DISC compatibility
        readability: 0.2,  // 20% - How easy to read
        professional: 0.2, // 20% - Professional tone
        actionClarity: 0.2, // 20% - Clear actions
        subjectLine: 0.1   // 10% - Subject effectiveness
    };

    const discAverage = (analysis.discAnalysis.scores.D + analysis.discAnalysis.scores.I +
                        analysis.discAnalysis.scores.S + analysis.discAnalysis.scores.C) / 4;

    const readabilityScore = Math.min(10, analysis.metrics.readabilityScore / 10);
    const professionalScore = analysis.metrics.professionalTone.score;
    const actionScore = analysis.metrics.actionClarity.score;
    const subjectScore = analysis.metrics.subjectEffectiveness.score;

    const totalScore = (discAverage * weights.disc) +
                      (readabilityScore * weights.readability) +
                      (professionalScore * weights.professional) +
                      (actionScore * weights.actionClarity) +
                      (subjectScore * weights.subjectLine);

    return {
        score: Math.round(totalScore * 10) / 10,
        breakdown: {
            disc: Math.round(discAverage * 10) / 10,
            readability: Math.round(readabilityScore * 10) / 10,
            professional: professionalScore,
            actionClarity: actionScore,
            subject: subjectScore
        }
    };
}

function updateOverallScoreSection(overallScore, analysis) {
    const scoreElement = document.getElementById('overallScore');
    const feedbackElement = document.getElementById('overallFeedback');

    if (scoreElement) scoreElement.textContent = overallScore.score;

    if (feedbackElement) {
        let feedback = '';
        if (overallScore.score >= 8.5) {
            feedback = `Excellent email for ${analysis.colleague.name}! Your communication style aligns well with their preferences.`;
        } else if (overallScore.score >= 7) {
            feedback = `Good communication approach. A few tweaks could make this even more effective for ${analysis.colleague.name}.`;
        } else if (overallScore.score >= 6) {
            feedback = `Solid foundation. Consider the suggestions below to better match ${analysis.colleague.name}'s communication style.`;
        } else {
            feedback = `This email could be significantly improved for better impact with ${analysis.colleague.name}.`;
        }
        feedbackElement.textContent = feedback;
    }

    // Update score circle color based on score
    const scoreCircle = document.querySelector('.score-circle');
    if (scoreCircle) {
        scoreCircle.className = 'score-circle';
        if (overallScore.score >= 8) scoreCircle.classList.add('score-excellent');
        else if (overallScore.score >= 7) scoreCircle.classList.add('score-good');
        else if (overallScore.score >= 6) scoreCircle.classList.add('score-fair');
        else scoreCircle.classList.add('score-needs-work');
    }
}

function updateDISCSection(discAnalysis) {
    // Update DISC scores
    Object.entries(discAnalysis.scores).forEach(([type, score]) => {
        const scoreElement = document.getElementById(`discScore${type}`);
        const feedbackElement = document.getElementById(`discFeedback${type}`);

        if (scoreElement) scoreElement.textContent = score;
        if (feedbackElement && discAnalysis.recommendations[type]) {
            feedbackElement.textContent = discAnalysis.recommendations[type];
        }
    });
}

function updateSuggestionsSection(suggestions) {
    const suggestionsList = document.getElementById('suggestionsList');
    if (!suggestionsList) return;

    suggestionsList.innerHTML = '';

    // Group suggestions by category
    const grouped = suggestions.reduce((acc, suggestion) => {
        const category = suggestion.category || 'General';
        if (!acc[category]) acc[category] = [];
        acc[category].push(suggestion);
        return acc;
    }, {});

    // Display grouped suggestions
    Object.entries(grouped).forEach(([category, categoryItems]) => {
        const categoryHeader = document.createElement('div');
        categoryHeader.className = 'suggestion-category-header';
        categoryHeader.innerHTML = `<strong>${category}</strong>`;
        suggestionsList.appendChild(categoryHeader);

        categoryItems.forEach(suggestion => {
            const item = document.createElement('div');
            item.className = `suggestion-item ${suggestion.type}`;

            const impactBadge = getImpactBadge(suggestion.impact);

            item.innerHTML = `
                <div class="suggestion-content">
                    <div class="suggestion-text">${suggestion.text}</div>
                    <div class="suggestion-reason">${suggestion.reason}</div>
                </div>
                <div class="suggestion-meta">
                    ${impactBadge}
                </div>
            `;

            suggestionsList.appendChild(item);
        });
    });
}

function getImpactBadge(impact) {
    const badges = {
        'High': '<span class="impact-badge high">High Impact</span>',
        'Medium': '<span class="impact-badge medium">Medium Impact</span>',
        'Low': '<span class="impact-badge low">Low Impact</span>'
    };
    return badges[impact] || '';
}

function addMetricsSection(metrics) {
    // Find the suggestions section
    const suggestionsSection = document.querySelector('.suggestions-section');
    if (!suggestionsSection) return;

    // Remove any existing metrics section
    const existingMetrics = document.getElementById('metricsSection');
    if (existingMetrics) existingMetrics.remove();

    // Create new metrics section
    const metricsSection = document.createElement('div');
    metricsSection.id = 'metricsSection';
    metricsSection.className = 'metrics-section';
    metricsSection.innerHTML = `
        <h5>üìä Writing Metrics</h5>
        <div class="metrics-grid">
            <div class="metric-item">
                <div class="metric-value">${metrics.readabilityScore}</div>
                <div class="metric-label">Readability Score</div>
                <div class="metric-sublabel">(${metrics.readabilityLevel})</div>
            </div>
            <div class="metric-item">
                <div class="metric-value">${metrics.wordCount}</div>
                <div class="metric-label">Word Count</div>
                <div class="metric-sublabel">${getWordCountAdvice(metrics.wordCount)}</div>
            </div>
            <div class="metric-item">
                <div class="metric-value">${metrics.professionalTone.score}/10</div>
                <div class="metric-label">Professional Tone</div>
                <div class="metric-sublabel">${metrics.professionalTone.level}</div>
            </div>
            <div class="metric-item">
                <div class="metric-value">${metrics.actionClarity.score}/10</div>
                <div class="metric-label">Action Clarity</div>
                <div class="metric-sublabel">${metrics.actionClarity.level}</div>
            </div>
        </div>
    `;

    // Insert before suggestions section
    suggestionsSection.parentNode.insertBefore(metricsSection, suggestionsSection);
}

function getWordCountAdvice(wordCount) {
    if (wordCount < 50) return 'Very Brief';
    if (wordCount < 150) return 'Concise';
    if (wordCount < 300) return 'Appropriate';
    if (wordCount < 500) return 'Detailed';
    return 'Very Long';
}

function updateQuickTipsSection(analysis) {
    const tipsList = document.getElementById('quickTipsList');
    if (!tipsList) return;

    tipsList.innerHTML = '';

    const tips = generateRoleSpecificTips(analysis.colleague, analysis.discAnalysis.colleagueDISC);

    tips.forEach(tip => {
        const item = document.createElement('div');
        item.className = 'tip-item';
        item.innerHTML = `
            <div class="tip-icon">${tip.icon}</div>
            <div class="tip-content">
                <div class="tip-text">${tip.text}</div>
                <div class="tip-detail">${tip.detail}</div>
            </div>
        `;
        tipsList.appendChild(item);
    });
}

function generateRoleSpecificTips(colleague, discType) {
    const baseTips = {
        'D': {
            icon: 'üéØ',
            text: 'Be direct and results-focused',
            detail: 'D-types appreciate concise communication with clear outcomes'
        },
        'I': {
            icon: 'ü§ù',
            text: 'Use collaborative and engaging language',
            detail: 'I-types respond well to enthusiasm and team-oriented messaging'
        },
        'S': {
            icon: 'üõ°Ô∏è',
            text: 'Be respectful and provide context',
            detail: 'S-types value relationship-building and gradual changes'
        },
        'C': {
            icon: 'üìä',
            text: 'Include facts, data, and specific details',
            detail: 'C-types need accurate information to make informed decisions'
        }
    };

    const tips = [baseTips[discType] || baseTips['I']];

    // Add role-specific tips
    const roleTips = {
        'Business Analyst': {
            icon: 'üìà',
            text: 'Reference data and analytical insights when possible',
            detail: 'Business analysts appreciate evidence-based communication'
        },
        'Community Engagement Officer': {
            icon: 'üèòÔ∏è',
            text: 'Consider mentioning community or stakeholder benefits',
            detail: 'Community officers focus on public value and engagement outcomes'
        },
        'Senior Engineer': {
            icon: '‚öôÔ∏è',
            text: 'Include technical context and implementation details',
            detail: 'Engineers need sufficient technical information for effective collaboration'
        }
    };

    if (roleTips[colleague.role]) {
        tips.push(roleTips[colleague.role]);
    }

    // Add timing tip
    tips.push({
        icon: '‚è∞',
        text: `${colleague.name} typically responds within 24-48 hours`,
        detail: 'Based on typical council communication patterns'
    });

    return tips;
}

// ============================================
// APPLY SUGGESTIONS FUNCTIONALITY
// ============================================

function setupApplySuggestionsFeature() {
    const improveBtn = document.getElementById('improveEmailBtn');
    if (improveBtn) {
        improveBtn.addEventListener('click', applyEmailSuggestionsEnhanced);
    }
}

async function applyEmailSuggestionsEnhanced() {
    if (!emailState.analysisResults) {
        showErrorMessage('No analysis results available to apply');
        return;
    }

    debugLog('‚ú® Applying email suggestions');

    try {
        // Show loading state
        const improveBtn = document.getElementById('improveEmailBtn');
        const originalText = improveBtn.innerHTML;
        improveBtn.innerHTML = '‚è≥ Improving...';
        improveBtn.disabled = true;

        // Get current email content
        const emailContent = document.getElementById('emailContent');
        const emailSubject = document.getElementById('emailSubject');
        const currentContent = emailContent.value;
        const currentSubject = emailSubject.value;

        // Apply improvements
        const improved = applyImprovements(currentContent, currentSubject, emailState.analysisResults);

        // Show before/after comparison
        await showImprovementComparison(currentContent, improved.content, currentSubject, improved.subject);

        // Apply the improvements
        emailContent.value = improved.content;
        emailSubject.value = improved.subject;

        // Show success message
        showSuccessMessage('Email improved! Check the changes applied.');

        debugLog('‚úÖ Email improvements applied successfully');

    } catch (error) {
        debugLog('‚ùå Error applying suggestions:', error);
        showErrorMessage('Error applying suggestions. Please try again.');
    } finally {
        // Restore button
        const improveBtn = document.getElementById('improveEmailBtn');
        improveBtn.innerHTML = '‚ú® Apply Suggestions';
        improveBtn.disabled = false;
    }
}

function applyImprovements(content, subject, analysisResults) {
    let improvedContent = content;
    let improvedSubject = subject;

    const colleague = analysisResults.colleague;
    const discType = analysisResults.discAnalysis.colleagueDISC;

    // Apply DISC-specific improvements
    improvedContent = applyDISCImprovements(improvedContent, discType);

    // Apply professional tone improvements
    improvedContent = applyProfessionalImprovements(improvedContent);

    // Apply action clarity improvements
    improvedContent = applyActionClarityImprovements(improvedContent);

    // Improve subject line if needed
    if (!subject || subject.length < 5) {
        improvedSubject = generateImprovedSubject(content, colleague);
    }

    return {
        content: improvedContent,
        subject: improvedSubject
    };
}

function applyDISCImprovements(content, discType) {
    let improved = content;

    const improvements = {
        'D': [
            { from: /let me know/gi, to: 'please confirm by [specific date]' },
            { from: /when you can/gi, to: 'by [date needed]' },
            { from: /if possible/gi, to: 'required for project completion' }
        ],
        'I': [
            { from: /I need/gi, to: 'we could really benefit from' },
            { from: /you should/gi, to: 'what do you think about' },
            { from: /this is important/gi, to: 'this would help our team succeed' }
        ],
        'S': [
            { from: /I need this now/gi, to: 'when you have a moment, could you please help with' },
            { from: /you must/gi, to: 'would you be comfortable with' },
            { from: /immediately/gi, to: 'at your earliest convenience' }
        ],
        'C': [
            { from: /this should work/gi, to: 'based on our analysis, this approach would' },
            { from: /I think/gi, to: 'the data suggests' },
            { from: /probably/gi, to: 'according to our specifications' }
        ]
    };

    const typeImprovements = improvements[discType] || [];
    typeImprovements.forEach(improvement => {
        improved = improved.replace(improvement.from, improvement.to);
    });

    return improved;
}

function applyProfessionalImprovements(content) {
    let improved = content;

    const professionalReplacements = [
        { from: /hey/gi, to: 'Hi' },
        { from: /thanks!/gi, to: 'Thank you.' },
        { from: /cheers/gi, to: 'Best regards' },
        { from: /cool/gi, to: 'excellent' },
        { from: /awesome/gi, to: 'outstanding' },
        { from: /yeah/gi, to: 'yes' }
    ];

    professionalReplacements.forEach(replacement => {
        improved = improved.replace(replacement.from, replacement.to);
    });

    return improved;
}

function applyActionClarityImprovements(content) {
    let improved = content;

    // Add action clarity if missing
    if (!/\b(please|could you|would you)\b/i.test(improved)) {
        improved = improved.replace(/([.!?]\s*)$/m, '$1\n\nCould you please let me know your thoughts by [date]?');
    }

    return improved;
}

function generateImprovedSubject(content, colleague) {
    // Extract key topics from content
    const words = content.toLowerCase().split(/\s+/);
    const keyWords = ['meeting', 'budget', 'project', 'review', 'update', 'request', 'approval'];
    const foundKeys = keyWords.filter(key => words.includes(key));

    if (foundKeys.length > 0) {
        return `${foundKeys[0].charAt(0).toUpperCase() + foundKeys[0].slice(1)} Discussion - Input Needed`;
    }

    return `Discussion with ${colleague.name} - Please Review`;
}

async function showImprovementComparison(oldContent, newContent, oldSubject, newSubject) {
    // Create a simple alert showing the changes (you could make this more sophisticated)
    const changes = [];

    if (oldSubject !== newSubject) {
        changes.push(`Subject: "${oldSubject}" ‚Üí "${newSubject}"`);
    }

    // Count word changes (simplified)
    const oldWords = oldContent.split(' ').length;
    const newWords = newContent.split(' ').length;

    if (oldWords !== newWords) {
        changes.push(`Content: ${Math.abs(newWords - oldWords)} words ${newWords > oldWords ? 'added' : 'changed'}`);
    }

    if (changes.length > 0) {
        debugLog('üìù Changes applied:', changes);
    }

    // Small delay to show the process
    await new Promise(resolve => setTimeout(resolve, 1000));
}

// ============================================
// INITIALIZATION
// ============================================

// Initialize enhanced features when page loads
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        setupApplySuggestionsFeature();
        debugLog('‚úÖ Enhanced email analysis features initialized');
    }, 1500);
});

debugLog('üé® Enhanced Display & Apply Suggestions System Loaded!');
debugLog('üìß Enhanced Email Analysis System Loaded!');
debugLog('üìß Email Practice Module JavaScript Loaded');
debugLog('üé® Professional Conversation Trainer Loaded');

// ============================================
// SIMPLE APPLY SUGGESTIONS FIX
// ============================================
setTimeout(function() {
    const btn = document.getElementById('improveEmailBtn');
    if (btn) {
        // Remove the button and recreate it to clear all listeners
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);

        // Add simple working listener
        newBtn.onclick = function() {
            const content = document.getElementById('emailContent');
            const subject = document.getElementById('emailSubject');

            // Make simple improvements
            let text = content.value;
            text = text.replace(/hey/gi, 'Hi');
            text = text.replace(/thanks!/gi, 'Thank you.');
            text = text.replace(/\bi\b/g, 'I');

            if (!text.includes('Best regards')) {
                text += '\n\nBest regards';
            }

            content.value = text;
            alert('Email improved! Check your changes.');
        };

        console.log('‚úÖ Apply button fixed!');
    }
}, 4000);
</script>
</body>
</html>