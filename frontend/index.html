<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversation Trainer - Professional Development Platform</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            color: #334155;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
            border-bottom: 1px solid #e2e8f0;
            padding: 1rem 2rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #3b82f6, #1e40af);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .logo-text h1 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: -2px;
        }

        .logo-text p {
            font-size: 0.875rem;
            color: #64748b;
            font-weight: 400;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 8px;
            font-size: 0.875rem;
            color: #166534;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #16a34a;
            border-radius: 50%;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            width: 100%;
        }

        /* Setup Screen */
        .setup-screen {
            display: block;
        }

        .setup-screen.hidden {
            display: none !important;
        }

        .setup-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .setup-panel {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            border: 1px solid #f1f5f9;
        }

        .panel-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .panel-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .panel-icon.role {
            background: #eff6ff;
            color: #2563eb;
        }

        .panel-icon.scenario {
            background: #f0fdf4;
            color: #16a34a;
        }

        .panel-icon.personality {
            background: #fef3c7;
            color: #d97706;
        }

        .panel-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1e293b;
        }

        .selection-grid {
            display: grid;
            gap: 0.75rem;
        }

        .option-card {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .option-card:hover {
            border-color: #cbd5e1;
            background: #f1f5f9;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .option-card.selected {
            border-color: #3b82f6;
            background: #eff6ff;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .option-card.selected::after {
            content: '‚úì';
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            width: 20px;
            height: 20px;
            background: #3b82f6;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .option-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.25rem;
        }

        .option-description {
            font-size: 0.875rem;
            color: #64748b;
            line-height: 1.4;
        }

        /* Enhanced Personality Grid */
        .personality-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }

        .personality-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .personality-card:hover {
            border-color: #cbd5e1;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .personality-card.selected {
            border-color: #3b82f6;
            background: #eff6ff;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .personality-card.selected::after {
            content: '‚úì';
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            width: 20px;
            height: 20px;
            background: #3b82f6;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .personality-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .personality-avatar {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: linear-gradient(135deg, #3b82f6, #1e40af);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .personality-name {
            font-weight: 600;
            font-size: 0.95rem;
            color: #1e293b;
        }

        .personality-role {
            font-size: 0.8rem;
            color: #64748b;
        }

        .disc-preview {
            margin-bottom: 1rem;
            background: #f8fafc;
            padding: 0.75rem;
            border-radius: 8px;
        }

        .disc-bar {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.4rem;
        }

        .disc-bar:last-child {
            margin-bottom: 0;
        }

        .disc-label {
            font-weight: 600;
            font-size: 0.8rem;
            width: 15px;
            color: #374151;
        }

        .disc-fill {
            height: 8px;
            border-radius: 4px;
            transition: width 0.3s ease;
            flex: 1;
            max-width: 100px;
        }

        .disc-score {
            font-size: 0.75rem;
            font-weight: 500;
            color: #64748b;
            min-width: 30px;
            text-align: right;
        }

        .personality-description {
            font-size: 0.85rem;
            color: #64748b;
            line-height: 1.4;
        }

        .custom-personality-preview {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 1rem;
        }

        .custom-personality-preview p {
            font-size: 0.85rem;
            color: #64748b;
            margin: 0;
        }

        /* Chat Screen */
        .chat-screen {
            display: none;
            background: white;
            border-radius: 16px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            border: 1px solid #f1f5f9;
            height: 75vh;
            overflow: hidden;
            flex-direction: column;
        }

        .chat-screen.active {
            display: flex !important;
        }

        .chat-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #f1f5f9;
            background: #f8fafc;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .chat-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .participant-avatar {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .chat-details h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 2px;
        }

        .chat-details p {
            font-size: 0.875rem;
            color: #64748b;
        }

        .messages-area {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            background: #fafbfc;
        }

        .message {
            display: flex;
            margin-bottom: 1.5rem;
            align-items: flex-end;
            gap: 0.75rem;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 600;
            color: #64748b;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: #3b82f6;
            color: white;
        }

        .message.ai .message-avatar {
            background: #f59e0b;
            color: white;
        }

        .message-content {
            max-width: 70%;
            min-width: 250px;
            padding: 1rem 1.25rem;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.08);
            position: relative;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .message.user .message-content {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .message-text {
            font-size: 0.95rem;
            line-height: 1.6;
            margin: 0;
            white-space: pre-wrap;
        }

        .message-time {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 0.5rem;
        }

        .input-area {
            padding: 2rem;
            border-top: 1px solid #f1f5f9;
            background: white;
            flex-shrink: 0;
        }

        .input-container {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
        }

        .message-input {
            flex: 1;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1rem 1.25rem;
            font-size: 1rem;
            line-height: 1.5;
            resize: none;
            min-height: 48px;
            max-height: 120px;
            outline: none;
            transition: border-color 0.2s ease;
            font-family: inherit;
        }

        .message-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .send-button {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 1rem 1.5rem;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 90px;
            justify-content: center;
        }

        .send-button:hover:not(:disabled) {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .send-button:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
            transform: none;
        }

        /* Action Panel */
        .action-panel {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            border: 1px solid #f1f5f9;
            text-align: center;
        }

        .start-button {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 1rem 2rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .start-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .start-button:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .secondary-button {
            background: #f8fafc;
            color: #64748b;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 0.75rem 1.5rem;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 0 0.5rem;
        }

        .secondary-button:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }

        /* System Messages */
        .system-message {
            text-align: center;
            padding: 1.5rem;
            color: #64748b;
            font-size: 0.9rem;
            font-style: italic;
            margin: 1rem 0;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        /* Messages */
        .success-message, .error-message {
            padding: 1rem;
            border-radius: 12px;
            margin: 1rem 0;
            font-size: 0.95rem;
            display: none;
        }

        .success-message {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #166534;
        }

        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
        }

        /* Enhanced Custom Character Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(4px);
        }
        /* ============================================
   SAVED CONTENT STYLING (PHASE 1)
   ============================================ */

        /* Saved Colleague Cards */
        .personality-card.saved-colleague {
            border: 2px solid #f59e0b;
            background: linear-gradient(135deg, #fef3c7, #fbbf24);
            position: relative;
        }

        .personality-card.saved-colleague:hover {
            border-color: #d97706;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px -2px rgba(245, 158, 11, 0.25);
        }

        .personality-card.saved-colleague.selected {
            border-color: #f59e0b;
            background: linear-gradient(135deg, #fef3c7, #fbbf24);
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
        }

        .saved-avatar {
            background: linear-gradient(135deg, #f59e0b, #d97706) !important;
            color: white !important;
        }

        .saved-badge {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: #065f46;
            color: #d1fae5;
            font-size: 0.7rem;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-weight: 600;
        }

        .saved-personality-preview {
            background: rgba(255, 255, 255, 0.7);
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .saved-description {
            font-size: 0.85rem;
            color: #374151;
            line-height: 1.4;
            margin: 0;
            font-style: italic;
        }
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 16px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #f1f5f9;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
            margin: 0;
        }

        .form-section {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #f1f5f9;
        }

        .form-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-description {
            font-size: 0.9rem;
            color: #64748b;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #374151;
            font-size: 0.95rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: border-color 0.2s ease;
            font-family: inherit;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .btn {
            flex: 1;
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-secondary {
            background: #f8fafc;
            border-color: #e2e8f0;
            color: #64748b;
        }

        .btn-secondary:hover {
            background: #f1f5f9;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        /* Responsive adjustments for personality grid */
        @media (max-width: 768px) {
            .personality-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }

            .personality-card {
                padding: 0.75rem;
            }

            .setup-container {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .header-content {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .main-content {
                padding: 1rem;
            }

            .setup-panel {
                padding: 1.5rem;
            }

            .message-content {
                max-width: 90%;
            }

            .messages-area {
                padding: 1rem;
            }

            .input-area {
                padding: 1.5rem;
            }

            .modal-content {
                width: 95%;
                padding: 1.5rem;
            }

            .form-row {
                flex-direction: column;
                gap: 0.75rem;
            }
        }
        /* Saved Scenario Cards */
        .option-card.saved-scenario {
            border: 2px solid #10b981;
            background: linear-gradient(135deg, #d1fae5, #6ee7b7);
            position: relative;
        }

        .option-card.saved-scenario:hover {
            border-color: #059669;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px -1px rgba(16, 185, 129, 0.25);
        }

        .option-card.saved-scenario.selected {
            border-color: #10b981;
            background: linear-gradient(135deg, #d1fae5, #6ee7b7);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }

        .saved-badge-small {
            display: inline-block;
            font-size: 0.8rem;
            margin-right: 0.3rem;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">CT</div>
                    <div class="logo-text">
                        <h1>Conversation Trainer</h1>
                        <p>NSW Local Government Professional Development</p>
                    </div>
                </div>
                <div class="header-actions">
                    <div class="status-indicator">
                        <div class="status-dot"></div>
                        <span>Service Online</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Setup Screen -->
            <div id="setupScreen" class="setup-screen">
                <div class="setup-container">
                    <!-- Role Selection -->
                    <div class="setup-panel">
                        <div class="panel-header">
                            <div class="panel-icon role">üë§</div>
                            <h2 class="panel-title">Your Role</h2>
                        </div>
                        <div class="selection-grid">
                            <div class="option-card" data-role="director">
                                <div class="option-title">Director</div>
                                <div class="option-description">Practice strategic leadership, mentoring conversations, and budget discussions with senior stakeholders.</div>
                            </div>
                            <div class="option-card" data-role="manager">
                                <div class="option-title">Manager</div>
                                <div class="option-description">Handle performance reviews, team conflicts, and operational discussions with staff and colleagues.</div>
                            </div>
                            <div class="option-card" data-role="customer-service">
                                <div class="option-title">Customer Service Officer</div>
                                <div class="option-description">Manage resident complaints, billing disputes, and challenging service-related conversations.</div>
                            </div>
                            <div class="option-card" data-role="project-manager">
                                <div class="option-title">Project Manager</div>
                                <div class="option-description">Navigate stakeholder negotiations, contractor management, and cross-departmental coordination.</div>
                            </div>
                        </div>
                    </div>

                    <!-- Scenario Selection -->
                    <div class="setup-panel">
                        <div class="panel-header">
                            <div class="panel-icon scenario">üìã</div>
                            <h2 class="panel-title">Practice Scenario</h2>
                        </div>
                        <div class="selection-grid">
                            <div class="option-card" data-scenario="budget_cuts">
                                <div class="option-title">Budget Reduction Discussion</div>
                                <div class="option-description">Practice explaining budget cuts while maintaining team morale and finding creative solutions to resource constraints.</div>
                            </div>
                            <div class="option-card" data-scenario="angry_resident">
                                <div class="option-title">Challenging Resident Interaction</div>
                                <div class="option-description">Handle frustrated ratepayer complaints about service levels, rate increases, and council decisions.</div>
                            </div>
                            <div class="option-card" data-scenario="custom_scenario" id="customScenarioOption">
                                <div class="option-title">üéØ Create Custom Scenario</div>
                                <div class="option-description">Design your specific meeting situation. Perfect for practicing upcoming real conversations.</div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Personality Selection -->
                    <div class="setup-panel">
                        <div class="panel-header">
                            <div class="panel-icon personality">üé≠</div>
                            <h2 class="panel-title">AI Conversation Partner</h2>
                        </div>
                        <div class="personality-grid">
                            <!-- NSW Local Government Personalities -->
                            <div class="personality-card" data-personality="infrastructure_engineer">
                                <div class="personality-header">
                                    <div class="personality-avatar">TM</div>
                                    <div class="personality-info">
                                        <div class="personality-name">Terry Mitchell</div>
                                        <div class="personality-role">Senior Infrastructure Engineer</div>
                                    </div>
                                </div>
                                <div class="disc-preview">
                                    <div class="disc-bar">
                                        <span class="disc-label">D</span>
                                        <div class="disc-fill" style="width: 65%; background: #dc2626;"></div>
                                        <span class="disc-score">65%</span>
                                    </div>
                                    <div class="disc-bar">
                                        <span class="disc-label">I</span>
                                        <div class="disc-fill" style="width: 25%; background: #d97706;"></div>
                                        <span class="disc-score">25%</span>
                                    </div>
                                    <div class="disc-bar">
                                        <span class="disc-label">S</span>
                                        <div class="disc-fill" style="width: 35%; background: #16a34a;"></div>
                                        <span class="disc-score">35%</span>
                                    </div>
                                    <div class="disc-bar">
                                        <span class="disc-label">C</span>
                                        <div class="disc-fill" style="width: 85%; background: #2563eb;"></div>
                                        <span class="disc-score">85%</span>
                                    </div>
                                </div>
                                <div class="personality-description">Technical expert, detail-oriented, skeptical of quick fixes. Expects thorough engineering analysis.</div>
                            </div>

                            <div class="personality-card" data-personality="community_engagement">
                                <div class="personality-header">
                                    <div class="personality-avatar">SC</div>
                                    <div class="personality-info">
                                        <div class="personality-name">Sarah Chen</div>
                                        <div class="personality-role">Community Engagement Officer</div>
                                    </div>
                                </div>
                                <div class="disc-preview">
                                    <div class="disc-bar">
                                        <span class="disc-label">D</span>
                                        <div class="disc-fill" style="width: 35%; background: #dc2626;"></div>
                                        <span class="disc-score">35%</span>
                                    </div>
                                    <div class="disc-bar">
                                        <span class="disc-label">I</span>
                                        <div class="disc-fill" style="width: 85%; background: #d97706;"></div>
                                        <span class="disc-score">85%</span>
                                    </div>
                                    <div class="disc-bar">
                                        <span class="disc-label">S</span>
                                        <div class="disc-fill" style="width: 70%; background: #16a34a;"></div>
                                        <span class="disc-score">70%</span>
                                    </div>
                                    <div class="disc-bar">
                                        <span class="disc-label">C</span>
                                        <div class="disc-fill" style="width: 40%; background: #2563eb;"></div>
                                        <span class="disc-score">40%</span>
                                    </div>
                                </div>
                                <div class="personality-description">People-focused, enthusiastic about community consultation. Diplomatic but can be overly optimistic.</div>
                            </div>

                            <div class="personality-card" data-personality="budget_director">
                                <div class="personality-header">
                                    <div class="personality-avatar">DW</div>
                                    <div class="personality-info">
                                        <div class="personality-name">David Walsh</div>
                                        <div class="personality-role">Budget & Finance Director</div>
                                    </div>
                                </div>
                                <div class="disc-preview">
                                    <div class="disc-bar">
                                        <span class="disc-label">D</span>
                                        <div class="disc-fill" style="width: 80%; background: #dc2626;"></div>
                                        <span class="disc-score">80%</span>
                                    </div>
                                    <div class="disc-bar">
                                        <span class="disc-label">I</span>
                                        <div class="disc-fill" style="width: 20%; background: #d97706;"></div>
                                        <span class="disc-score">20%</span>
                                    </div>
                                    <div class="disc-bar">
                                        <span class="disc-label">S</span>
                                        <div class="disc-fill" style="width: 30%; background: #16a34a;"></div>
                                        <span class="disc-score">30%</span>
                                    </div>
                                    <div class="disc-bar">
                                        <span class="disc-label">C</span>
                                        <div class="disc-fill" style="width: 90%; background: #2563eb;"></div>
                                        <span class="disc-score">90%</span>
                                    </div>
                                </div>
                                <div class="personality-description">Numbers-driven, direct about financial constraints. Challenges spending proposals with detailed questions.</div>
                            </div>

                            <div class="personality-card" data-personality="union_rep">
                                <div class="personality-header">
                                    <div class="personality-avatar">MS</div>
                                    <div class="personality-info">
                                        <div class="personality-name">Maria Santos</div>
                                        <div class="personality-role">Union Representative</div>
                                    </div>
                                </div>
                                <div class="disc-preview">
                                    <div class="disc-bar">
                                        <span class="disc-label">D</span>
                                        <div class="disc-fill" style="width: 85%; background: #dc2626;"></div>
                                        <span class="disc-score">85%</span>
                                    </div>
                                    <div class="disc-bar">
                                        <span class="disc-label">I</span>
                                        <div class="disc-fill" style="width: 60%; background: #d97706;"></div>
                                        <span class="disc-score">60%</span>
                                    </div>
                                    <div class="disc-bar">
                                        <span class="disc-label">S</span>
                                        <div class="disc-fill" style="width: 45%; background: #16a34a;"></div>
                                        <span class="disc-score">45%</span>
                                    </div>
                                    <div class="disc-bar">
                                        <span class="disc-label">C</span>
                                        <div class="disc-fill" style="width: 55%; background: #2563eb;"></div>
                                        <span class="disc-score">55%</span>
                                    </div>
                                </div>
                                <div class="personality-description">Assertive advocate for workers' rights. Direct communicator who challenges management decisions affecting staff.</div>
                            </div>

                            <div class="personality-card" data-personality="councillor_thompson">
                                <div class="personality-header">
                                    <div class="personality-avatar">RT</div>
                                    <div class="personality-info">
                                        <div class="personality-name">Robert Thompson</div>
                                        <div class="personality-role">Long-term Councillor</div>
                                    </div>
                                </div>
                                <div class="disc-preview">
                                    <div class="disc-bar">
                                        <span class="disc-label">D</span>
                                        <div class="disc-fill" style="width: 40%; background: #dc2626;"></div>
                                        <span class="disc-score">40%</span>
                                    </div>
                                    <div class="disc-bar">
                                        <span class="disc-label">I</span>
                                        <div class="disc-fill" style="width: 50%; background: #d97706;"></div>
                                        <span class="disc-score">50%</span>
                                    </div>
                                    <div class="disc-bar">
                                        <span class="disc-label">S</span>
                                        <div class="disc-fill" style="width: 85%; background: #16a34a;"></div>
                                        <span class="disc-score">85%</span>
                                    </div>
                                    <div class="disc-bar">
                                        <span class="disc-label">C</span>
                                        <div class="disc-fill" style="width: 65%; background: #2563eb;"></div>
                                        <span class="disc-score">65%</span>
                                    </div>
                                </div>
                                <div class="personality-description">Steady, consensus-building approach. Values tradition and established processes. Asks thoughtful questions.</div>
                            </div>

                            <div class="personality-card" data-personality="strategic_planner">
                                <div class="personality-header">
                                    <div class="personality-avatar">EK</div>
                                    <div class="personality-info">
                                        <div class="personality-name">Emily Kim</div>
                                        <div class="personality-role">Strategic Planner</div>
                                    </div>
                                </div>
                                <div class="disc-preview">
                                    <div class="disc-bar">
                                        <span class="disc-label">D</span>
                                        <div class="disc-fill" style="width: 50%; background: #dc2626;"></div>
                                        <span class="disc-score">50%</span>
                                    </div>
                                    <div class="disc-bar">
                                        <span class="disc-label">I</span>
                                        <div class="disc-fill" style="width: 75%; background: #d97706;"></div>
                                        <span class="disc-score">75%</span>
                                    </div>
                                    <div class="disc-bar">
                                        <span class="disc-label">S</span>
                                        <div class="disc-fill" style="width: 45%; background: #16a34a;"></div>
                                        <span class="disc-score">45%</span>
                                    </div>
                                    <div class="disc-bar">
                                        <span class="disc-label">C</span>
                                        <div class="disc-fill" style="width: 80%; background: #2563eb;"></div>
                                        <span class="disc-score">80%</span>
                                    </div>
                                </div>
                                <div class="personality-description">Analytical yet enthusiastic about new ideas. Balances data-driven decisions with stakeholder engagement.</div>
                            </div>

                            <div class="personality-card" data-personality="custom_character" id="customCharacterOption">
                                <div class="personality-header">
                                    <div class="personality-avatar">üõ†Ô∏è</div>
                                    <div class="personality-info">
                                        <div class="personality-name">Create Custom</div>
                                        <div class="personality-role">Build Your Own</div>
                                    </div>
                                </div>
                                <div class="custom-personality-preview">
                                    <p>Design a virtual version of someone from your workplace with custom DISC profile and behaviors.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Panel -->
                    <div class="action-panel">
                        <button class="start-button" id="startConversation" disabled>
                            <span>üöÄ</span>
                            <span>Begin Practice Session</span>
                        </button>
                        <p style="margin-top: 1rem; color: #64748b; font-size: 0.875rem;">
                            Select your role, scenario, and AI partner to start practicing
                        </p>

                        <!-- UPDATED STORAGE MANAGEMENT SECTION -->
                        <!-- Replace the existing storage management section in your action panel -->

                        <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #e2e8f0;">
                            <h4 style="font-size: 0.9rem; font-weight: 600; color: #64748b; margin-bottom: 1rem;">Storage Management</h4>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem;">
                                <!-- View & Export -->
                                <button class="secondary-button" onclick="showStoredColleagues()" style="font-size: 0.85rem;">
                                    üìö View Colleagues (<span id="colleagueCount">0</span>)
                                </button>
                                <button class="secondary-button" onclick="showStoredScenarios()" style="font-size: 0.85rem;">
                                    üìã View Scenarios (<span id="scenarioCount">0</span>)
                                </button>

                                <!-- Export -->
                                <button class="secondary-button" onclick="exportColleagues()" style="font-size: 0.85rem;">
                                    üíæ Export Colleagues
                                </button>
                                <button class="secondary-button" onclick="exportScenarios()" style="font-size: 0.85rem;">
                                    üíæ Export Scenarios
                                </button>

                                <!-- Import -->
                                <button class="secondary-button" onclick="importColleagues()" style="font-size: 0.85rem;">
                                    üìÇ Import Colleagues
                                </button>
                                <button class="secondary-button" onclick="importScenarios()" style="font-size: 0.85rem;">
                                    üìÇ Import Scenarios
                                </button>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                                <button class="secondary-button" onclick="testStorage()" style="font-size: 0.85rem;">
                                    üîç Debug Storage (Console)
                                </button>
                                <button class="secondary-button" onclick="clearAllStorage()" style="font-size: 0.85rem; color: #dc2626;">
                                    üóëÔ∏è Clear All Data
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Screen -->
            <div id="chatScreen" class="chat-screen">
                <div class="chat-header">
                    <div class="chat-info">
                        <div class="participant-avatar" id="participantAvatar">CS</div>
                        <div class="chat-details">
                            <h3 id="participantName">Practice Session</h3>
                            <p id="scenarioDescription">Preparing conversation...</p>
                        </div>
                    </div>
                    <div>
                        <button class="secondary-button" id="endConversation">End Session</button>
                    </div>
                </div>

                <div class="messages-area" id="messagesArea">
                    <!-- Messages will be added here dynamically -->
                </div>

                <div class="input-area">
                    <div class="input-container">
                        <textarea class="message-input" id="messageInput" placeholder="Type your response..." rows="1" disabled></textarea>
                        <button class="send-button" id="sendButton" disabled>
                            <span>Send</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="success-message" id="successMessage">
                ‚úÖ Connected to conversation service successfully
            </div>

            <div class="error-message" id="errorMessage">
                ‚ùå Error starting conversation
            </div>
        </main>
    </div>

    <!-- Enhanced Custom Character Modal -->
    <div class="modal-overlay" id="customCharacterModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create Your Custom Colleague</h3>
                <p style="color: #64748b; font-size: 0.9rem; margin-top: 0.5rem;">Build a realistic virtual version of someone from your workplace</p>
            </div>

            <!-- Character Creation Form -->
            <div id="characterCreationForm">
                <!-- Basic Information -->
                <div class="form-section">
                    <h4 class="section-title">üë§ Basic Information</h4>

                    <div class="form-row">
                        <div class="form-group" style="flex: 2;">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-input" id="customName" placeholder="e.g., David Morrison">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">Job Title/Role</label>
                            <input type="text" class="form-input" id="customRole" placeholder="e.g., Senior Engineer">
                        </div>
                    </div>
                </div>

                <!-- Workplace Behavior -->
                <div class="form-section">
                    <h4 class="section-title">üè¢ Workplace Behavior</h4>

                    <div class="form-group">
                        <label class="form-label">How do they typically behave in meetings?</label>
                        <textarea class="form-input form-textarea" id="customPersonality" placeholder="e.g., Speaks first, asks lots of questions, interrupts when excited, focuses on technical details..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">What motivates them most?</label>
                        <textarea class="form-input form-textarea" id="customMotivations" placeholder="e.g., Recognition for achievements, job security, solving complex problems..."></textarea>
                    </div>
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancelCustomCharacter">Cancel</button>
                <button class="btn btn-primary" id="saveCustomCharacter">
                    üíæ Create Character
                </button>
            </div>
        </div>
    </div>

    <!-- Custom Scenario Modal -->
    <div class="modal-overlay" id="customScenarioModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">Create Your Custom Scenario</h3>
            </div>

            <div class="form-group">
                <label class="form-label">Scenario Title</label>
                <input type="text" class="form-input" id="customScenarioTitle" placeholder="e.g., Budget Approval Meeting - Q2 Infrastructure Spend">
            </div>

            <div class="form-group">
                <label class="form-label">Meeting Context & Background</label>
                <textarea class="form-input form-textarea" id="customScenarioContext" placeholder="Describe the situation leading up to this meeting. What decisions need to be made? What's happened before? What are the stakes?"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Your Role & Objective</label>
                <textarea class="form-input form-textarea" id="customScenarioObjective" placeholder="What's your position in this meeting? What are you trying to achieve? What approach do you plan to take?"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Expected Challenges</label>
                <textarea class="form-input form-textarea" id="customScenarioChallenges" placeholder="What resistance or difficulties do you anticipate? What objections might come up?"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Meeting Type</label>
                <select class="form-input" id="customScenarioType">
                    <option value="budget_review">Budget Review</option>
                    <option value="project_planning">Project Planning</option>
                    <option value="performance_discussion">Performance Discussion</option>
                    <option value="policy_decision">Policy Decision</option>
                    <option value="stakeholder_negotiation">Stakeholder Negotiation</option>
                    <option value="crisis_management">Crisis Management</option>
                    <option value="vendor_meeting">Vendor/Contractor Meeting</option>
                    <option value="other">Other</option>
                </select>
            </div>

            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancelCustomScenario">Cancel</button>
                <button class="btn btn-primary" id="saveCustomScenario">Create Scenario</button>
            </div>
        </div>
    </div>

<script>
// ============================================
// CONFIGURATION & STATE
// ============================================
const API_BASE_URL = 'https://conversation-trainer-production.up.railway.app';

let appState = {
    selectedRole: null,
    selectedScenario: null,
    selectedPersonality: null,
    currentConversation: null,
    conversationHistory: [],
    isConnected: false
};

let customCharacterData = null;
let customScenarioData = null;

// ============================================
// UTILITY FUNCTIONS
// ============================================
function debugLog(message, data = null) {
    const timestamp = new Date().toLocaleTimeString();
    console.log(`üîç [${timestamp}] ${message}`, data || '');
}

function showSuccessMessage(message) {
    const successMsg = document.getElementById('successMessage');
    if (successMsg) {
        successMsg.textContent = message;
        successMsg.style.display = 'block';
        setTimeout(() => {
            successMsg.style.display = 'none';
        }, 4000);
    }
}

function showErrorMessage(message) {
    const errorMsg = document.getElementById('errorMessage');
    if (errorMsg) {
        errorMsg.textContent = message;
        errorMsg.style.display = 'block';
        setTimeout(() => {
            errorMsg.style.display = 'none';
        }, 6000);
    }
}

// ============================================
// STORAGE FUNCTIONS
// ============================================
function saveColleagueToStorage(colleagueData) {
    try {
        const colleagues = getStoredColleagues();
        const colleagueId = `colleague_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

        colleagueData.id = colleagueId;
        colleagueData.saved_at = new Date().toISOString();

        colleagues[colleagueId] = colleagueData;
        localStorage.setItem('conversation_trainer_colleagues', JSON.stringify(colleagues));

        debugLog('‚úÖ Colleague saved to storage', colleagueData);
        updateStorageCounts();
        return colleagueId;
    } catch (error) {
        debugLog('‚ùå Error saving colleague', error);
        throw error;
    }
}

function getStoredColleagues() {
    try {
        const stored = localStorage.getItem('conversation_trainer_colleagues');
        return stored ? JSON.parse(stored) : {};
    } catch (error) {
        debugLog('‚ö†Ô∏è Error reading stored colleagues, returning empty object', error);
        return {};
    }
}

function saveScenarioToStorage(scenarioData) {
    try {
        const scenarios = getStoredScenarios();
        const scenarioId = `scenario_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

        scenarioData.id = scenarioId;
        scenarioData.saved_at = new Date().toISOString();

        scenarios[scenarioId] = scenarioData;
        localStorage.setItem('conversation_trainer_scenarios', JSON.stringify(scenarios));

        debugLog('‚úÖ Scenario saved to storage', scenarioData);
        updateStorageCounts();
        return scenarioId;
    } catch (error) {
        debugLog('‚ùå Error saving scenario', error);
        throw error;
    }
}

function getStoredScenarios() {
    try {
        const stored = localStorage.getItem('conversation_trainer_scenarios');
        return stored ? JSON.parse(stored) : {};
    } catch (error) {
        debugLog('‚ö†Ô∏è Error reading stored scenarios, returning empty object', error);
        return {};
    }
}

function updateStorageCounts() {
    try {
        const colleagues = getStoredColleagues();
        const scenarios = getStoredScenarios();

        const colleagueCount = Object.keys(colleagues).length;
        const scenarioCount = Object.keys(scenarios).length;

        const colleagueCountElement = document.getElementById('colleagueCount');
        const scenarioCountElement = document.getElementById('scenarioCount');

        if (colleagueCountElement) colleagueCountElement.textContent = colleagueCount;
        if (scenarioCountElement) scenarioCountElement.textContent = scenarioCount;

    } catch (error) {
        debugLog('Error updating storage counts', error);
    }
}

// ============================================
// STORAGE MANAGEMENT FUNCTIONS
// ============================================
function showStoredColleagues() {
    const colleagues = getStoredColleagues();
    const count = Object.keys(colleagues).length;

    if (count === 0) {
        showSuccessMessage('No saved colleagues yet. Create some custom characters to build your library!');
        return;
    }

    console.log('üìö Stored Colleagues:', colleagues);
    showSuccessMessage(`You have ${count} saved colleague${count === 1 ? '' : 's'}. Check console for details.`);
}

function showStoredScenarios() {
    const scenarios = getStoredScenarios();
    const count = Object.keys(scenarios).length;

    if (count === 0) {
        showSuccessMessage('No saved scenarios yet. Create some custom scenarios to build your library!');
        return;
    }

    console.log('üìã Stored Scenarios:', scenarios);
    showSuccessMessage(`You have ${count} saved scenario${count === 1 ? '' : 's'}. Check console for details.`);
}

function exportColleagues() {
    try {
        const colleagues = getStoredColleagues();
        const count = Object.keys(colleagues).length;

        if (count === 0) {
            showErrorMessage('No colleagues to export. Create some custom characters first.');
            return;
        }

        const exportData = {
            type: 'conversation_trainer_colleagues',
            version: '1.0',
            exported_at: new Date().toISOString(),
            count: count,
            colleagues: colleagues
        };

        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});

        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `conversation_trainer_colleagues_${new Date().toISOString().split('T')[0]}.json`;
        link.click();

        showSuccessMessage(`Successfully exported ${count} colleague${count === 1 ? '' : 's'}!`);
        debugLog('‚úÖ Colleagues exported', exportData);

    } catch (error) {
        debugLog('‚ùå Error exporting colleagues', error);
        showErrorMessage('Error exporting colleagues. Please try again.');
    }
}

function exportScenarios() {
    try {
        const scenarios = getStoredScenarios();
        const count = Object.keys(scenarios).length;

        if (count === 0) {
            showErrorMessage('No scenarios to export. Create some custom scenarios first.');
            return;
        }

        const exportData = {
            type: 'conversation_trainer_scenarios',
            version: '1.0',
            exported_at: new Date().toISOString(),
            count: count,
            scenarios: scenarios
        };

        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});

        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `conversation_trainer_scenarios_${new Date().toISOString().split('T')[0]}.json`;
        link.click();

        showSuccessMessage(`Successfully exported ${count} scenario${count === 1 ? '' : 's'}!`);
        debugLog('‚úÖ Scenarios exported', exportData);

    } catch (error) {
        debugLog('‚ùå Error exporting scenarios', error);
        showErrorMessage('Error exporting scenarios. Please try again.');
    }
}

function testStorage() {
    console.log('üìö Stored Colleagues:', getStoredColleagues());
    console.log('üìã Stored Scenarios:', getStoredScenarios());
    console.log('üìä Storage Status:', {
        colleagues: Object.keys(getStoredColleagues()).length,
        scenarios: Object.keys(getStoredScenarios()).length
    });
}

// ============================================
// SCREEN SWITCHING
// ============================================
function switchToChat() {
    debugLog('üé¨ SWITCHING TO CHAT SCREEN');

    try {
        const setupScreen = document.getElementById('setupScreen');
        const chatScreen = document.getElementById('chatScreen');

        if (!setupScreen || !chatScreen) {
            throw new Error('Missing required screen elements');
        }

        setupScreen.style.display = 'none';
        setupScreen.classList.add('hidden');

        chatScreen.style.display = 'flex';
        chatScreen.classList.add('active');

        chatScreen.offsetHeight; // Force layout recalculation

        debugLog('üéØ Screen switch completed successfully');
        return true;

    } catch (error) {
        debugLog('‚ùå Error switching screens', error);
        showErrorMessage(`Screen switching error: ${error.message}`);
        return false;
    }
}

function switchToSetup() {
    debugLog('üè† Switching back to setup screen');

    const setupScreen = document.getElementById('setupScreen');
    const chatScreen = document.getElementById('chatScreen');

    if (chatScreen) {
        chatScreen.style.display = 'none';
        chatScreen.classList.remove('active');
    }

    if (setupScreen) {
        setupScreen.style.display = 'block';
        setupScreen.classList.remove('hidden');
    }
}

// ============================================
// CUSTOM CHARACTER FUNCTIONS
// ============================================
function showCustomCharacterModal() {
    debugLog('üìù Opening custom character modal');

    const modal = document.getElementById('customCharacterModal');
    if (!modal) {
        debugLog('‚ùå Custom character modal not found in DOM');
        showErrorMessage('Custom character modal not found. Please refresh the page.');
        return;
    }

    clearCustomCharacterForm();
    modal.style.display = 'block';

    setTimeout(() => {
        const nameInput = document.getElementById('customName');
        if (nameInput) nameInput.focus();
    }, 100);

    debugLog('‚úÖ Custom character modal opened');
}

function cancelCustomCharacter() {
    debugLog('‚ùå Cancelling custom character creation');

    const modal = document.getElementById('customCharacterModal');
    if (modal) {
        modal.style.display = 'none';
    }

    clearCustomCharacterForm();

    if (appState.selectedPersonality === 'custom_character') {
        const customOption = document.getElementById('customCharacterOption');
        if (customOption) {
            customOption.classList.remove('selected');
            resetCustomCharacterCard();
        }
        appState.selectedPersonality = null;
        customCharacterData = null;
        updateStartButton();
    }

    debugLog('‚úÖ Custom character creation cancelled');
}

function saveCustomCharacter() {
    debugLog('üíæ Attempting to save custom character');

    try {
        const nameInput = document.getElementById('customName');
        const roleInput = document.getElementById('customRole');
        const personalityInput = document.getElementById('customPersonality');
        const motivationsInput = document.getElementById('customMotivations');

        if (!nameInput || !roleInput || !personalityInput || !motivationsInput) {
            throw new Error('Form elements not found. Please refresh the page.');
        }

        const name = nameInput.value?.trim() || '';
        const role = roleInput.value?.trim() || '';
        const personality = personalityInput.value?.trim() || '';
        const motivations = motivationsInput.value?.trim() || '';

        debugLog('üìù Form data collected', { name, role, personality, motivations });

        if (!name) {
            showErrorMessage('Please provide a name for the colleague.');
            nameInput.focus();
            return false;
        }

        if (!role) {
            showErrorMessage('Please provide a job title/role for the colleague.');
            roleInput.focus();
            return false;
        }

        if (!personality) {
            showErrorMessage('Please describe how this person behaves in meetings.');
            personalityInput.focus();
            return false;
        }

        const characterData = {
            name: name,
            role: role,
            personality: personality,
            motivations: motivations || 'Professional success and recognition',
            type: 'custom',
            created: new Date().toISOString()
        };

        debugLog('‚úÖ Character data created', characterData);

        const colleagueId = saveColleagueToStorage(characterData);
        characterData.id = colleagueId;

        customCharacterData = characterData;
        updateCustomCharacterCard(characterData);

        appState.selectedPersonality = 'custom_character';
        debugLog('üéØ App state updated', appState);

        const modal = document.getElementById('customCharacterModal');
        if (modal) {
            modal.style.display = 'none';
        }

        updateStartButton();

        debugLog('üéâ Custom character created successfully:', name);
        showSuccessMessage(`Custom colleague "${name}" created and saved! You can now start a practice session.`);

        return true;

    } catch (error) {
        debugLog('üí• Error creating custom character:', error);
        showErrorMessage(`Error creating custom character: ${error.message}`);
        return false;
    }
}

function updateCustomCharacterCard(characterData) {
    debugLog('üé® Updating custom character card UI');

    const customOption = document.getElementById('customCharacterOption');
    if (!customOption) {
        debugLog('‚ùå Custom character card not found');
        return;
    }

    document.querySelectorAll('.personality-card').forEach(card => {
        if (card !== customOption) {
            card.classList.remove('selected');
        }
    });

    customOption.classList.add('selected');

    const nameElement = customOption.querySelector('.personality-name');
    const roleElement = customOption.querySelector('.personality-role');
    const descElement = customOption.querySelector('.personality-description');

    if (nameElement) {
        nameElement.textContent = characterData.name;
    }
    if (roleElement) {
        roleElement.textContent = characterData.role;
    }
    if (descElement) {
        const description = characterData.personality.length > 80
            ? characterData.personality.substring(0, 80) + '...'
            : characterData.personality;
        descElement.textContent = `Custom colleague: ${description}`;
    }

    debugLog('‚úÖ Custom character card updated');
}

function resetCustomCharacterCard() {
    debugLog('üîÑ Resetting custom character card to default');

    const customOption = document.getElementById('customCharacterOption');
    if (!customOption) return;

    const nameElement = customOption.querySelector('.personality-name');
    const roleElement = customOption.querySelector('.personality-role');
    const descElement = customOption.querySelector('.personality-description');

    if (nameElement) nameElement.textContent = 'Create Custom';
    if (roleElement) roleElement.textContent = 'Build Your Own';
    if (descElement) descElement.textContent = 'Design a virtual version of someone from your workplace with custom DISC profile and behaviors.';
}

function clearCustomCharacterForm() {
    debugLog('üßπ Clearing custom character form');

    const fields = ['customName', 'customRole', 'customPersonality', 'customMotivations'];
    fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.value = '';
        }
    });
}

// ============================================
// CUSTOM SCENARIO FUNCTIONS
// ============================================
function showCustomScenarioModal() {
    debugLog('üìã Opening custom scenario modal');

    const modal = document.getElementById('customScenarioModal');
    if (!modal) {
        debugLog('‚ùå Custom scenario modal not found in DOM');
        showErrorMessage('Custom scenario modal not found. Please refresh the page.');
        return;
    }

    clearCustomScenarioForm();
    modal.style.display = 'block';

    setTimeout(() => {
        const titleInput = document.getElementById('customScenarioTitle');
        if (titleInput) titleInput.focus();
    }, 100);

    debugLog('‚úÖ Custom scenario modal opened');
}

function cancelCustomScenario() {
    debugLog('‚ùå Cancelling custom scenario creation');

    const modal = document.getElementById('customScenarioModal');
    if (modal) {
        modal.style.display = 'none';
    }

    clearCustomScenarioForm();

    if (appState.selectedScenario === 'custom_scenario') {
        const customOption = document.getElementById('customScenarioOption');
        if (customOption) {
            customOption.classList.remove('selected');
            resetCustomScenarioCard();
        }
        appState.selectedScenario = null;
        customScenarioData = null;
        updateStartButton();
    }

    debugLog('‚úÖ Custom scenario creation cancelled');
}

function saveCustomScenario() {
    debugLog('üíæ Attempting to save custom scenario');

    try {
        const titleInput = document.getElementById('customScenarioTitle');
        const contextInput = document.getElementById('customScenarioContext');
        const objectiveInput = document.getElementById('customScenarioObjective');
        const challengesInput = document.getElementById('customScenarioChallenges');
        const typeInput = document.getElementById('customScenarioType');

        if (!titleInput || !contextInput || !objectiveInput || !challengesInput || !typeInput) {
            throw new Error('Form elements not found. Please refresh the page.');
        }

        const title = titleInput.value?.trim() || '';
        const context = contextInput.value?.trim() || '';
        const objective = objectiveInput.value?.trim() || '';
        const challenges = challengesInput.value?.trim() || '';
        const type = typeInput.value || 'budget_review';

        debugLog('üìù Scenario form data collected', { title, context, objective, challenges, type });

        if (!title) {
            showErrorMessage('Please provide a title for the scenario.');
            titleInput.focus();
            return false;
        }

        if (!context) {
            showErrorMessage('Please describe the meeting context and background.');
            contextInput.focus();
            return false;
        }

        if (!objective) {
            showErrorMessage('Please describe your role and objective in this meeting.');
            objectiveInput.focus();
            return false;
        }

        const scenarioData = {
            title: title,
            context: context,
            objective: objective,
            challenges: challenges || 'Standard workplace challenges',
            type: type,
            created: new Date().toISOString()
        };

        debugLog('‚úÖ Scenario data created', scenarioData);

        const scenarioId = saveScenarioToStorage(scenarioData);
        scenarioData.id = scenarioId;

        customScenarioData = scenarioData;
        updateCustomScenarioCard(scenarioData);

        appState.selectedScenario = 'custom_scenario';
        debugLog('üéØ App state updated', appState);

        const modal = document.getElementById('customScenarioModal');
        if (modal) {
            modal.style.display = 'none';
        }

        updateStartButton();

        debugLog('üéâ Custom scenario created successfully:', title);
        showSuccessMessage(`Custom scenario "${title}" created and saved! You can now start a practice session.`);

        return true;

    } catch (error) {
        debugLog('üí• Error creating custom scenario:', error);
        showErrorMessage(`Error creating custom scenario: ${error.message}`);
        return false;
    }
}

function updateCustomScenarioCard(scenarioData) {
    debugLog('üé® Updating custom scenario card UI');

    const customOption = document.getElementById('customScenarioOption');
    if (!customOption) {
        debugLog('‚ùå Custom scenario card not found');
        return;
    }

    document.querySelectorAll('[data-scenario]').forEach(card => {
        if (card !== customOption) {
            card.classList.remove('selected');
        }
    });

    customOption.classList.add('selected');

    const titleElement = customOption.querySelector('.option-title');
    const descElement = customOption.querySelector('.option-description');

    if (titleElement) {
        titleElement.textContent = scenarioData.title;
    }
    if (descElement) {
        const description = scenarioData.context.length > 100
            ? scenarioData.context.substring(0, 100) + '...'
            : scenarioData.context;
        descElement.textContent = `Custom scenario: ${description}`;
    }

    debugLog('‚úÖ Custom scenario card updated');
}

function resetCustomScenarioCard() {
    debugLog('üîÑ Resetting custom scenario card to default');

    const customOption = document.getElementById('customScenarioOption');
    if (!customOption) return;

    const titleElement = customOption.querySelector('.option-title');
    const descElement = customOption.querySelector('.option-description');

    if (titleElement) titleElement.textContent = 'üéØ Create Custom Scenario';
    if (descElement) descElement.textContent = 'Design your specific meeting situation. Perfect for practicing upcoming real conversations.';
}

function clearCustomScenarioForm() {
    debugLog('üßπ Clearing custom scenario form');

    const fields = ['customScenarioTitle', 'customScenarioContext', 'customScenarioObjective', 'customScenarioChallenges'];
    fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.value = '';
        }
    });

    const typeField = document.getElementById('customScenarioType');
    if (typeField) {
        typeField.value = 'budget_review';
    }
}

// ============================================
// SELECTION HANDLING
// ============================================
function handleSelection(event) {
    debugLog('Selection handler called');
    const card = event.currentTarget;
    const parent = card.parentElement;

    parent.querySelectorAll('.option-card, .personality-card').forEach(c => c.classList.remove('selected'));
    card.classList.add('selected');

    if (card.dataset.role) {
        appState.selectedRole = card.dataset.role;
        debugLog('Selected role', appState.selectedRole);
    } else if (card.dataset.scenario) {
        appState.selectedScenario = card.dataset.scenario;
        debugLog('Selected scenario', appState.selectedScenario);
    } else if (card.dataset.personality) {
        appState.selectedPersonality = card.dataset.personality;
        debugLog('Selected personality', appState.selectedPersonality);
    }

    updateStartButton();
}

// ============================================
// REQUEST DATA BUILDING
// ============================================
function buildCustomScenarioDescription(scenarioData) {
    return `${scenarioData.title}

CONTEXT: ${scenarioData.context}

YOUR OBJECTIVE: ${scenarioData.objective}

EXPECTED CHALLENGES: ${scenarioData.challenges}

MEETING TYPE: ${scenarioData.type}`;
}

function getScenarioDescription(scenarioKey) {
    const scenarios = {
        'budget_cuts': 'You need to discuss budget reductions with your team while maintaining morale and finding creative solutions.',
        'angry_resident': 'Handle a frustrated ratepayer who is upset about service levels and rate increases.'
    };
    return scenarios[scenarioKey] || 'Practice conversation scenario';
}

function getRequestData() {
    debugLog('Building request data');
    const baseData = {
        user_name: `${appState.selectedRole}_user`,
        personality_type: appState.selectedPersonality
    };

    debugLog('üîç REQUEST DATA DEBUG:', {
        selectedRole: appState.selectedRole,
        selectedScenario: appState.selectedScenario,
        selectedPersonality: appState.selectedPersonality,
        hasCustomCharacter: !!customCharacterData,
        hasCustomScenario: !!customScenarioData
    });

    // Handle saved colleagues (NEW)
    if (appState.selectedPersonality && appState.selectedPersonality.startsWith('saved_colleague_')) {
        baseData.custom_character = customCharacterData;
        debugLog('Added saved colleague data:', customCharacterData.name);
    } else if (appState.selectedPersonality === 'custom_character' && customCharacterData) {
        baseData.custom_character = customCharacterData;
        debugLog('Added custom character data');
    }

    // Handle saved scenarios (NEW)
    if (appState.selectedScenario && appState.selectedScenario.startsWith('saved_scenario_')) {
        baseData.custom_scenario = customScenarioData;
        baseData.scenario = buildCustomScenarioDescription(customScenarioData);
        debugLog('Added saved scenario data:', customScenarioData.title);
    } else if (appState.selectedScenario === 'custom_scenario' && customScenarioData) {
        baseData.custom_scenario = customScenarioData;
        baseData.scenario = buildCustomScenarioDescription(customScenarioData);
        debugLog('Added custom scenario data');
    } else {
        baseData.scenario = getScenarioDescription(appState.selectedScenario);
        debugLog('Added standard scenario');
    }

    debugLog('üöÄ FINAL REQUEST DATA:', baseData);
    return baseData;
}

// ============================================
// START BUTTON MANAGEMENT
// ============================================
function updateStartButton() {
    const startBtn = document.getElementById('startConversation');
    const isReady = appState.selectedRole && appState.selectedScenario && appState.selectedPersonality;

    startBtn.disabled = !isReady || !appState.isConnected;

    if (!appState.isConnected) {
        startBtn.innerHTML = '<span>‚ö†Ô∏è</span><span>Connecting to Service...</span>';
    } else if (!isReady) {
        startBtn.innerHTML = '<span>üöÄ</span><span>Begin Practice Session</span>';
    } else {
        startBtn.innerHTML = '<span>üöÄ</span><span>Begin Practice Session</span>';
    }

    debugLog('Start button updated', { ready: isReady, connected: appState.isConnected });
}

// ============================================
// API CONNECTION
// ============================================
async function testAPIConnection() {
    try {
        debugLog('Testing API connection');
        const response = await fetch(`${API_BASE_URL}/health`);
        const data = await response.json();

        if (response.ok) {
            appState.isConnected = true;
            showSuccessMessage('‚úÖ Connected to conversation service successfully');
            debugLog('API connection successful', data);
        } else {
            throw new Error('API health check failed');
        }
    } catch (error) {
        debugLog('API Connection Error', error);
        appState.isConnected = false;
        showConnectionError();
        showErrorMessage('‚ö†Ô∏è Cannot connect to conversation service. Please check your internet connection.');
    } finally {
        updateStartButton();
    }
}

function showConnectionError() {
    const statusIndicator = document.querySelector('.status-indicator');
    statusIndicator.innerHTML = '<div style="width: 8px; height: 8px; background: #dc2626; border-radius: 50%;"></div><span>Service Offline</span>';
    statusIndicator.style.background = '#fef2f2';
    statusIndicator.style.borderColor = '#fecaca';
    statusIndicator.style.color = '#dc2626';
}

// ============================================
// CONVERSATION MANAGEMENT
// ============================================
async function startConversation() {
    debugLog('üöÄ START CONVERSATION CALLED');
    debugLog('üéØ Current app state:', appState);

    try {
        const startBtn = document.getElementById('startConversation');
        startBtn.disabled = true;
        startBtn.innerHTML = '<span>‚è≥</span><span>Starting Session...</span>';

        const requestData = getRequestData();
        debugLog('üì§ Sending request to backend:', requestData);

        const response = await fetch(`${API_BASE_URL}/api/conversations/start`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });

        debugLog('üì• Backend response status:', response.status);

        if (!response.ok) {
            const errorText = await response.text();
            debugLog('‚ùå Backend error response:', errorText);
            throw new Error(`Backend error (${response.status}): ${errorText}`);
        }

        const data = await response.json();
        debugLog('‚úÖ Backend success response:', data);

        if (data.success) {
            appState.currentConversation = data;
            appState.conversationHistory = [{
                sender: data.personality_name,
                content: data.opening_message,
                timestamp: data.timestamp || new Date().toISOString(),
                sender_type: 'ai_personality'
            }];

            const switchSuccess = switchToChat();
            if (!switchSuccess) {
                throw new Error('Failed to switch to chat screen');
            }

            const messagesArea = document.getElementById('messagesArea');
            if (messagesArea) {
                messagesArea.innerHTML = '';
            }

            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');

            if (messageInput) messageInput.disabled = false;
            if (sendButton) sendButton.disabled = false;

            updateChatHeader();
            addSystemMessage('Practice session started. Your conversation partner is ready.');
            addAIMessage(data.opening_message);

            debugLog('üéâ Conversation started successfully');

        } else {
            throw new Error(data.error || 'Backend reported failure');
        }
    } catch (error) {
        debugLog('üí• CONVERSATION START ERROR:', error);
        showErrorMessage(`Failed to start conversation: ${error.message}`);

        const startBtn = document.getElementById('startConversation');
        startBtn.disabled = false;
        startBtn.innerHTML = '<span>üöÄ</span><span>Begin Practice Session</span>';
    }
}

async function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();

    if (!message || !appState.currentConversation) return;

    try {
        debugLog('Sending message', message);

        addUserMessage(message);
        input.value = '';

        input.disabled = true;
        document.getElementById('sendButton').disabled = true;

        const requestData = {
            conversation_id: appState.currentConversation.conversation_id,
            user_message: message,
            personality_data: appState.currentConversation.conversation_data.personality,
            conversation_history: appState.conversationHistory
        };

        debugLog('Sending message request', requestData);

        const response = await fetch(`${API_BASE_URL}/api/conversations/message`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });

        const data = await response.json();
        debugLog('Message response', data);

        if (data.success) {
            addAIMessage(data.ai_response);

            appState.conversationHistory.push({
                sender: 'user',
                content: message,
                timestamp: new Date().toISOString(),
                sender_type: 'user'
            });

            appState.conversationHistory.push({
                sender: appState.currentConversation.personality_name,
                content: data.ai_response,
                timestamp: data.timestamp,
                sender_type: 'ai_personality'
            });

            debugLog('Message exchange completed');
        } else {
            throw new Error(data.error || 'Failed to get AI response');
        }
    } catch (error) {
        debugLog('Error sending message', error);
        addSystemMessage('Sorry, there was an error processing your message. Please try again.');
        showErrorMessage('Error sending message. Please try again.');
    } finally {
        input.disabled = false;
        document.getElementById('sendButton').disabled = false;
        input.focus();
    }
}

function endConversation() {
    if (confirm('Are you sure you want to end this practice session?')) {
        debugLog('Ending conversation');

        switchToSetup();

        document.getElementById('messagesArea').innerHTML = '';
        document.querySelectorAll('.option-card, .personality-card').forEach(card => {
            card.classList.remove('selected');
        });

        // Reset custom options
        if (appState.selectedPersonality === 'custom_character') {
            resetCustomCharacterCard();
        }

        if (appState.selectedScenario === 'custom_scenario') {
            resetCustomScenarioCard();
        }

        // Reset state
        appState.selectedRole = null;
        appState.selectedScenario = null;
        appState.selectedPersonality = null;
        appState.currentConversation = null;
        appState.conversationHistory = [];
        customCharacterData = null;
        customScenarioData = null;

        const messageInput = document.getElementById('messageInput');
        messageInput.value = '';
        messageInput.disabled = true;
        document.getElementById('sendButton').disabled = true;

        updateStartButton();
        debugLog('Conversation ended and reset complete');
    }
}

// ============================================
// CHAT UI FUNCTIONS
// ============================================
function updateChatHeader() {
    const personalities = {
        'infrastructure_engineer': {
            name: 'Terry Mitchell',
            avatar: 'TM',
            description: 'Senior Infrastructure Engineer ‚Ä¢ Technical expert, detail-oriented'
        },
        'community_engagement': {
            name: 'Sarah Chen',
            avatar: 'SC',
            description: 'Community Engagement Officer ‚Ä¢ People-focused, diplomatic'
        },
        'budget_director': {
            name: 'David Walsh',
            avatar: 'DW',
            description: 'Budget & Finance Director ‚Ä¢ Numbers-driven, direct about constraints'
        },
        'union_rep': {
            name: 'Maria Santos',
            avatar: 'MS',
            description: 'Union Representative ‚Ä¢ Assertive advocate for workers\' rights'
        },
        'councillor_thompson': {
            name: 'Robert Thompson',
            avatar: 'RT',
            description: 'Long-term Councillor ‚Ä¢ Steady, consensus-building approach'
        },
        'strategic_planner': {
            name: 'Emily Kim',
            avatar: 'EK',
            description: 'Strategic Planner ‚Ä¢ Analytical yet enthusiastic about new ideas'
        },
        'custom_character': {
            name: customCharacterData ? customCharacterData.name : 'Custom Character',
            avatar: customCharacterData ? customCharacterData.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2) : 'CC',
            description: customCharacterData ? `Custom colleague ‚Ä¢ ${customCharacterData.role || 'Custom character'}` : 'Custom character'
        }
    };

    // NEW: Handle saved colleagues
    let personality;
    if (appState.selectedPersonality && appState.selectedPersonality.startsWith('saved_colleague_') && customCharacterData) {
        personality = {
            name: customCharacterData.name,
            avatar: customCharacterData.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2),
            description: `Saved colleague ‚Ä¢ ${customCharacterData.role || 'Custom character'}`
        };
        console.log('Using saved colleague for chat header:', personality);
    } else {
        personality = personalities[appState.selectedPersonality];
        console.log('Using built-in personality for chat header:', personality);
    }

    if (personality) {
        document.getElementById('participantAvatar').textContent = personality.avatar;
        document.getElementById('participantName').textContent = personality.name;
        document.getElementById('scenarioDescription').textContent = personality.description;
        debugLog('Chat header updated', { selectedPersonality: appState.selectedPersonality, personality });
    } else {
        debugLog('‚ö†Ô∏è Unknown personality type', appState.selectedPersonality);
        document.getElementById('participantAvatar').textContent = 'AI';
        document.getElementById('participantName').textContent = 'Practice Partner';
        document.getElementById('scenarioDescription').textContent = 'Conversation practice session';
    }
}

function addSystemMessage(content) {
    const messagesArea = document.getElementById('messagesArea');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'system-message';
    messageDiv.textContent = content;
    messagesArea.appendChild(messageDiv);
    scrollToBottom();
}

function addUserMessage(content) {
    addMessage('user', content, 'You');
}

function addAIMessage(content) {
    const personalities = {
        'infrastructure_engineer': 'TM',
        'community_engagement': 'SC',
        'budget_director': 'DW',
        'union_rep': 'MS',
        'councillor_thompson': 'RT',
        'strategic_planner': 'EK',
        'custom_character': customCharacterData ? customCharacterData.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2) : 'CC'
    };

    // NEW: Handle saved colleagues
    let avatar;
    if (appState.selectedPersonality && appState.selectedPersonality.startsWith('saved_colleague_') && customCharacterData) {
        avatar = customCharacterData.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
        console.log('Using saved colleague avatar for AI message:', avatar, 'from:', customCharacterData.name);
    } else {
        avatar = personalities[appState.selectedPersonality] || 'AI';
        console.log('Using built-in avatar for AI message:', avatar);
    }

    debugLog('Adding AI message', { personality: appState.selectedPersonality, avatar, content: content.substring(0, 50) + '...' });
    addMessage('ai', content, avatar);
}

function addMessage(type, content, avatar) {
    const messagesArea = document.getElementById('messagesArea');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}`;

    const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

    messageDiv.innerHTML = [
        '<div class="message-avatar">' + avatar + '</div>',
        '<div class="message-content">',
            '<div class="message-text">' + content + '</div>',
            '<div class="message-time">' + timestamp + '</div>',
        '</div>'
    ].join('');

    messagesArea.appendChild(messageDiv);
    scrollToBottom();
}

function scrollToBottom() {
    const messagesArea = document.getElementById('messagesArea');
    messagesArea.scrollTop = messagesArea.scrollHeight;
}

function handleInputKeydown(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
    }
}

// ============================================
// EVENT LISTENERS SETUP
// ============================================
function setupEventListeners() {
    debugLog('üîß Setting up all event listeners');

    // Core selection handling for roles and scenarios
    document.querySelectorAll('.option-card').forEach(card => {
        if (card.id === 'customCharacterOption' || card.id === 'customScenarioOption') {
            return; // Skip - these have special handlers
        }
        card.addEventListener('click', handleSelection);
    });

    // Personality card handling (excluding custom)
    document.querySelectorAll('.personality-card').forEach(card => {
        if (card.id === 'customCharacterOption') {
            return; // Skip - has special handler
        }
        card.addEventListener('click', handleSelection);
    });

    // Main action buttons
    document.getElementById('startConversation').addEventListener('click', startConversation);
    document.getElementById('endConversation').addEventListener('click', endConversation);
    document.getElementById('sendButton').addEventListener('click', sendMessage);

    // Message input
    const messageInput = document.getElementById('messageInput');
    if (messageInput) {
        messageInput.addEventListener('keydown', handleInputKeydown);
    }

    // Setup custom character system
    setupCustomCharacterListeners();

    // Setup custom scenario system
    setupCustomScenarioListeners();

    debugLog('‚úÖ All event listeners set up successfully');
}

function setupCustomCharacterListeners() {
    debugLog('üîß Setting up custom character event listeners');

    const customCharacterOption = document.getElementById('customCharacterOption');
    if (customCharacterOption) {
        customCharacterOption.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            debugLog('üé≠ Custom character option clicked');
            showCustomCharacterModal();
        });
        debugLog('‚úÖ Custom character option listener attached');
    }

    // Modal buttons
    const cancelBtn = document.getElementById('cancelCustomCharacter');
    const saveBtn = document.getElementById('saveCustomCharacter');

    if (cancelBtn) {
        cancelBtn.addEventListener('click', function(e) {
            e.preventDefault();
            cancelCustomCharacter();
        });
        debugLog('‚úÖ Cancel button listener attached');
    }

    if (saveBtn) {
        saveBtn.addEventListener('click', function(e) {
            e.preventDefault();
            saveCustomCharacter();
        });
        debugLog('‚úÖ Save button listener attached');
    }

    // Modal overlay click to close
    const modal = document.getElementById('customCharacterModal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                cancelCustomCharacter();
            }
        });
        debugLog('‚úÖ Modal overlay listener attached');
    }

    // Form keyboard shortcuts
    const form = document.getElementById('characterCreationForm');
    if (form) {
        form.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.ctrlKey) {
                e.preventDefault();
                saveCustomCharacter();
            }
            if (e.key === 'Escape') {
                e.preventDefault();
                cancelCustomCharacter();
            }
        });
        debugLog('‚úÖ Form keyboard handlers attached');
    }
}

function setupCustomScenarioListeners() {
    debugLog('üîß Setting up custom scenario event listeners');

    const customScenarioOption = document.getElementById('customScenarioOption');
    if (customScenarioOption) {
        customScenarioOption.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            debugLog('üìã Custom scenario option clicked');
            showCustomScenarioModal();
        });
        debugLog('‚úÖ Custom scenario option listener attached');
    }

    // Modal buttons
    const cancelBtn = document.getElementById('cancelCustomScenario');
    const saveBtn = document.getElementById('saveCustomScenario');

    if (cancelBtn) {
        cancelBtn.addEventListener('click', function(e) {
            e.preventDefault();
            cancelCustomScenario();
        });
        debugLog('‚úÖ Scenario cancel button listener attached');
    }

    if (saveBtn) {
        saveBtn.addEventListener('click', function(e) {
            e.preventDefault();
            saveCustomScenario();
        });
        debugLog('‚úÖ Scenario save button listener attached');
    }

    // Modal overlay
    const modal = document.getElementById('customScenarioModal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                cancelCustomScenario();
            }
        });
        debugLog('‚úÖ Scenario modal overlay listener attached');
    }
}
// ============================================
// DYNAMIC CONTENT LOADING (PHASE 1)
// ============================================
function loadSavedColleagues() {
    debugLog('üìö Loading saved colleagues into personality grid');

    try {
        const savedColleagues = getStoredColleagues();
        const colleagueCount = Object.keys(savedColleagues).length;

        console.log(`Phase 1: Found ${colleagueCount} saved colleagues in storage`);

        if (colleagueCount === 0) {
            console.log('No saved colleagues found - create some to test!');
            return;
        }

        const personalityGrid = document.querySelector('.personality-grid');
        if (!personalityGrid) {
            console.error('‚ùå Personality grid not found');
            return;
        }

        // Add saved colleagues to the grid
        Object.values(savedColleagues).forEach(colleague => {
            console.log('Creating card for:', colleague.name);
            const colleagueCard = createSavedColleagueCard(colleague);
            personalityGrid.insertBefore(colleagueCard, personalityGrid.lastElementChild);
        });

        console.log(`‚úÖ Added ${colleagueCount} saved colleague cards to personality grid`);

    } catch (error) {
        console.error('‚ùå Error loading saved colleagues:', error);
    }
}
function createSavedColleagueCard(colleague) {
    debugLog('üé® Creating card for saved colleague:', colleague.name);

    const cardDiv = document.createElement('div');
    cardDiv.className = 'personality-card saved-colleague';
    cardDiv.dataset.personality = `saved_colleague_${colleague.id}`;

    // Create avatar initials
    const initials = colleague.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);

    cardDiv.innerHTML = `
        <div class="personality-header">
            <div class="personality-avatar saved-avatar">${initials}</div>
            <div class="personality-info">
                <div class="personality-name">${colleague.name}</div>
                <div class="personality-role">${colleague.role}</div>
            </div>
            <div class="saved-badge">üíæ Saved</div>
        </div>
        <div class="saved-personality-preview">
            <p class="saved-description">${colleague.personality.length > 80 ? colleague.personality.substring(0, 80) + '...' : colleague.personality}</p>
        </div>
        <div class="personality-description">
            <strong>Custom colleague:</strong> ${colleague.motivations || 'Professional development focused'}
        </div>
    `;

    // Add click handler for saved colleague
    cardDiv.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();

        // Clear other selections
        document.querySelectorAll('.personality-card').forEach(card => {
            card.classList.remove('selected');
        });

        // Select this card
        cardDiv.classList.add('selected');

        // Set app state
        appState.selectedPersonality = `saved_colleague_${colleague.id}`;

        // Store the colleague data for use in conversation
        customCharacterData = colleague;

        debugLog('‚úÖ Selected saved colleague:', colleague.name);
        updateStartButton();
    });

    return cardDiv;
}
function loadSavedScenarios() {
    debugLog('üìã Loading saved scenarios into scenario grid');

    try {
        const savedScenarios = getStoredScenarios();
        const scenarioCount = Object.keys(savedScenarios).length;

        console.log(`Phase 1: Found ${scenarioCount} saved scenarios in storage`);

        if (scenarioCount === 0) {
            console.log('No saved scenarios found - create some to test!');
            return;
        }

        const scenarioGrid = document.querySelector('[data-scenario="budget_cuts"]').parentElement;
        if (!scenarioGrid) {
            console.error('‚ùå Scenario grid not found');
            return;
        }

        // Add saved scenarios to the grid
        Object.values(savedScenarios).forEach(scenario => {
            console.log('Creating card for scenario:', scenario.title);
            const scenarioCard = createSavedScenarioCard(scenario);
            scenarioGrid.insertBefore(scenarioCard, scenarioGrid.lastElementChild);
        });

        console.log(`‚úÖ Added ${scenarioCount} saved scenario cards to scenario grid`);

    } catch (error) {
        console.error('‚ùå Error loading saved scenarios:', error);
    }
}

function createSavedScenarioCard(scenario) {
    debugLog('üé® Creating card for saved scenario:', scenario.title);

    const cardDiv = document.createElement('div');
    cardDiv.className = 'option-card saved-scenario';
    cardDiv.dataset.scenario = `saved_scenario_${scenario.id}`;

    cardDiv.innerHTML = `
        <div class="option-title">
            <span class="saved-badge-small">üíæ</span> ${scenario.title}
        </div>
        <div class="option-description">
            <strong>Type:</strong> ${scenario.type.replace('_', ' ')} ‚Ä¢ ${scenario.context.length > 80 ? scenario.context.substring(0, 80) + '...' : scenario.context}
        </div>
    `;

    // Add click handler for saved scenario
    cardDiv.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();

        // Clear other selections
        document.querySelectorAll('[data-scenario]').forEach(card => {
            card.classList.remove('selected');
        });

        // Select this card
        cardDiv.classList.add('selected');

        // Set app state
        appState.selectedScenario = `saved_scenario_${scenario.id}`;

        // Store the scenario data for use in conversation
        customScenarioData = scenario;

        debugLog('‚úÖ Selected saved scenario:', scenario.title);
        updateStartButton();
    });

    return cardDiv;
}
// ============================================
// INITIALIZATION
// ============================================
function initializeApp() {
    debugLog('üöÄ Initializing Professional Conversation Trainer');
    setupEventListeners();
    testAPIConnection();
    updateStorageCounts();

    // NEW: Load saved content
    loadSavedColleagues();
    loadSavedScenarios();
}

// Initialize Application
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();

    // Update storage counts periodically
    setInterval(updateStorageCounts, 2000);
});
// ============================================
// IMPORT FUNCTIONS - Add these to your script
// ============================================

function importColleagues() {
    debugLog('üìÇ Starting colleague import process');

    // Create file input element
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.json';
    fileInput.style.display = 'none';

    fileInput.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) {
            debugLog('‚ùå No file selected');
            return;
        }

        debugLog('üìÑ File selected:', file.name);

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importData = JSON.parse(e.target.result);
                debugLog('üìã Import data parsed:', importData);

                // Validate file structure
                if (!importData.type || importData.type !== 'conversation_trainer_colleagues') {
                    throw new Error('Invalid file format. Please select a valid colleagues export file.');
                }

                if (!importData.colleagues || typeof importData.colleagues !== 'object') {
                    throw new Error('No colleague data found in file.');
                }

                // Get existing colleagues
                const existingColleagues = getStoredColleagues();
                const importedColleagues = importData.colleagues;

                let importedCount = 0;
                let duplicateCount = 0;

                // Process each imported colleague
                Object.values(importedColleagues).forEach(colleague => {
                    // Check for duplicates by name and role
                    const isDuplicate = Object.values(existingColleagues).some(existing =>
                        existing.name === colleague.name && existing.role === colleague.role
                    );

                    if (isDuplicate) {
                        duplicateCount++;
                        debugLog('‚ö†Ô∏è Duplicate found, skipping:', colleague.name);
                    } else {
                        // Generate new ID and add to storage
                        const newId = `colleague_imported_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                        colleague.id = newId;
                        colleague.imported_at = new Date().toISOString();

                        existingColleagues[newId] = colleague;
                        importedCount++;
                        debugLog('‚úÖ Imported colleague:', colleague.name);
                    }
                });

                // Save updated colleagues to storage
                localStorage.setItem('conversation_trainer_colleagues', JSON.stringify(existingColleagues));
                updateStorageCounts();

                // Show success message
                let message = `Successfully imported ${importedCount} colleague${importedCount === 1 ? '' : 's'}!`;
                if (duplicateCount > 0) {
                    message += ` (${duplicateCount} duplicate${duplicateCount === 1 ? '' : 's'} skipped)`;
                }

                showSuccessMessage(message);
                debugLog('üéâ Import completed', { imported: importedCount, duplicates: duplicateCount });

            } catch (error) {
                debugLog('‚ùå Import error:', error);
                showErrorMessage(`Import failed: ${error.message}`);
            }
        };

        reader.onerror = function() {
            debugLog('‚ùå File reading error');
            showErrorMessage('Error reading file. Please try again.');
        };

        reader.readAsText(file);
    };

    // Trigger file selection
    document.body.appendChild(fileInput);
    fileInput.click();
    document.body.removeChild(fileInput);
}

function importScenarios() {
    debugLog('üìÇ Starting scenario import process');

    // Create file input element
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.json';
    fileInput.style.display = 'none';

    fileInput.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) {
            debugLog('‚ùå No file selected');
            return;
        }

        debugLog('üìÑ File selected:', file.name);

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importData = JSON.parse(e.target.result);
                debugLog('üìã Import data parsed:', importData);

                // Validate file structure
                if (!importData.type || importData.type !== 'conversation_trainer_scenarios') {
                    throw new Error('Invalid file format. Please select a valid scenarios export file.');
                }

                if (!importData.scenarios || typeof importData.scenarios !== 'object') {
                    throw new Error('No scenario data found in file.');
                }

                // Get existing scenarios
                const existingScenarios = getStoredScenarios();
                const importedScenarios = importData.scenarios;

                let importedCount = 0;
                let duplicateCount = 0;

                // Process each imported scenario
                Object.values(importedScenarios).forEach(scenario => {
                    // Check for duplicates by title
                    const isDuplicate = Object.values(existingScenarios).some(existing =>
                        existing.title === scenario.title
                    );

                    if (isDuplicate) {
                        duplicateCount++;
                        debugLog('‚ö†Ô∏è Duplicate found, skipping:', scenario.title);
                    } else {
                        // Generate new ID and add to storage
                        const newId = `scenario_imported_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                        scenario.id = newId;
                        scenario.imported_at = new Date().toISOString();

                        existingScenarios[newId] = scenario;
                        importedCount++;
                        debugLog('‚úÖ Imported scenario:', scenario.title);
                    }
                });

                // Save updated scenarios to storage
                localStorage.setItem('conversation_trainer_scenarios', JSON.stringify(existingScenarios));
                updateStorageCounts();

                // Show success message
                let message = `Successfully imported ${importedCount} scenario${importedCount === 1 ? '' : 's'}!`;
                if (duplicateCount > 0) {
                    message += ` (${duplicateCount} duplicate${duplicateCount === 1 ? '' : 's'} skipped)`;
                }

                showSuccessMessage(message);
                debugLog('üéâ Import completed', { imported: importedCount, duplicates: duplicateCount });

            } catch (error) {
                debugLog('‚ùå Import error:', error);
                showErrorMessage(`Import failed: ${error.message}`);
            }
        };

        reader.onerror = function() {
            debugLog('‚ùå File reading error');
            showErrorMessage('Error reading file. Please try again.');
        };

        reader.readAsText(file);
    };

    // Trigger file selection
    document.body.appendChild(fileInput);
    fileInput.click();
    document.body.removeChild(fileInput);
}
function refreshSavedContent() {
    debugLog('üîÑ Refreshing saved content in UI');

    try {
        // Remove existing saved colleague cards
        document.querySelectorAll('.personality-card.saved-colleague').forEach(card => {
            card.remove();
        });

        // Remove existing saved scenario cards
        document.querySelectorAll('.option-card.saved-scenario').forEach(card => {
            card.remove();
        });

        // Reload saved content
        loadSavedColleagues();
        loadSavedScenarios();

        console.log('‚úÖ Saved content refreshed successfully');

    } catch (error) {
        console.error('‚ùå Error refreshing saved content:', error);
    }
}
// ============================================
// BULK IMPORT FUNCTION (Import Both Types)
// ============================================

function importData() {
    debugLog('üìÇ Starting bulk data import process');

    // Create file input element
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.json';
    fileInput.style.display = 'none';

    fileInput.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) {
            debugLog('‚ùå No file selected');
            return;
        }

        debugLog('üìÑ File selected:', file.name);

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importData = JSON.parse(e.target.result);
                debugLog('üìã Import data parsed:', importData);

                // Determine file type and import accordingly
                if (importData.type === 'conversation_trainer_colleagues') {
                    // Import colleagues
                    importColleaguesData(importData);
                } else if (importData.type === 'conversation_trainer_scenarios') {
                    // Import scenarios
                    importScenariosData(importData);
                } else {
                    throw new Error('Unknown file format. Please select a valid export file.');
                }

            } catch (error) {
                debugLog('‚ùå Import error:', error);
                showErrorMessage(`Import failed: ${error.message}`);
            }
        };

        reader.onerror = function() {
            debugLog('‚ùå File reading error');
            showErrorMessage('Error reading file. Please try again.');
        };

        reader.readAsText(file);
    };

    // Trigger file selection
    document.body.appendChild(fileInput);
    fileInput.click();
    document.body.removeChild(fileInput);
}

// Helper functions for bulk import
function importColleaguesData(importData) {
    if (!importData.colleagues || typeof importData.colleagues !== 'object') {
        throw new Error('No colleague data found in file.');
    }

    const existingColleagues = getStoredColleagues();
    const importedColleagues = importData.colleagues;

    let importedCount = 0;
    let duplicateCount = 0;

    Object.values(importedColleagues).forEach(colleague => {
        const isDuplicate = Object.values(existingColleagues).some(existing =>
            existing.name === colleague.name && existing.role === colleague.role
        );

        if (isDuplicate) {
            duplicateCount++;
        } else {
            const newId = `colleague_imported_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            colleague.id = newId;
            colleague.imported_at = new Date().toISOString();
            existingColleagues[newId] = colleague;
            importedCount++;
        }
    });

    localStorage.setItem('conversation_trainer_colleagues', JSON.stringify(existingColleagues));
    updateStorageCounts();

    let message = `Successfully imported ${importedCount} colleague${importedCount === 1 ? '' : 's'}!`;
    if (duplicateCount > 0) {
        message += ` (${duplicateCount} duplicate${duplicateCount === 1 ? '' : 's'} skipped)`;
    }

    showSuccessMessage(message);
}

function importScenariosData(importData) {
    if (!importData.scenarios || typeof importData.scenarios !== 'object') {
        throw new Error('No scenario data found in file.');
    }

    const existingScenarios = getStoredScenarios();
    const importedScenarios = importData.scenarios;

    let importedCount = 0;
    let duplicateCount = 0;

    Object.values(importedScenarios).forEach(scenario => {
        const isDuplicate = Object.values(existingScenarios).some(existing =>
            existing.title === scenario.title
        );

        if (isDuplicate) {
            duplicateCount++;
        } else {
            const newId = `scenario_imported_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            scenario.id = newId;
            scenario.imported_at = new Date().toISOString();
            existingScenarios[newId] = scenario;
            importedCount++;
        }
    });

    localStorage.setItem('conversation_trainer_scenarios', JSON.stringify(existingScenarios));
    updateStorageCounts();

    let message = `Successfully imported ${importedCount} scenario${importedCount === 1 ? '' : 's'}!`;
    if (duplicateCount > 0) {
        message += ` (${duplicateCount} duplicate${duplicateCount === 1 ? '' : 's'} skipped)`;
    }

    showSuccessMessage(message);
}
// ============================================
// ADDITIONAL STORAGE MANAGEMENT FUNCTIONS
// ============================================

function clearAllStorage() {
    const colleagues = getStoredColleagues();
    const scenarios = getStoredScenarios();

    const colleagueCount = Object.keys(colleagues).length;
    const scenarioCount = Object.keys(scenarios).length;

    if (colleagueCount === 0 && scenarioCount === 0) {
        showSuccessMessage('No data to clear. Storage is already empty.');
        return;
    }

    const message = `Are you sure you want to delete all stored data?\n\nThis will permanently remove:\n‚Ä¢ ${colleagueCount} saved colleague${colleagueCount === 1 ? '' : 's'}\n‚Ä¢ ${scenarioCount} saved scenario${scenarioCount === 1 ? '' : 's'}\n\nThis action cannot be undone.`;

    if (confirm(message)) {
        try {
            localStorage.removeItem('conversation_trainer_colleagues');
            localStorage.removeItem('conversation_trainer_scenarios');
            updateStorageCounts();

            debugLog('üóëÔ∏è All storage cleared');
            showSuccessMessage('All stored data has been cleared successfully.');

        } catch (error) {
            debugLog('‚ùå Error clearing storage:', error);
            showErrorMessage('Error clearing storage. Please try again.');
        }
    }
}

// Enhanced test storage function with more details
function testStorage() {
    const colleagues = getStoredColleagues();
    const scenarios = getStoredScenarios();

    console.log('üìä === CONVERSATION TRAINER STORAGE REPORT ===');
    console.log('üìö Stored Colleagues:', colleagues);
    console.log('üìã Stored Scenarios:', scenarios);
    console.log('üìà Storage Statistics:', {
        colleagues: {
            count: Object.keys(colleagues).length,
            totalSize: JSON.stringify(colleagues).length + ' characters'
        },
        scenarios: {
            count: Object.keys(scenarios).length,
            totalSize: JSON.stringify(scenarios).length + ' characters'
        },
        lastUpdated: new Date().toISOString()
    });

    // Test localStorage availability
    try {
        localStorage.setItem('test', 'test');
        localStorage.removeItem('test');
        console.log('‚úÖ localStorage is working properly');
    } catch (error) {
        console.log('‚ùå localStorage error:', error);
    }

    console.log('================================================');

    showSuccessMessage('Storage report generated. Check browser console for detailed information.');
}

debugLog('üé® Professional Conversation Trainer Loaded');
</script>
</body>
</html>