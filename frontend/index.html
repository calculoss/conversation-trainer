<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversation Trainer - Professional Development Platform</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            color: #334155;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
            border-bottom: 1px solid #e2e8f0;
            padding: 1rem 2rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #3b82f6, #1e40af);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .logo-text h1 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: -2px;
        }

        .logo-text p {
            font-size: 0.875rem;
            color: #64748b;
            font-weight: 400;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 8px;
            font-size: 0.875rem;
            color: #166534;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #16a34a;
            border-radius: 50%;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            width: 100%;
        }

        /* Setup Screen */
        .setup-screen {
            display: block;
        }

        .setup-screen.hidden {
            display: none !important;
        }

        .setup-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .setup-panel {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            border: 1px solid #f1f5f9;
        }

        .panel-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .panel-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .panel-icon.role {
            background: #eff6ff;
            color: #2563eb;
        }

        .panel-icon.scenario {
            background: #f0fdf4;
            color: #16a34a;
        }

        .panel-icon.personality {
            background: #fef3c7;
            color: #d97706;
        }

        .panel-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1e293b;
        }

        .selection-grid {
            display: grid;
            gap: 0.75rem;
        }

        .option-card {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .option-card:hover {
            border-color: #cbd5e1;
            background: #f1f5f9;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .option-card.selected {
            border-color: #3b82f6;
            background: #eff6ff;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .option-card.selected::after {
            content: 'âœ“';
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            width: 20px;
            height: 20px;
            background: #3b82f6;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .option-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.25rem;
        }

        .option-description {
            font-size: 0.875rem;
            color: #64748b;
            line-height: 1.4;
        }

        /* Enhanced Personality Grid */
        .personality-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }

        .personality-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .personality-card:hover {
            border-color: #cbd5e1;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .personality-card.selected {
            border-color: #3b82f6;
            background: #eff6ff;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .personality-card.selected::after {
            content: 'âœ“';
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            width: 20px;
            height: 20px;
            background: #3b82f6;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .personality-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .personality-avatar {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: linear-gradient(135deg, #3b82f6, #1e40af);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .personality-name {
            font-weight: 600;
            font-size: 0.95rem;
            color: #1e293b;
        }

        .personality-role {
            font-size: 0.8rem;
            color: #64748b;
        }

        .disc-preview {
            margin-bottom: 1rem;
            background: #f8fafc;
            padding: 0.75rem;
            border-radius: 8px;
        }

        .disc-bar {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.4rem;
        }

        .disc-bar:last-child {
            margin-bottom: 0;
        }

        .disc-label {
            font-weight: 600;
            font-size: 0.8rem;
            width: 15px;
            color: #374151;
        }

        .disc-fill {
            height: 8px;
            border-radius: 4px;
            transition: width 0.3s ease;
            flex: 1;
            max-width: 100px;
        }

        .disc-score {
            font-size: 0.75rem;
            font-weight: 500;
            color: #64748b;
            min-width: 30px;
            text-align: right;
        }

        .personality-description {
            font-size: 0.85rem;
            color: #64748b;
            line-height: 1.4;
        }

        .custom-personality-preview {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 1rem;
        }

        .custom-personality-preview p {
            font-size: 0.85rem;
            color: #64748b;
            margin: 0;
        }

        /* Chat Screen */
        .chat-screen {
            display: none;
            background: white;
            border-radius: 16px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            border: 1px solid #f1f5f9;
            height: 75vh;
            overflow: hidden;
            flex-direction: column;
        }

        .chat-screen.active {
            display: flex !important;
        }

        .chat-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #f1f5f9;
            background: #f8fafc;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .chat-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .participant-avatar {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .chat-details h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 2px;
        }

        .chat-details p {
            font-size: 0.875rem;
            color: #64748b;
        }

        .messages-area {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            background: #fafbfc;
        }

        .message {
            display: flex;
            margin-bottom: 1.5rem;
            align-items: flex-end;
            gap: 0.75rem;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 600;
            color: #64748b;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: #3b82f6;
            color: white;
        }

        .message.ai .message-avatar {
            background: #f59e0b;
            color: white;
        }

        .message-content {
            max-width: 70%;
            min-width: 250px;
            padding: 1rem 1.25rem;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.08);
            position: relative;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .message.user .message-content {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .message-text {
            font-size: 0.95rem;
            line-height: 1.6;
            margin: 0;
            white-space: pre-wrap;
        }

        .message-time {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 0.5rem;
        }

        .input-area {
            padding: 2rem;
            border-top: 1px solid #f1f5f9;
            background: white;
            flex-shrink: 0;
        }

        .input-container {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
        }

        .message-input {
            flex: 1;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1rem 1.25rem;
            font-size: 1rem;
            line-height: 1.5;
            resize: none;
            min-height: 48px;
            max-height: 120px;
            outline: none;
            transition: border-color 0.2s ease;
            font-family: inherit;
        }

        .message-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .send-button {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 1rem 1.5rem;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 90px;
            justify-content: center;
        }

        .send-button:hover:not(:disabled) {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .send-button:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
            transform: none;
        }

        /* Action Panel */
        .action-panel {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            border: 1px solid #f1f5f9;
            text-align: center;
        }

        .start-button {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 1rem 2rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .start-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .start-button:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .secondary-button {
            background: #f8fafc;
            color: #64748b;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 0.75rem 1.5rem;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 0 0.5rem;
        }

        .secondary-button:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }

        /* System Messages */
        .system-message {
            text-align: center;
            padding: 1.5rem;
            color: #64748b;
            font-size: 0.9rem;
            font-style: italic;
            margin: 1rem 0;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        /* Messages */
        .success-message, .error-message {
            padding: 1rem;
            border-radius: 12px;
            margin: 1rem 0;
            font-size: 0.95rem;
            display: none;
        }

        .success-message {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #166534;
        }

        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
        }

        /* Enhanced Custom Character Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(4px);
        }
        /* ============================================
   SAVED CONTENT STYLING (PHASE 1)
   ============================================ */

        /* Saved Colleague Cards */
        .personality-card.saved-colleague {
            border: 2px solid #f59e0b;
            background: linear-gradient(135deg, #fef3c7, #fbbf24);
            position: relative;
        }

        .personality-card.saved-colleague:hover {
            border-color: #d97706;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px -2px rgba(245, 158, 11, 0.25);
        }

        .personality-card.saved-colleague.selected {
            border-color: #f59e0b;
            background: linear-gradient(135deg, #fef3c7, #fbbf24);
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
        }

        .saved-avatar {
            background: linear-gradient(135deg, #f59e0b, #d97706) !important;
            color: white !important;
        }

        .saved-badge {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: #065f46;
            color: #d1fae5;
            font-size: 0.7rem;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-weight: 600;
        }

        .saved-personality-preview {
            background: rgba(255, 255, 255, 0.7);
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .saved-description {
            font-size: 0.85rem;
            color: #374151;
            line-height: 1.4;
            margin: 0;
            font-style: italic;
        }
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 16px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #f1f5f9;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
            margin: 0;
        }

        .form-section {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #f1f5f9;
        }

        .form-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-description {
            font-size: 0.9rem;
            color: #64748b;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #374151;
            font-size: 0.95rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: border-color 0.2s ease;
            font-family: inherit;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .btn {
            flex: 1;
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-secondary {
            background: #f8fafc;
            border-color: #e2e8f0;
            color: #64748b;
        }

        .btn-secondary:hover {
            background: #f1f5f9;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        /* Responsive adjustments for personality grid */
        @media (max-width: 768px) {
            .personality-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }

            .personality-card {
                padding: 0.75rem;
            }

            .setup-container {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .header-content {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .main-content {
                padding: 1rem;
            }

            .setup-panel {
                padding: 1.5rem;
            }

            .message-content {
                max-width: 90%;
            }

            .messages-area {
                padding: 1rem;
            }

            .input-area {
                padding: 1.5rem;
            }

            .modal-content {
                width: 95%;
                padding: 1.5rem;
            }

            .form-row {
                flex-direction: column;
                gap: 0.75rem;
            }
        }
        /* Saved Scenario Cards */
        .option-card.saved-scenario {
            border: 2px solid #10b981;
            background: linear-gradient(135deg, #d1fae5, #6ee7b7);
            position: relative;
        }

        .option-card.saved-scenario:hover {
            border-color: #059669;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px -1px rgba(16, 185, 129, 0.25);
        }

        .option-card.saved-scenario.selected {
            border-color: #10b981;
            background: linear-gradient(135deg, #d1fae5, #6ee7b7);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }

        .saved-badge-small {
            display: inline-block;
            font-size: 0.8rem;
            margin-right: 0.3rem;
        }
        /* ============================================
           TAB INTERFACE STYLING (PHASE 2)
           ============================================ */

        /* Tab Navigation */
        .tab-navigation {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        .tab-nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            padding: 0 2rem;
        }

        .tab-button {
            background: none;
            border: none;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            color: #64748b;
            font-weight: 500;
            font-size: 0.95rem;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
            position: relative;
        }

        .tab-button:hover {
            color: #3b82f6;
            background: #f8fafc;
        }

        .tab-button.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
            background: #eff6ff;
        }

        .tab-icon {
            font-size: 1.1rem;
        }

        .tab-label {
            white-space: nowrap;
        }

        .tab-count {
            background: #3b82f6;
            color: white;
            font-size: 0.75rem;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            min-width: 1.5rem;
            text-align: center;
            line-height: 1;
        }

        /* Tab Content */
        .tab-content-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .tab-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #f1f5f9;
        }

        .tab-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .tab-header p {
            color: #64748b;
            font-size: 1rem;
        }

        /* Enhanced Colleague Management */
        .colleague-management,
        .scenario-management {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            border: 1px solid #f1f5f9;
        }

        .colleagues-toolbar,
        .scenarios-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            gap: 1rem;
        }

        .search-filter-section {
            display: flex;
            gap: 1rem;
            flex: 1;
            max-width: 500px;
        }

        .search-input {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.95rem;
            outline: none;
            transition: border-color 0.2s ease;
        }

        .search-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .filter-select {
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.95rem;
            background: white;
            cursor: pointer;
            min-width: 150px;
        }

        .action-buttons {
            display: flex;
            gap: 0.75rem;
        }

        .btn {
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #f8fafc;
            border-color: #e2e8f0;
            color: #64748b;
        }

        .btn-secondary:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }

        /* Grids */
        .colleagues-grid,
        .scenarios-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: #64748b;
            border: 2px dashed #e2e8f0;
            border-radius: 12px;
            background: #f8fafc;
        }

        .empty-state h3 {
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            margin-bottom: 1.5rem;
        }

        .empty-state.hidden {
            display: none;
        }

        /* DISC Explorer */
        .disc-content {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            border: 1px solid #f1f5f9;
        }

        .disc-overview {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #f1f5f9;
        }

        .disc-overview h3 {
            color: #1e293b;
            font-size: 1.25rem;
            margin-bottom: 1rem;
        }

        .disc-types-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .disc-type-card {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.2s ease;
        }

        .disc-type-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .disc-type-header {
            text-align: center;
            margin-bottom: 1rem;
        }

        .disc-type-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            margin-bottom: 0.5rem;
        }

        .disc-type-icon.dominant {
            background: linear-gradient(135deg, #dc2626, #991b1b);
        }

        .disc-type-icon.influence {
            background: linear-gradient(135deg, #d97706, #92400e);
        }

        .disc-type-icon.steadiness {
            background: linear-gradient(135deg, #16a34a, #15803d);
        }

        .disc-type-icon.conscientiousness {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
        }

        .disc-type-header h4 {
            color: #1e293b;
            margin-bottom: 0.25rem;
        }

        .disc-percentage {
            background: #e2e8f0;
            color: #64748b;
            font-size: 0.8rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
        }

        .disc-type-content p {
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 0.75rem;
        }

        .disc-type-content p:last-child {
            margin-bottom: 0;
        }

        .disc-workplace-section {
            margin: 2rem 0;
            padding: 1.5rem;
            background: #f8fafc;
            border-radius: 12px;
        }

        .disc-workplace-section h3 {
            color: #1e293b;
            margin-bottom: 1rem;
        }

        .workplace-examples {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .workplace-example {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }

        .workplace-example h4 {
            color: #1e293b;
            font-size: 0.95rem;
            margin-bottom: 0.5rem;
        }

        .workplace-example p {
            font-size: 0.85rem;
            color: #64748b;
            margin: 0;
        }

        .coming-soon-section {
            margin-top: 2rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            border-radius: 12px;
            border: 1px solid #bfdbfe;
        }

        .coming-soon-section h3 {
            color: #1e40af;
            margin-bottom: 1rem;
        }

        .feature-preview {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #bfdbfe;
        }

        .feature-preview h4 {
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .feature-preview p {
            color: #64748b;
            margin: 0;
        }

        /* Panel width adjustment for Quick Start */
        .setup-panel.full-width {
            grid-column: 1 / -1;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .tab-nav-container {
                padding: 0 1rem;
                overflow-x: auto;
            }

            .tab-button {
                padding: 0.75rem 1rem;
                flex-shrink: 0;
            }

            .tab-label {
                display: none;
            }

            .colleagues-toolbar,
            .scenarios-toolbar {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }

            .search-filter-section {
                max-width: none;
            }

            .action-buttons {
                justify-content: stretch;
            }

            .btn {
                flex: 1;
                justify-content: center;
            }

            .disc-types-grid {
                grid-template-columns: 1fr;
            }

            .workplace-examples {
                grid-template-columns: 1fr;
            }
        }
        /* ============================================
           ENHANCED CARDS STYLING (PHASE 2)
           ============================================ */

        /* Enhanced Colleague Cards */
        .enhanced-colleague-card,
        .enhanced-scenario-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.2s ease;
            position: relative;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        .enhanced-colleague-card:hover,
        .enhanced-scenario-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-color: #cbd5e1;
        }

        .enhanced-colleague-card {
            border-left: 4px solid #f59e0b;
        }

        .enhanced-scenario-card {
            border-left: 4px solid #10b981;
        }

        .enhanced-card-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .enhanced-avatar {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            margin-right: 0.75rem;
            flex-shrink: 0;
        }

        .enhanced-info {
            flex: 1;
        }

        .enhanced-info h4 {
            color: #1e293b;
            font-size: 1rem;
            font-weight: 600;
            margin: 0 0 0.25rem 0;
            line-height: 1.2;
        }

        .enhanced-info p {
            color: #64748b;
            font-size: 0.85rem;
            margin: 0;
            line-height: 1.3;
        }

        .enhanced-badge {
            background: #065f46;
            color: #d1fae5;
            font-size: 0.7rem;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-weight: 600;
        }

        .scenario-type-badge {
            background: #1e40af;
            color: #dbeafe;
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .enhanced-title {
            margin-bottom: 1rem;
        }

        .enhanced-title h4 {
            color: #1e293b;
            font-size: 1rem;
            font-weight: 600;
            margin: 0;
            line-height: 1.3;
        }

        .enhanced-description {
            color: #4b5563;
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 1rem;
            font-style: italic;
        }

        .enhanced-metadata {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #f1f5f9;
        }

        .metadata-item {
            font-size: 0.8rem;
            color: #64748b;
            background: #f8fafc;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
        }

        .enhanced-actions {
            display: flex;
            gap: 0.75rem;
        }

        .action-btn {
            flex: 1;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
        }

        .action-btn.primary {
            background: #3b82f6;
            color: white;
        }

        .action-btn.primary:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .action-btn.secondary {
            background: #f8fafc;
            border-color: #e2e8f0;
            color: #64748b;
        }

        .action-btn.secondary:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
            color: #475569;
        }

        /* Search and Filter Styling */
        .search-input::placeholder {
            color: #9ca3af;
        }

        .filter-select {
            color: #374151;
        }

        .filter-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Loading States */
        .loading-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .loading-card {
            background: #f8fafc;
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            color: #64748b;
            font-style: italic;
        }

        /* Responsive Enhanced Cards */
        @media (max-width: 768px) {
            .enhanced-colleague-card,
            .enhanced-scenario-card {
                padding: 1rem;
            }

            .enhanced-card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .enhanced-info {
                width: 100%;
            }

            .enhanced-actions {
                flex-direction: column;
            }

            .action-btn {
                padding: 0.75rem;
            }

            .metadata-item {
                font-size: 0.75rem;
            }
        }

        /* Quick Start Enhancements */
        #quickStartPersonalities .personality-card {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        #quickStartPersonalities .personality-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        #quickStartPersonalities .personality-card.selected {
            border-color: #3b82f6;
            background: #eff6ff;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        #quickStartPersonalities .personality-card.selected::after {
            content: 'âœ“';
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            width: 20px;
            height: 20px;
            background: #3b82f6;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Tab Count Badges */
        .tab-count {
            transition: all 0.2s ease;
        }

        .tab-button.active .tab-count {
            background: #1d4ed8;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">CT</div>
                    <div class="logo-text">
                        <h1>Conversation Trainer</h1>
                        <p>NSW Local Government Professional Development</p>
                    </div>
                </div>
                <div class="header-actions">
                    <div class="status-indicator">
                        <div class="status-dot"></div>
                        <span>Service Online</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Setup Screen -->
            <!-- Tab Navigation -->
            <div class="tab-navigation">
                <div class="tab-nav-container">
                    <button class="tab-button active" data-tab="quick-start">
                        <span class="tab-icon">ðŸš€</span>
                        <span class="tab-label">Quick Start</span>
                    </button>
                    <button class="tab-button" data-tab="my-colleagues">
                        <span class="tab-icon">ðŸ‘¥</span>
                        <span class="tab-label">My Colleagues</span>
                        <span class="tab-count" id="colleaguesTabCount">0</span>
                    </button>
                    <button class="tab-button" data-tab="my-scenarios">
                        <span class="tab-icon">ðŸ“‹</span>
                        <span class="tab-label">My Scenarios</span>
                        <span class="tab-count" id="scenariosTabCount">0</span>
                    </button>
                    <button class="tab-button" data-tab="disc-explorer">
                        <span class="tab-icon">ðŸ§ </span>
                        <span class="tab-label">DISC Explorer</span>
                    </button>
                </div>
            </div>

            <!-- Tab Content Areas -->
            <div class="tab-content-container">

                <!-- Quick Start Tab -->
                <div class="tab-content active" id="quick-start-tab">
                    <div class="tab-header">
                        <h2>Quick Start Practice Session</h2>
                        <p>Get started quickly with built-in personalities and scenarios</p>
                    </div>

                    <!-- Move existing setup-container content here -->
                    <div class="setup-container">
                        <!-- Role Selection -->
                        <div class="setup-panel">
                            <div class="panel-header">
                                <div class="panel-icon role">ðŸ‘¤</div>
                                <h2 class="panel-title">Your Role</h2>
                            </div>
                            <div class="selection-grid">
                                <div class="option-card" data-role="director">
                                    <div class="option-title">Director</div>
                                    <div class="option-description">Practice strategic leadership, mentoring conversations, and budget discussions with senior stakeholders.</div>
                                </div>
                                <div class="option-card" data-role="manager">
                                    <div class="option-title">Manager</div>
                                    <div class="option-description">Handle performance reviews, team conflicts, and operational discussions with staff and colleagues.</div>
                                </div>
                                <div class="option-card" data-role="customer-service">
                                    <div class="option-title">Customer Service Officer</div>
                                    <div class="option-description">Manage resident complaints, billing disputes, and challenging service-related conversations.</div>
                                </div>
                                <div class="option-card" data-role="project-manager">
                                    <div class="option-title">Project Manager</div>
                                    <div class="option-description">Navigate stakeholder negotiations, contractor management, and cross-departmental coordination.</div>
                                </div>
                            </div>
                        </div>

                        <!-- Scenario Selection -->
                        <div class="setup-panel">
                            <div class="panel-header">
                                <div class="panel-icon scenario">ðŸ“‹</div>
                                <h2 class="panel-title">Practice Scenario</h2>
                            </div>
                            <div class="selection-grid">
                                <div class="option-card" data-scenario="budget_cuts">
                                    <div class="option-title">Budget Reduction Discussion</div>
                                    <div class="option-description">Practice explaining budget cuts while maintaining team morale and finding creative solutions to resource constraints.</div>
                                </div>
                                <div class="option-card" data-scenario="angry_resident">
                                    <div class="option-title">Challenging Resident Interaction</div>
                                    <div class="option-description">Handle frustrated ratepayer complaints about service levels, rate increases, and council decisions.</div>
                                </div>
                            </div>
                        </div>

                        <!-- Built-in Personalities Only (for quick start) -->
                        <div class="setup-panel full-width">
                            <div class="panel-header">
                                <div class="panel-icon personality">ðŸŽ­</div>
                                <h2 class="panel-title">Built-in Personalities</h2>
                            </div>
                            <div class="personality-grid" id="quickStartPersonalities">
                                <!-- Built-in personalities will be loaded here -->
                            </div>
                        </div>

                        <!-- Quick Start Action Panel -->
                        <div class="action-panel">
                            <button class="start-button" id="quickStartButton" disabled>
                                <span>ðŸš€</span>
                                <span>Begin Practice Session</span>
                            </button>
                            <p style="margin-top: 1rem; color: #64748b; font-size: 0.875rem;">
                                Quick practice with built-in personalities and scenarios
                            </p>
                        </div>
                    </div>
                </div>

                <!-- My Colleagues Tab -->
                <div class="tab-content" id="my-colleagues-tab">
                    <div class="tab-header">
                        <h2>My Colleague Library</h2>
                        <p>Manage your saved colleagues and create new ones</p>
                    </div>

                    <div class="colleague-management">
                        <div class="colleagues-toolbar">
                            <div class="search-filter-section">
                                <input type="text" class="search-input" placeholder="Search colleagues..." id="colleagueSearch">
                                <select class="filter-select" id="colleagueFilter">
                                    <option value="">All Colleagues</option>
                                    <option value="recent">Recently Used</option>
                                    <option value="unused">Never Used</option>
                                </select>
                            </div>
                            <div class="action-buttons">
                                <button class="btn btn-primary" onclick="showCustomCharacterModal()">
                                    âž• Create New Colleague
                                </button>
                                <button class="btn btn-secondary" onclick="importColleagues()">
                                    ðŸ“‚ Import
                                </button>
                            </div>
                        </div>

                        <div class="colleagues-grid" id="colleaguesGrid">
                            <!-- Enhanced colleague cards will be loaded here -->
                        </div>

                        <div class="empty-state colleagues-empty" id="colleaguesEmpty">
                            <h3>No colleagues yet</h3>
                            <p>Create your first colleague to start building your practice library</p>
                            <button class="btn btn-primary" onclick="showCustomCharacterModal()">
                                Create First Colleague
                            </button>
                        </div>
                    </div>
                </div>

                <!-- My Scenarios Tab -->
                <div class="tab-content" id="my-scenarios-tab">
                    <div class="tab-header">
                        <h2>My Scenario Library</h2>
                        <p>Manage your saved scenarios and create new ones</p>
                    </div>

                    <div class="scenario-management">
                        <div class="scenarios-toolbar">
                            <div class="search-filter-section">
                                <input type="text" class="search-input" placeholder="Search scenarios..." id="scenarioSearch">
                                <select class="filter-select" id="scenarioFilter">
                                    <option value="">All Scenarios</option>
                                    <option value="budget_review">Budget Review</option>
                                    <option value="project_planning">Project Planning</option>
                                    <option value="performance_discussion">Performance Discussion</option>
                                </select>
                            </div>
                            <div class="action-buttons">
                                <button class="btn btn-primary" onclick="showCustomScenarioModal()">
                                    âž• Create New Scenario
                                </button>
                                <button class="btn btn-secondary" onclick="importScenarios()">
                                    ðŸ“‚ Import
                                </button>
                            </div>
                        </div>

                        <div class="scenarios-grid" id="scenariosGrid">
                            <!-- Enhanced scenario cards will be loaded here -->
                        </div>

                        <div class="empty-state scenarios-empty" id="scenariosEmpty">
                            <h3>No scenarios yet</h3>
                            <p>Create your first scenario to start building your practice library</p>
                            <button class="btn btn-primary" onclick="showCustomScenarioModal()">
                                Create First Scenario
                            </button>
                        </div>
                    </div>
                </div>

                <!-- DISC Explorer Tab -->
                <div class="tab-content" id="disc-explorer-tab">
                    <div class="tab-header">
                        <h2>DISC Explorer</h2>
                        <p>Learn about DISC personality types and their workplace behaviors</p>
                    </div>

                    <div class="disc-content">
                        <div class="disc-overview">
                            <h3>Understanding DISC Personalities</h3>
                            <p>DISC is a behavioral assessment tool that helps understand how people prefer to communicate and work. The four types represent different behavioral styles:</p>
                        </div>

                        <div class="disc-types-grid">
                            <div class="disc-type-card" data-type="D">
                                <div class="disc-type-header">
                                    <div class="disc-type-icon dominant">D</div>
                                    <h4>Dominance</h4>
                                    <span class="disc-percentage">3-11% of population</span>
                                </div>
                                <div class="disc-type-content">
                                    <p><strong>Key Traits:</strong> Results-focused, direct, decisive, competitive</p>
                                    <p><strong>In Meetings:</strong> Takes charge, challenges ideas, pushes for quick decisions</p>
                                    <p><strong>Communication:</strong> Prefers brief, bottom-line focused discussions</p>
                                </div>
                            </div>

                            <div class="disc-type-card" data-type="I">
                                <div class="disc-type-header">
                                    <div class="disc-type-icon influence">I</div>
                                    <h4>Influence</h4>
                                    <span class="disc-percentage">11-40% of population</span>
                                </div>
                                <div class="disc-type-content">
                                    <p><strong>Key Traits:</strong> Enthusiastic, optimistic, social, persuasive</p>
                                    <p><strong>In Meetings:</strong> Builds consensus, shares ideas openly, motivates others</p>
                                    <p><strong>Communication:</strong> Enjoys interaction, storytelling, relationship-building</p>
                                </div>
                            </div>

                            <div class="disc-type-card" data-type="S">
                                <div class="disc-type-header">
                                    <div class="disc-type-icon steadiness">S</div>
                                    <h4>Steadiness</h4>
                                    <span class="disc-percentage">69% of population</span>
                                </div>
                                <div class="disc-type-content">
                                    <p><strong>Key Traits:</strong> Patient, reliable, supportive, good listener</p>
                                    <p><strong>In Meetings:</strong> Asks clarifying questions, seeks consensus, supports team</p>
                                    <p><strong>Communication:</strong> Prefers one-on-one, thoughtful discussion, avoids conflict</p>
                                </div>
                            </div>

                            <div class="disc-type-card" data-type="C">
                                <div class="disc-type-header">
                                    <div class="disc-type-icon conscientiousness">C</div>
                                    <h4>Conscientiousness</h4>
                                    <span class="disc-percentage">17% of population</span>
                                </div>
                                <div class="disc-type-content">
                                    <p><strong>Key Traits:</strong> Analytical, precise, systematic, quality-focused</p>
                                    <p><strong>In Meetings:</strong> Asks detailed questions, wants data, ensures accuracy</p>
                                    <p><strong>Communication:</strong> Prefers facts, data, written follow-up, thorough analysis</p>
                                </div>
                            </div>
                        </div>

                        <div class="disc-workplace-section">
                            <h3>DISC in NSW Local Government</h3>
                            <p>Different roles tend to attract different DISC types. Understanding these patterns helps you practice more realistic conversations:</p>

                            <div class="workplace-examples">
                                <div class="workplace-example">
                                    <h4>ðŸ—ï¸ Engineering & Infrastructure</h4>
                                    <p>Typically High C personalities who value technical accuracy and detailed analysis</p>
                                </div>
                                <div class="workplace-example">
                                    <h4>ðŸ‘¥ Community Services</h4>
                                    <p>Often High I and S personalities focused on relationships and service delivery</p>
                                </div>
                                <div class="workplace-example">
                                    <h4>ðŸ’° Finance & Administration</h4>
                                    <p>Usually High C personalities with attention to detail and process accuracy</p>
                                </div>
                                <div class="workplace-example">
                                    <h4>ðŸ“‹ Customer Service</h4>
                                    <p>Commonly High S personalities with patience and people-helping focus</p>
                                </div>
                            </div>
                        </div>

                        <div class="coming-soon-section">
                            <h3>ðŸš€ Coming Soon</h3>
                            <div class="feature-preview">
                                <h4>Interactive DISC Quadrant</h4>
                                <p>Visualize population distribution, explore your colleague library placement, and discover DISC patterns in your practice sessions.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Screen -->
            <div id="chatScreen" class="chat-screen">
                <div class="chat-header">
                    <div class="chat-info">
                        <div class="participant-avatar" id="participantAvatar">CS</div>
                        <div class="chat-details">
                            <h3 id="participantName">Practice Session</h3>
                            <p id="scenarioDescription">Preparing conversation...</p>
                        </div>
                    </div>
                    <div>
                        <button class="secondary-button" id="endConversation">End Session</button>
                    </div>
                </div>

                <div class="messages-area" id="messagesArea">
                    <!-- Messages will be added here dynamically -->
                </div>

                <div class="input-area">
                    <div class="input-container">
                        <textarea class="message-input" id="messageInput" placeholder="Type your response..." rows="1" disabled></textarea>
                        <button class="send-button" id="sendButton" disabled>
                            <span>Send</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="success-message" id="successMessage">
                âœ… Connected to conversation service successfully
            </div>

            <div class="error-message" id="errorMessage">
                âŒ Error starting conversation
            </div>
        </main>
    </div>

    <!-- Enhanced Custom Character Modal -->
    <div class="modal-overlay" id="customCharacterModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create Your Custom Colleague</h3>
                <p style="color: #64748b; font-size: 0.9rem; margin-top: 0.5rem;">Build a realistic virtual version of someone from your workplace</p>
            </div>

            <!-- Character Creation Form -->
            <div id="characterCreationForm">
                <!-- Basic Information -->
                <div class="form-section">
                    <h4 class="section-title">ðŸ‘¤ Basic Information</h4>

                    <div class="form-row">
                        <div class="form-group" style="flex: 2;">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-input" id="customName" placeholder="e.g., David Morrison">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">Job Title/Role</label>
                            <input type="text" class="form-input" id="customRole" placeholder="e.g., Senior Engineer">
                        </div>
                    </div>
                </div>

                <!-- Workplace Behavior -->
                <div class="form-section">
                    <h4 class="section-title">ðŸ¢ Workplace Behavior</h4>

                    <div class="form-group">
                        <label class="form-label">How do they typically behave in meetings?</label>
                        <textarea class="form-input form-textarea" id="customPersonality" placeholder="e.g., Speaks first, asks lots of questions, interrupts when excited, focuses on technical details..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">What motivates them most?</label>
                        <textarea class="form-input form-textarea" id="customMotivations" placeholder="e.g., Recognition for achievements, job security, solving complex problems..."></textarea>
                    </div>
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancelCustomCharacter">Cancel</button>
                <button class="btn btn-primary" id="saveCustomCharacter">
                    ðŸ’¾ Create Character
                </button>
            </div>
        </div>
    </div>

    <!-- Custom Scenario Modal -->
    <div class="modal-overlay" id="customScenarioModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">Create Your Custom Scenario</h3>
            </div>

            <div class="form-group">
                <label class="form-label">Scenario Title</label>
                <input type="text" class="form-input" id="customScenarioTitle" placeholder="e.g., Budget Approval Meeting - Q2 Infrastructure Spend">
            </div>

            <div class="form-group">
                <label class="form-label">Meeting Context & Background</label>
                <textarea class="form-input form-textarea" id="customScenarioContext" placeholder="Describe the situation leading up to this meeting. What decisions need to be made? What's happened before? What are the stakes?"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Your Role & Objective</label>
                <textarea class="form-input form-textarea" id="customScenarioObjective" placeholder="What's your position in this meeting? What are you trying to achieve? What approach do you plan to take?"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Expected Challenges</label>
                <textarea class="form-input form-textarea" id="customScenarioChallenges" placeholder="What resistance or difficulties do you anticipate? What objections might come up?"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Meeting Type</label>
                <select class="form-input" id="customScenarioType">
                    <option value="budget_review">Budget Review</option>
                    <option value="project_planning">Project Planning</option>
                    <option value="performance_discussion">Performance Discussion</option>
                    <option value="policy_decision">Policy Decision</option>
                    <option value="stakeholder_negotiation">Stakeholder Negotiation</option>
                    <option value="crisis_management">Crisis Management</option>
                    <option value="vendor_meeting">Vendor/Contractor Meeting</option>
                    <option value="other">Other</option>
                </select>
            </div>

            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancelCustomScenario">Cancel</button>
                <button class="btn btn-primary" id="saveCustomScenario">Create Scenario</button>
            </div>
        </div>
    </div>

<script>
// ============================================
// CONFIGURATION & STATE
// ============================================
const API_BASE_URL = 'https://conversation-trainer-production.up.railway.app';

let appState = {
    selectedRole: null,
    selectedScenario: null,
    selectedPersonality: null,
    currentConversation: null,
    conversationHistory: [],
    isConnected: false
};

let customCharacterData = null;
let customScenarioData = null;

// ============================================
// UTILITY FUNCTIONS
// ============================================
function debugLog(message, data = null) {
    const timestamp = new Date().toLocaleTimeString();
    console.log(`ðŸ” [${timestamp}] ${message}`, data || '');
}

function showSuccessMessage(message) {
    const successMsg = document.getElementById('successMessage');
    if (successMsg) {
        successMsg.textContent = message;
        successMsg.style.display = 'block';
        setTimeout(() => {
            successMsg.style.display = 'none';
        }, 4000);
    }
}

function showErrorMessage(message) {
    const errorMsg = document.getElementById('errorMessage');
    if (errorMsg) {
        errorMsg.textContent = message;
        errorMsg.style.display = 'block';
        setTimeout(() => {
            errorMsg.style.display = 'none';
        }, 6000);
    }
}

// ============================================
// STORAGE FUNCTIONS
// ============================================
function saveColleagueToStorage(colleagueData) {
    try {
        const colleagues = getStoredColleagues();
        const colleagueId = `colleague_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

        colleagueData.id = colleagueId;
        colleagueData.saved_at = new Date().toISOString();

        colleagues[colleagueId] = colleagueData;
        localStorage.setItem('conversation_trainer_colleagues', JSON.stringify(colleagues));

        debugLog('âœ… Colleague saved to storage', colleagueData);
        updateStorageCounts();
        return colleagueId;
    } catch (error) {
        debugLog('âŒ Error saving colleague', error);
        throw error;
    }
}

function getStoredColleagues() {
    try {
        const stored = localStorage.getItem('conversation_trainer_colleagues');
        return stored ? JSON.parse(stored) : {};
    } catch (error) {
        debugLog('âš ï¸ Error reading stored colleagues, returning empty object', error);
        return {};
    }
}

function saveScenarioToStorage(scenarioData) {
    try {
        const scenarios = getStoredScenarios();
        const scenarioId = `scenario_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

        scenarioData.id = scenarioId;
        scenarioData.saved_at = new Date().toISOString();

        scenarios[scenarioId] = scenarioData;
        localStorage.setItem('conversation_trainer_scenarios', JSON.stringify(scenarios));

        debugLog('âœ… Scenario saved to storage', scenarioData);
        updateStorageCounts();
        return scenarioId;
    } catch (error) {
        debugLog('âŒ Error saving scenario', error);
        throw error;
    }
}

function getStoredScenarios() {
    try {
        const stored = localStorage.getItem('conversation_trainer_scenarios');
        return stored ? JSON.parse(stored) : {};
    } catch (error) {
        debugLog('âš ï¸ Error reading stored scenarios, returning empty object', error);
        return {};
    }
}

function updateStorageCounts() {
    try {
        const colleagues = getStoredColleagues();
        const scenarios = getStoredScenarios();

        const colleagueCount = Object.keys(colleagues).length;
        const scenarioCount = Object.keys(scenarios).length;

        const colleagueCountElement = document.getElementById('colleagueCount');
        const scenarioCountElement = document.getElementById('scenarioCount');

        if (colleagueCountElement) colleagueCountElement.textContent = colleagueCount;
        if (scenarioCountElement) scenarioCountElement.textContent = scenarioCount;

    } catch (error) {
        debugLog('Error updating storage counts', error);
    }
}

// ============================================
// STORAGE MANAGEMENT FUNCTIONS
// ============================================
function showStoredColleagues() {
    const colleagues = getStoredColleagues();
    const count = Object.keys(colleagues).length;

    if (count === 0) {
        showSuccessMessage('No saved colleagues yet. Create some custom characters to build your library!');
        return;
    }

    console.log('ðŸ“š Stored Colleagues:', colleagues);
    showSuccessMessage(`You have ${count} saved colleague${count === 1 ? '' : 's'}. Check console for details.`);
}

function showStoredScenarios() {
    const scenarios = getStoredScenarios();
    const count = Object.keys(scenarios).length;

    if (count === 0) {
        showSuccessMessage('No saved scenarios yet. Create some custom scenarios to build your library!');
        return;
    }

    console.log('ðŸ“‹ Stored Scenarios:', scenarios);
    showSuccessMessage(`You have ${count} saved scenario${count === 1 ? '' : 's'}. Check console for details.`);
}

function exportColleagues() {
    try {
        const colleagues = getStoredColleagues();
        const count = Object.keys(colleagues).length;

        if (count === 0) {
            showErrorMessage('No colleagues to export. Create some custom characters first.');
            return;
        }

        const exportData = {
            type: 'conversation_trainer_colleagues',
            version: '1.0',
            exported_at: new Date().toISOString(),
            count: count,
            colleagues: colleagues
        };

        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});

        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `conversation_trainer_colleagues_${new Date().toISOString().split('T')[0]}.json`;
        link.click();

        showSuccessMessage(`Successfully exported ${count} colleague${count === 1 ? '' : 's'}!`);
        debugLog('âœ… Colleagues exported', exportData);

    } catch (error) {
        debugLog('âŒ Error exporting colleagues', error);
        showErrorMessage('Error exporting colleagues. Please try again.');
    }
}

function exportScenarios() {
    try {
        const scenarios = getStoredScenarios();
        const count = Object.keys(scenarios).length;

        if (count === 0) {
            showErrorMessage('No scenarios to export. Create some custom scenarios first.');
            return;
        }

        const exportData = {
            type: 'conversation_trainer_scenarios',
            version: '1.0',
            exported_at: new Date().toISOString(),
            count: count,
            scenarios: scenarios
        };

        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});

        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `conversation_trainer_scenarios_${new Date().toISOString().split('T')[0]}.json`;
        link.click();

        showSuccessMessage(`Successfully exported ${count} scenario${count === 1 ? '' : 's'}!`);
        debugLog('âœ… Scenarios exported', exportData);

    } catch (error) {
        debugLog('âŒ Error exporting scenarios', error);
        showErrorMessage('Error exporting scenarios. Please try again.');
    }
}

function testStorage() {
    console.log('ðŸ“š Stored Colleagues:', getStoredColleagues());
    console.log('ðŸ“‹ Stored Scenarios:', getStoredScenarios());
    console.log('ðŸ“Š Storage Status:', {
        colleagues: Object.keys(getStoredColleagues()).length,
        scenarios: Object.keys(getStoredScenarios()).length
    });
}

// ============================================
// SCREEN SWITCHING
// ============================================
function switchToChat() {
    debugLog('ðŸŽ¬ SWITCHING TO CHAT SCREEN FROM TABS');

    try {
        // Hide all tab content
        document.querySelectorAll('.tab-content').forEach(content => {
            content.style.display = 'none';
        });

        // Hide tab navigation
        const tabNavigation = document.querySelector('.tab-navigation');
        if (tabNavigation) {
            tabNavigation.style.display = 'none';
        }

        // Show chat screen
        const chatScreen = document.getElementById('chatScreen');
        if (chatScreen) {
            chatScreen.style.display = 'flex';
            chatScreen.classList.add('active');
        }

        debugLog('ðŸŽ¯ Chat screen activated, tabs hidden');
        return true;

    } catch (error) {
        debugLog('âŒ Error switching to chat screen:', error);
        return false;
    }
}

function switchToSetup() {
    debugLog('ðŸ  Switching back to setup screen');

    const setupScreen = document.getElementById('setupScreen');
    const chatScreen = document.getElementById('chatScreen');

    if (chatScreen) {
        chatScreen.style.display = 'none';
        chatScreen.classList.remove('active');
    }

    if (setupScreen) {
        setupScreen.style.display = 'block';
        setupScreen.classList.remove('hidden');
    }
}

// ============================================
// CUSTOM CHARACTER FUNCTIONS
// ============================================
function showCustomCharacterModal() {
    debugLog('ðŸ“ Opening custom character modal');

    const modal = document.getElementById('customCharacterModal');
    if (!modal) {
        debugLog('âŒ Custom character modal not found in DOM');
        showErrorMessage('Custom character modal not found. Please refresh the page.');
        return;
    }

    clearCustomCharacterForm();
    modal.style.display = 'block';

    setTimeout(() => {
        const nameInput = document.getElementById('customName');
        if (nameInput) nameInput.focus();
    }, 100);

    debugLog('âœ… Custom character modal opened');
}

function cancelCustomCharacter() {
    debugLog('âŒ Cancelling custom character creation');

    const modal = document.getElementById('customCharacterModal');
    if (modal) {
        modal.style.display = 'none';
    }

    clearCustomCharacterForm();

    if (appState.selectedPersonality === 'custom_character') {
        const customOption = document.getElementById('customCharacterOption');
        if (customOption) {
            customOption.classList.remove('selected');
            resetCustomCharacterCard();
        }
        appState.selectedPersonality = null;
        customCharacterData = null;
        updateStartButton();
    }

    debugLog('âœ… Custom character creation cancelled');
}

function saveCustomCharacter() {
    debugLog('ðŸ’¾ Attempting to save custom character');

    try {
        const nameInput = document.getElementById('customName');
        const roleInput = document.getElementById('customRole');
        const personalityInput = document.getElementById('customPersonality');
        const motivationsInput = document.getElementById('customMotivations');

        if (!nameInput || !roleInput || !personalityInput || !motivationsInput) {
            throw new Error('Form elements not found. Please refresh the page.');
        }

        const name = nameInput.value?.trim() || '';
        const role = roleInput.value?.trim() || '';
        const personality = personalityInput.value?.trim() || '';
        const motivations = motivationsInput.value?.trim() || '';

        debugLog('ðŸ“ Form data collected', { name, role, personality, motivations });

        if (!name) {
            showErrorMessage('Please provide a name for the colleague.');
            nameInput.focus();
            return false;
        }

        if (!role) {
            showErrorMessage('Please provide a job title/role for the colleague.');
            roleInput.focus();
            return false;
        }

        if (!personality) {
            showErrorMessage('Please describe how this person behaves in meetings.');
            personalityInput.focus();
            return false;
        }

        const characterData = {
            name: name,
            role: role,
            personality: personality,
            motivations: motivations || 'Professional success and recognition',
            type: 'custom',
            created: new Date().toISOString()
        };

        debugLog('âœ… Character data created', characterData);

        const colleagueId = saveColleagueToStorage(characterData);
        characterData.id = colleagueId;

        customCharacterData = characterData;
        updateCustomCharacterCard(characterData);

        appState.selectedPersonality = 'custom_character';
        debugLog('ðŸŽ¯ App state updated', appState);

        const modal = document.getElementById('customCharacterModal');
        if (modal) {
            modal.style.display = 'none';
        }

        updateStartButton();

        debugLog('ðŸŽ‰ Custom character created successfully:', name);
        showSuccessMessage(`Custom colleague "${name}" created and saved! You can now start a practice session.`);

        return true;

    } catch (error) {
        debugLog('ðŸ’¥ Error creating custom character:', error);
        showErrorMessage(`Error creating custom character: ${error.message}`);
        return false;
    }
}

function updateCustomCharacterCard(characterData) {
    debugLog('ðŸŽ¨ Updating custom character card UI');

    const customOption = document.getElementById('customCharacterOption');
    if (!customOption) {
        debugLog('âŒ Custom character card not found');
        return;
    }

    document.querySelectorAll('.personality-card').forEach(card => {
        if (card !== customOption) {
            card.classList.remove('selected');
        }
    });

    customOption.classList.add('selected');

    const nameElement = customOption.querySelector('.personality-name');
    const roleElement = customOption.querySelector('.personality-role');
    const descElement = customOption.querySelector('.personality-description');

    if (nameElement) {
        nameElement.textContent = characterData.name;
    }
    if (roleElement) {
        roleElement.textContent = characterData.role;
    }
    if (descElement) {
        const description = characterData.personality.length > 80
            ? characterData.personality.substring(0, 80) + '...'
            : characterData.personality;
        descElement.textContent = `Custom colleague: ${description}`;
    }

    debugLog('âœ… Custom character card updated');
}

function resetCustomCharacterCard() {
    debugLog('ðŸ”„ Resetting custom character card to default');

    const customOption = document.getElementById('customCharacterOption');
    if (!customOption) return;

    const nameElement = customOption.querySelector('.personality-name');
    const roleElement = customOption.querySelector('.personality-role');
    const descElement = customOption.querySelector('.personality-description');

    if (nameElement) nameElement.textContent = 'Create Custom';
    if (roleElement) roleElement.textContent = 'Build Your Own';
    if (descElement) descElement.textContent = 'Design a virtual version of someone from your workplace with custom DISC profile and behaviors.';
}

function clearCustomCharacterForm() {
    debugLog('ðŸ§¹ Clearing custom character form');

    const fields = ['customName', 'customRole', 'customPersonality', 'customMotivations'];
    fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.value = '';
        }
    });
}

// ============================================
// CUSTOM SCENARIO FUNCTIONS
// ============================================
function showCustomScenarioModal() {
    debugLog('ðŸ“‹ Opening custom scenario modal');

    const modal = document.getElementById('customScenarioModal');
    if (!modal) {
        debugLog('âŒ Custom scenario modal not found in DOM');
        showErrorMessage('Custom scenario modal not found. Please refresh the page.');
        return;
    }

    clearCustomScenarioForm();
    modal.style.display = 'block';

    setTimeout(() => {
        const titleInput = document.getElementById('customScenarioTitle');
        if (titleInput) titleInput.focus();
    }, 100);

    debugLog('âœ… Custom scenario modal opened');
}

function cancelCustomScenario() {
    debugLog('âŒ Cancelling custom scenario creation');

    const modal = document.getElementById('customScenarioModal');
    if (modal) {
        modal.style.display = 'none';
    }

    clearCustomScenarioForm();

    if (appState.selectedScenario === 'custom_scenario') {
        const customOption = document.getElementById('customScenarioOption');
        if (customOption) {
            customOption.classList.remove('selected');
            resetCustomScenarioCard();
        }
        appState.selectedScenario = null;
        customScenarioData = null;
        updateStartButton();
    }

    debugLog('âœ… Custom scenario creation cancelled');
}

function saveCustomScenario() {
    debugLog('ðŸ’¾ Attempting to save custom scenario');

    try {
        const titleInput = document.getElementById('customScenarioTitle');
        const contextInput = document.getElementById('customScenarioContext');
        const objectiveInput = document.getElementById('customScenarioObjective');
        const challengesInput = document.getElementById('customScenarioChallenges');
        const typeInput = document.getElementById('customScenarioType');

        if (!titleInput || !contextInput || !objectiveInput || !challengesInput || !typeInput) {
            throw new Error('Form elements not found. Please refresh the page.');
        }

        const title = titleInput.value?.trim() || '';
        const context = contextInput.value?.trim() || '';
        const objective = objectiveInput.value?.trim() || '';
        const challenges = challengesInput.value?.trim() || '';
        const type = typeInput.value || 'budget_review';

        debugLog('ðŸ“ Scenario form data collected', { title, context, objective, challenges, type });

        if (!title) {
            showErrorMessage('Please provide a title for the scenario.');
            titleInput.focus();
            return false;
        }

        if (!context) {
            showErrorMessage('Please describe the meeting context and background.');
            contextInput.focus();
            return false;
        }

        if (!objective) {
            showErrorMessage('Please describe your role and objective in this meeting.');
            objectiveInput.focus();
            return false;
        }

        const scenarioData = {
            title: title,
            context: context,
            objective: objective,
            challenges: challenges || 'Standard workplace challenges',
            type: type,
            created: new Date().toISOString()
        };

        debugLog('âœ… Scenario data created', scenarioData);

        const scenarioId = saveScenarioToStorage(scenarioData);
        scenarioData.id = scenarioId;

        customScenarioData = scenarioData;
        updateCustomScenarioCard(scenarioData);

        appState.selectedScenario = 'custom_scenario';
        debugLog('ðŸŽ¯ App state updated', appState);

        const modal = document.getElementById('customScenarioModal');
        if (modal) {
            modal.style.display = 'none';
        }

        updateStartButton();

        debugLog('ðŸŽ‰ Custom scenario created successfully:', title);
        showSuccessMessage(`Custom scenario "${title}" created and saved! You can now start a practice session.`);

        return true;

    } catch (error) {
        debugLog('ðŸ’¥ Error creating custom scenario:', error);
        showErrorMessage(`Error creating custom scenario: ${error.message}`);
        return false;
    }
}

function updateCustomScenarioCard(scenarioData) {
    debugLog('ðŸŽ¨ Updating custom scenario card UI');

    const customOption = document.getElementById('customScenarioOption');
    if (!customOption) {
        debugLog('âŒ Custom scenario card not found');
        return;
    }

    document.querySelectorAll('[data-scenario]').forEach(card => {
        if (card !== customOption) {
            card.classList.remove('selected');
        }
    });

    customOption.classList.add('selected');

    const titleElement = customOption.querySelector('.option-title');
    const descElement = customOption.querySelector('.option-description');

    if (titleElement) {
        titleElement.textContent = scenarioData.title;
    }
    if (descElement) {
        const description = scenarioData.context.length > 100
            ? scenarioData.context.substring(0, 100) + '...'
            : scenarioData.context;
        descElement.textContent = `Custom scenario: ${description}`;
    }

    debugLog('âœ… Custom scenario card updated');
}

function resetCustomScenarioCard() {
    debugLog('ðŸ”„ Resetting custom scenario card to default');

    const customOption = document.getElementById('customScenarioOption');
    if (!customOption) return;

    const titleElement = customOption.querySelector('.option-title');
    const descElement = customOption.querySelector('.option-description');

    if (titleElement) titleElement.textContent = 'ðŸŽ¯ Create Custom Scenario';
    if (descElement) descElement.textContent = 'Design your specific meeting situation. Perfect for practicing upcoming real conversations.';
}

function clearCustomScenarioForm() {
    debugLog('ðŸ§¹ Clearing custom scenario form');

    const fields = ['customScenarioTitle', 'customScenarioContext', 'customScenarioObjective', 'customScenarioChallenges'];
    fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.value = '';
        }
    });

    const typeField = document.getElementById('customScenarioType');
    if (typeField) {
        typeField.value = 'budget_review';
    }
}

// ============================================
// SELECTION HANDLING
// ============================================
function handleSelection(event) {
    debugLog('Selection handler called');
    const card = event.currentTarget;
    const parent = card.parentElement;

    parent.querySelectorAll('.option-card, .personality-card').forEach(c => c.classList.remove('selected'));
    card.classList.add('selected');

    if (card.dataset.role) {
        appState.selectedRole = card.dataset.role;
        debugLog('Selected role', appState.selectedRole);
    } else if (card.dataset.scenario) {
        appState.selectedScenario = card.dataset.scenario;
        debugLog('Selected scenario', appState.selectedScenario);
    } else if (card.dataset.personality) {
        appState.selectedPersonality = card.dataset.personality;
        debugLog('Selected personality', appState.selectedPersonality);
    }

    updateStartButton();
}

// ============================================
// REQUEST DATA BUILDING
// ============================================
function buildCustomScenarioDescription(scenarioData) {
    return `${scenarioData.title}

CONTEXT: ${scenarioData.context}

YOUR OBJECTIVE: ${scenarioData.objective}

EXPECTED CHALLENGES: ${scenarioData.challenges}

MEETING TYPE: ${scenarioData.type}`;
}

function getScenarioDescription(scenarioKey) {
    const scenarios = {
        'budget_cuts': 'You need to discuss budget reductions with your team while maintaining morale and finding creative solutions.',
        'angry_resident': 'Handle a frustrated ratepayer who is upset about service levels and rate increases.'
    };
    return scenarios[scenarioKey] || 'Practice conversation scenario';
}

function getRequestData() {
    debugLog('Building request data');
    const baseData = {
        user_name: `${appState.selectedRole}_user`,
        personality_type: appState.selectedPersonality
    };

    debugLog('ðŸ” REQUEST DATA DEBUG:', {
        selectedRole: appState.selectedRole,
        selectedScenario: appState.selectedScenario,
        selectedPersonality: appState.selectedPersonality,
        hasCustomCharacter: !!customCharacterData,
        hasCustomScenario: !!customScenarioData
    });

    // Handle saved colleagues (NEW)
    if (appState.selectedPersonality && appState.selectedPersonality.startsWith('saved_colleague_')) {
        baseData.custom_character = customCharacterData;
        debugLog('Added saved colleague data:', customCharacterData.name);
    } else if (appState.selectedPersonality === 'custom_character' && customCharacterData) {
        baseData.custom_character = customCharacterData;
        debugLog('Added custom character data');
    }

    // Handle saved scenarios (NEW)
    if (appState.selectedScenario && appState.selectedScenario.startsWith('saved_scenario_')) {
        baseData.custom_scenario = customScenarioData;
        baseData.scenario = buildCustomScenarioDescription(customScenarioData);
        debugLog('Added saved scenario data:', customScenarioData.title);
    } else if (appState.selectedScenario === 'custom_scenario' && customScenarioData) {
        baseData.custom_scenario = customScenarioData;
        baseData.scenario = buildCustomScenarioDescription(customScenarioData);
        debugLog('Added custom scenario data');
    } else {
        baseData.scenario = getScenarioDescription(appState.selectedScenario);
        debugLog('Added standard scenario');
    }

    debugLog('ðŸš€ FINAL REQUEST DATA:', baseData);
    return baseData;
}

// ============================================
// START BUTTON MANAGEMENT
// ============================================
function updateStartButton() {
    // Try to find either button
    let startBtn = document.getElementById('quickStartButton');
    if (!startBtn) {
        startBtn = document.getElementById('startConversation');
    }

    if (!startBtn) {
        debugLog('âš ï¸ No start button found');
        return;
    }

    const isReady = appState.selectedRole && appState.selectedScenario && appState.selectedPersonality;

    startBtn.disabled = !isReady || !appState.isConnected;

    if (!appState.isConnected) {
        startBtn.innerHTML = '<span>âš ï¸</span><span>Connecting to Service...</span>';
    } else if (!isReady) {
        startBtn.innerHTML = '<span>ðŸš€</span><span>Begin Practice Session</span>';
    } else {
        startBtn.innerHTML = '<span>ðŸš€</span><span>Begin Practice Session</span>';
    }

    debugLog('Start button updated', { ready: isReady, connected: appState.isConnected, buttonFound: !!startBtn });
}

// ============================================
// API CONNECTION
// ============================================
async function testAPIConnection() {
    try {
        debugLog('Testing API connection');
        const response = await fetch(`${API_BASE_URL}/health`);
        const data = await response.json();

        if (response.ok) {
            appState.isConnected = true;
            showSuccessMessage('âœ… Connected to conversation service successfully');
            debugLog('API connection successful', data);
        } else {
            throw new Error('API health check failed');
        }
    } catch (error) {
        debugLog('API Connection Error', error);
        appState.isConnected = false;
        showConnectionError();
        showErrorMessage('âš ï¸ Cannot connect to conversation service. Please check your internet connection.');
    } finally {
        updateStartButton();
    }
}

function showConnectionError() {
    const statusIndicator = document.querySelector('.status-indicator');
    statusIndicator.innerHTML = '<div style="width: 8px; height: 8px; background: #dc2626; border-radius: 50%;"></div><span>Service Offline</span>';
    statusIndicator.style.background = '#fef2f2';
    statusIndicator.style.borderColor = '#fecaca';
    statusIndicator.style.color = '#dc2626';
}

// ============================================
// CONVERSATION MANAGEMENT
// ============================================
async function startConversation() {
    debugLog('ðŸš€ START CONVERSATION CALLED');
    debugLog('ðŸŽ¯ Current app state:', appState);

    try {
        // Find the correct start button (could be either ID)
        let startBtn = document.getElementById('quickStartButton');
        if (!startBtn) {
            startBtn = document.getElementById('startConversation');
        }

        if (startBtn) {
            startBtn.disabled = true;
            startBtn.innerHTML = '<span>â³</span><span>Starting Session...</span>';
        }

        const requestData = getRequestData();
        debugLog('ðŸ“¤ Sending request to backend:', requestData);

        const response = await fetch(`${API_BASE_URL}/api/conversations/start`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });

        debugLog('ðŸ“¥ Backend response status:', response.status);

        if (!response.ok) {
            const errorText = await response.text();
            debugLog('âŒ Backend error response:', errorText);
            throw new Error(`Backend error (${response.status}): ${errorText}`);
        }

        const data = await response.json();
        debugLog('âœ… Backend success response:', data);

        if (data.success) {
            appState.currentConversation = data;
            appState.conversationHistory = [{
                sender: data.personality_name,
                content: data.opening_message,
                timestamp: data.timestamp || new Date().toISOString(),
                sender_type: 'ai_personality'
            }];

            const switchSuccess = switchToChat();
            if (!switchSuccess) {
                throw new Error('Failed to switch to chat screen');
            }

            const messagesArea = document.getElementById('messagesArea');
            if (messagesArea) {
                messagesArea.innerHTML = '';
            }

            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');

            if (messageInput) messageInput.disabled = false;
            if (sendButton) sendButton.disabled = false;

            updateChatHeader();
            addSystemMessage('Practice session started. Your conversation partner is ready.');
            addAIMessage(data.opening_message);

            debugLog('ðŸŽ‰ Conversation started successfully');

        } else {
            throw new Error(data.error || 'Backend reported failure');
        }
    } catch (error) {
        debugLog('ðŸ’¥ CONVERSATION START ERROR:', error);
        showErrorMessage(`Failed to start conversation: ${error.message}`);

        // Reset button safely
        let startBtn = document.getElementById('quickStartButton');
        if (!startBtn) {
            startBtn = document.getElementById('startConversation');
        }

        if (startBtn) {
            startBtn.disabled = false;
            startBtn.innerHTML = '<span>ðŸš€</span><span>Begin Practice Session</span>';
        }
    }
}

async function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();

    if (!message || !appState.currentConversation) return;

    try {
        debugLog('Sending message', message);

        addUserMessage(message);
        input.value = '';

        input.disabled = true;
        document.getElementById('sendButton').disabled = true;

        const requestData = {
            conversation_id: appState.currentConversation.conversation_id,
            user_message: message,
            personality_data: appState.currentConversation.conversation_data.personality,
            conversation_history: appState.conversationHistory
        };

        debugLog('Sending message request', requestData);

        const response = await fetch(`${API_BASE_URL}/api/conversations/message`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });

        const data = await response.json();
        debugLog('Message response', data);

        if (data.success) {
            addAIMessage(data.ai_response);

            appState.conversationHistory.push({
                sender: 'user',
                content: message,
                timestamp: new Date().toISOString(),
                sender_type: 'user'
            });

            appState.conversationHistory.push({
                sender: appState.currentConversation.personality_name,
                content: data.ai_response,
                timestamp: data.timestamp,
                sender_type: 'ai_personality'
            });

            debugLog('Message exchange completed');
        } else {
            throw new Error(data.error || 'Failed to get AI response');
        }
    } catch (error) {
        debugLog('Error sending message', error);
        addSystemMessage('Sorry, there was an error processing your message. Please try again.');
        showErrorMessage('Error sending message. Please try again.');
    } finally {
        input.disabled = false;
        document.getElementById('sendButton').disabled = false;
        input.focus();
    }
}

function endConversation() {
    if (confirm('Are you sure you want to end this practice session?')) {
        debugLog('ðŸ Ending conversation and returning to tabs');

        // Hide chat screen
        const chatScreen = document.getElementById('chatScreen');
        if (chatScreen) {
            chatScreen.style.display = 'none';
            chatScreen.classList.remove('active');
        }

        // Show tab navigation
        const tabNavigation = document.querySelector('.tab-navigation');
        if (tabNavigation) {
            tabNavigation.style.display = 'block';
        }

        // Show tab content
        document.querySelectorAll('.tab-content').forEach(content => {
            content.style.display = 'block';
        });

        // Return to Quick Start tab
        switchToTab('quick-start');

        // Clear messages and reset state
        document.getElementById('messagesArea').innerHTML = '';

        // Clear Quick Start selections
        document.querySelectorAll('#quick-start-tab .option-card, #quick-start-tab .personality-card').forEach(card => {
            card.classList.remove('selected');
        });

        // Reset state
        appState.selectedRole = null;
        appState.selectedScenario = null;
        appState.selectedPersonality = null;
        appState.currentConversation = null;
        appState.conversationHistory = [];

        const messageInput = document.getElementById('messageInput');
        messageInput.value = '';
        messageInput.disabled = true;
        document.getElementById('sendButton').disabled = true;

        updateQuickStartButton();
        debugLog('âœ… Returned to Quick Start tab');
    }
}

// ============================================
// CHAT UI FUNCTIONS
// ============================================
function updateChatHeader() {
    const personalities = {
        'infrastructure_engineer': {
            name: 'Terry Mitchell',
            avatar: 'TM',
            description: 'Senior Infrastructure Engineer â€¢ Technical expert, detail-oriented'
        },
        'community_engagement': {
            name: 'Sarah Chen',
            avatar: 'SC',
            description: 'Community Engagement Officer â€¢ People-focused, diplomatic'
        },
        'budget_director': {
            name: 'David Walsh',
            avatar: 'DW',
            description: 'Budget & Finance Director â€¢ Numbers-driven, direct about constraints'
        },
        'union_rep': {
            name: 'Maria Santos',
            avatar: 'MS',
            description: 'Union Representative â€¢ Assertive advocate for workers\' rights'
        },
        'councillor_thompson': {
            name: 'Robert Thompson',
            avatar: 'RT',
            description: 'Long-term Councillor â€¢ Steady, consensus-building approach'
        },
        'strategic_planner': {
            name: 'Emily Kim',
            avatar: 'EK',
            description: 'Strategic Planner â€¢ Analytical yet enthusiastic about new ideas'
        },
        'custom_character': {
            name: customCharacterData ? customCharacterData.name : 'Custom Character',
            avatar: customCharacterData ? customCharacterData.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2) : 'CC',
            description: customCharacterData ? `Custom colleague â€¢ ${customCharacterData.role || 'Custom character'}` : 'Custom character'
        }
    };

    // NEW: Handle saved colleagues
    let personality;
    if (appState.selectedPersonality && appState.selectedPersonality.startsWith('saved_colleague_') && customCharacterData) {
        personality = {
            name: customCharacterData.name,
            avatar: customCharacterData.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2),
            description: `Saved colleague â€¢ ${customCharacterData.role || 'Custom character'}`
        };
        console.log('Using saved colleague for chat header:', personality);
    } else {
        personality = personalities[appState.selectedPersonality];
        console.log('Using built-in personality for chat header:', personality);
    }

    if (personality) {
        document.getElementById('participantAvatar').textContent = personality.avatar;
        document.getElementById('participantName').textContent = personality.name;
        document.getElementById('scenarioDescription').textContent = personality.description;
        debugLog('Chat header updated', { selectedPersonality: appState.selectedPersonality, personality });
    } else {
        debugLog('âš ï¸ Unknown personality type', appState.selectedPersonality);
        document.getElementById('participantAvatar').textContent = 'AI';
        document.getElementById('participantName').textContent = 'Practice Partner';
        document.getElementById('scenarioDescription').textContent = 'Conversation practice session';
    }
}

function addSystemMessage(content) {
    const messagesArea = document.getElementById('messagesArea');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'system-message';
    messageDiv.textContent = content;
    messagesArea.appendChild(messageDiv);
    scrollToBottom();
}

function addUserMessage(content) {
    addMessage('user', content, 'You');
}

function addAIMessage(content) {
    const personalities = {
        'infrastructure_engineer': 'TM',
        'community_engagement': 'SC',
        'budget_director': 'DW',
        'union_rep': 'MS',
        'councillor_thompson': 'RT',
        'strategic_planner': 'EK',
        'custom_character': customCharacterData ? customCharacterData.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2) : 'CC'
    };

    // NEW: Handle saved colleagues
    let avatar;
    if (appState.selectedPersonality && appState.selectedPersonality.startsWith('saved_colleague_') && customCharacterData) {
        avatar = customCharacterData.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
        console.log('Using saved colleague avatar for AI message:', avatar, 'from:', customCharacterData.name);
    } else {
        avatar = personalities[appState.selectedPersonality] || 'AI';
        console.log('Using built-in avatar for AI message:', avatar);
    }

    debugLog('Adding AI message', { personality: appState.selectedPersonality, avatar, content: content.substring(0, 50) + '...' });
    addMessage('ai', content, avatar);
}

function addMessage(type, content, avatar) {
    const messagesArea = document.getElementById('messagesArea');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}`;

    const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

    messageDiv.innerHTML = [
        '<div class="message-avatar">' + avatar + '</div>',
        '<div class="message-content">',
            '<div class="message-text">' + content + '</div>',
            '<div class="message-time">' + timestamp + '</div>',
        '</div>'
    ].join('');

    messagesArea.appendChild(messageDiv);
    scrollToBottom();
}

function scrollToBottom() {
    const messagesArea = document.getElementById('messagesArea');
    messagesArea.scrollTop = messagesArea.scrollHeight;
}

function handleInputKeydown(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
    }
}

// ============================================
// EVENT LISTENERS SETUP
// ============================================
// Update setupEventListeners to include Quick Start handlers
function setupEventListeners() {
    debugLog('ðŸ”§ Setting up all event listeners including tab system');

    // Quick Start role and scenario selection
    document.querySelectorAll('#quick-start-tab .option-card').forEach(card => {
        card.addEventListener('click', handleQuickStartSelection);
    });

    // UPDATED: Connect both start buttons
    const quickStartBtn = document.getElementById('quickStartButton');
    const originalStartBtn = document.getElementById('startConversation');

    if (quickStartBtn) {
        quickStartBtn.addEventListener('click', startConversation);
    }
    if (originalStartBtn) {
        originalStartBtn.addEventListener('click', startConversation);
    }

    // Rest of existing event listeners...
    document.getElementById('endConversation').addEventListener('click', endConversation);
    document.getElementById('sendButton').addEventListener('click', sendMessage);

    const messageInput = document.getElementById('messageInput');
    if (messageInput) {
        messageInput.addEventListener('keydown', handleInputKeydown);
    }

    setupCustomCharacterListeners();
    setupCustomScenarioListeners();

    debugLog('âœ… All event listeners set up including Quick Start integration');
}
function handleQuickStartSelection(event) {
    debugLog('ðŸš€ Quick Start selection handler called');
    const card = event.currentTarget;
    const parent = card.parentElement;

    // Clear selections within this panel only
    parent.querySelectorAll('.option-card, .personality-card').forEach(c => c.classList.remove('selected'));
    card.classList.add('selected');

    if (card.dataset.role) {
        appState.selectedRole = card.dataset.role;
        debugLog('âœ… Selected role in Quick Start:', appState.selectedRole);
    } else if (card.dataset.scenario) {
        appState.selectedScenario = card.dataset.scenario;
        debugLog('âœ… Selected scenario in Quick Start:', appState.selectedScenario);
    } else if (card.dataset.personality) {
        appState.selectedPersonality = card.dataset.personality;
        debugLog('âœ… Selected personality in Quick Start:', appState.selectedPersonality);
    }

    updateQuickStartButton();
}
function setupCustomCharacterListeners() {
    debugLog('ðŸ”§ Setting up custom character event listeners');

    const customCharacterOption = document.getElementById('customCharacterOption');
    if (customCharacterOption) {
        customCharacterOption.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            debugLog('ðŸŽ­ Custom character option clicked');
            showCustomCharacterModal();
        });
        debugLog('âœ… Custom character option listener attached');
    }

    // Modal buttons
    const cancelBtn = document.getElementById('cancelCustomCharacter');
    const saveBtn = document.getElementById('saveCustomCharacter');

    if (cancelBtn) {
        cancelBtn.addEventListener('click', function(e) {
            e.preventDefault();
            cancelCustomCharacter();
        });
        debugLog('âœ… Cancel button listener attached');
    }

    if (saveBtn) {
        saveBtn.addEventListener('click', function(e) {
            e.preventDefault();
            saveCustomCharacter();
        });
        debugLog('âœ… Save button listener attached');
    }

    // Modal overlay click to close
    const modal = document.getElementById('customCharacterModal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                cancelCustomCharacter();
            }
        });
        debugLog('âœ… Modal overlay listener attached');
    }

    // Form keyboard shortcuts
    const form = document.getElementById('characterCreationForm');
    if (form) {
        form.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.ctrlKey) {
                e.preventDefault();
                saveCustomCharacter();
            }
            if (e.key === 'Escape') {
                e.preventDefault();
                cancelCustomCharacter();
            }
        });
        debugLog('âœ… Form keyboard handlers attached');
    }
}

function setupCustomScenarioListeners() {
    debugLog('ðŸ”§ Setting up custom scenario event listeners');

    const customScenarioOption = document.getElementById('customScenarioOption');
    if (customScenarioOption) {
        customScenarioOption.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            debugLog('ðŸ“‹ Custom scenario option clicked');
            showCustomScenarioModal();
        });
        debugLog('âœ… Custom scenario option listener attached');
    }

    // Modal buttons
    const cancelBtn = document.getElementById('cancelCustomScenario');
    const saveBtn = document.getElementById('saveCustomScenario');

    if (cancelBtn) {
        cancelBtn.addEventListener('click', function(e) {
            e.preventDefault();
            cancelCustomScenario();
        });
        debugLog('âœ… Scenario cancel button listener attached');
    }

    if (saveBtn) {
        saveBtn.addEventListener('click', function(e) {
            e.preventDefault();
            saveCustomScenario();
        });
        debugLog('âœ… Scenario save button listener attached');
    }

    // Modal overlay
    const modal = document.getElementById('customScenarioModal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                cancelCustomScenario();
            }
        });
        debugLog('âœ… Scenario modal overlay listener attached');
    }
}
// ============================================
// DYNAMIC CONTENT LOADING (PHASE 1)
// ============================================
function loadSavedColleagues() {
    debugLog('ðŸ“š Loading saved colleagues into personality grid');

    try {
        const savedColleagues = getStoredColleagues();
        const colleagueCount = Object.keys(savedColleagues).length;

        console.log(`Phase 1: Found ${colleagueCount} saved colleagues in storage`);

        if (colleagueCount === 0) {
            console.log('No saved colleagues found - create some to test!');
            return;
        }

        const personalityGrid = document.querySelector('.personality-grid');
        if (!personalityGrid) {
            console.error('âŒ Personality grid not found');
            return;
        }

        // Add saved colleagues to the grid
        Object.values(savedColleagues).forEach(colleague => {
            console.log('Creating card for:', colleague.name);
            const colleagueCard = createSavedColleagueCard(colleague);
            personalityGrid.insertBefore(colleagueCard, personalityGrid.lastElementChild);
        });

        console.log(`âœ… Added ${colleagueCount} saved colleague cards to personality grid`);

    } catch (error) {
        console.error('âŒ Error loading saved colleagues:', error);
    }
}
function createSavedColleagueCard(colleague) {
    debugLog('ðŸŽ¨ Creating card for saved colleague:', colleague.name);

    const cardDiv = document.createElement('div');
    cardDiv.className = 'personality-card saved-colleague';
    cardDiv.dataset.personality = `saved_colleague_${colleague.id}`;

    // Create avatar initials
    const initials = colleague.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);

    cardDiv.innerHTML = `
        <div class="personality-header">
            <div class="personality-avatar saved-avatar">${initials}</div>
            <div class="personality-info">
                <div class="personality-name">${colleague.name}</div>
                <div class="personality-role">${colleague.role}</div>
            </div>
            <div class="saved-badge">ðŸ’¾ Saved</div>
        </div>
        <div class="saved-personality-preview">
            <p class="saved-description">${colleague.personality.length > 80 ? colleague.personality.substring(0, 80) + '...' : colleague.personality}</p>
        </div>
        <div class="personality-description">
            <strong>Custom colleague:</strong> ${colleague.motivations || 'Professional development focused'}
        </div>
    `;

    // Add click handler for saved colleague
    cardDiv.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();

        // Clear other selections
        document.querySelectorAll('.personality-card').forEach(card => {
            card.classList.remove('selected');
        });

        // Select this card
        cardDiv.classList.add('selected');

        // Set app state
        appState.selectedPersonality = `saved_colleague_${colleague.id}`;

        // Store the colleague data for use in conversation
        customCharacterData = colleague;

        debugLog('âœ… Selected saved colleague:', colleague.name);
        updateStartButton();
    });

    return cardDiv;
}
function loadSavedScenarios() {
    debugLog('ðŸ“‹ Loading saved scenarios into scenario grid');

    try {
        const savedScenarios = getStoredScenarios();
        const scenarioCount = Object.keys(savedScenarios).length;

        console.log(`Phase 1: Found ${scenarioCount} saved scenarios in storage`);

        if (scenarioCount === 0) {
            console.log('No saved scenarios found - create some to test!');
            return;
        }

        const scenarioGrid = document.querySelector('[data-scenario="budget_cuts"]').parentElement;
        if (!scenarioGrid) {
            console.error('âŒ Scenario grid not found');
            return;
        }

        // Add saved scenarios to the grid
        Object.values(savedScenarios).forEach(scenario => {
            console.log('Creating card for scenario:', scenario.title);
            const scenarioCard = createSavedScenarioCard(scenario);
            scenarioGrid.insertBefore(scenarioCard, scenarioGrid.lastElementChild);
        });

        console.log(`âœ… Added ${scenarioCount} saved scenario cards to scenario grid`);

    } catch (error) {
        console.error('âŒ Error loading saved scenarios:', error);
    }
}

function createSavedScenarioCard(scenario) {
    debugLog('ðŸŽ¨ Creating card for saved scenario:', scenario.title);

    const cardDiv = document.createElement('div');
    cardDiv.className = 'option-card saved-scenario';
    cardDiv.dataset.scenario = `saved_scenario_${scenario.id}`;

    cardDiv.innerHTML = `
        <div class="option-title">
            <span class="saved-badge-small">ðŸ’¾</span> ${scenario.title}
        </div>
        <div class="option-description">
            <strong>Type:</strong> ${scenario.type.replace('_', ' ')} â€¢ ${scenario.context.length > 80 ? scenario.context.substring(0, 80) + '...' : scenario.context}
        </div>
    `;

    // Add click handler for saved scenario
    cardDiv.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();

        // Clear other selections
        document.querySelectorAll('[data-scenario]').forEach(card => {
            card.classList.remove('selected');
        });

        // Select this card
        cardDiv.classList.add('selected');

        // Set app state
        appState.selectedScenario = `saved_scenario_${scenario.id}`;

        // Store the scenario data for use in conversation
        customScenarioData = scenario;

        debugLog('âœ… Selected saved scenario:', scenario.title);
        updateStartButton();
    });

    return cardDiv;
}
// ============================================
        // TAB SYSTEM FUNCTIONALITY (PHASE 2)
        // ============================================

        function initializeTabs() {
            debugLog('ðŸ—‚ï¸ Initializing tab system');

            // Add click handlers to tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    const targetTab = this.dataset.tab;
                    switchToTab(targetTab);
                });
            });

            // Load built-in personalities into Quick Start
            loadQuickStartPersonalities();

            // Update tab counts
            updateTabCounts();

            debugLog('âœ… Tab system initialized');
        }

        function switchToTab(tabId) {
            debugLog(`ðŸ—‚ï¸ Switching to tab: ${tabId}`);

            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabId}-tab`).classList.add('active');

            // Load tab-specific content
            switch(tabId) {
                case 'my-colleagues':
                    loadColleaguesTab();
                    break;
                case 'my-scenarios':
                    loadScenariosTab();
                    break;
                case 'disc-explorer':
                    loadDiscExplorerTab();
                    break;
            }
        }

        function loadQuickStartPersonalities() {
            debugLog('ðŸš€ Loading built-in personalities for Quick Start');

            const quickStartGrid = document.getElementById('quickStartPersonalities');
            if (!quickStartGrid) {
                debugLog('âŒ Quick start personalities grid not found');
                return;
            }

            // Clear existing content
            quickStartGrid.innerHTML = '';

            // Built-in personalities (excluding custom option)
            const builtInPersonalities = [
                {
                    id: 'infrastructure_engineer',
                    name: 'Terry Mitchell',
                    avatar: 'TM',
                    role: 'Senior Infrastructure Engineer',
                    description: 'Technical expert, detail-oriented'
                },
                {
                    id: 'community_engagement',
                    name: 'Sarah Chen',
                    avatar: 'SC',
                    role: 'Community Engagement Officer',
                    description: 'People-focused, diplomatic'
                },
                {
                    id: 'budget_director',
                    name: 'David Walsh',
                    avatar: 'DW',
                    role: 'Budget & Finance Director',
                    description: 'Numbers-driven, direct about constraints'
                },
                {
                    id: 'union_rep',
                    name: 'Maria Santos',
                    avatar: 'MS',
                    role: 'Union Representative',
                    description: 'Assertive advocate for workers\' rights'
                },
                {
                    id: 'councillor_thompson',
                    name: 'Robert Thompson',
                    avatar: 'RT',
                    role: 'Long-term Councillor',
                    description: 'Steady, consensus-building approach'
                },
                {
                    id: 'strategic_planner',
                    name: 'Emily Kim',
                    avatar: 'EK',
                    role: 'Strategic Planner',
                    description: 'Analytical yet enthusiastic about new ideas'
                }
            ];

            // Create cards for built-in personalities
            builtInPersonalities.forEach(personality => {
                const card = createBuiltInPersonalityCard(personality);
                quickStartGrid.appendChild(card);
            });
        }

        function createBuiltInPersonalityCard(personality) {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'personality-card';
            cardDiv.dataset.personality = personality.id;

            cardDiv.innerHTML = `
                <div class="personality-header">
                    <div class="personality-avatar">${personality.avatar}</div>
                    <div class="personality-info">
                        <div class="personality-name">${personality.name}</div>
                        <div class="personality-role">${personality.role}</div>
                    </div>
                </div>
                <div class="personality-description">
                    ${personality.description}
                </div>
            `;

            // Add click handler
            cardDiv.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();

                // Clear other selections in Quick Start
                document.querySelectorAll('#quickStartPersonalities .personality-card').forEach(card => {
                    card.classList.remove('selected');
                });

                // Select this card
                cardDiv.classList.add('selected');

                // Set app state
                appState.selectedPersonality = personality.id;

                debugLog('âœ… Selected built-in personality for Quick Start:', personality.name);
                updateQuickStartButton();
            });

            return cardDiv;
        }

        function updateQuickStartButton() {
            const quickStartBtn = document.getElementById('quickStartButton');

            if (!quickStartBtn) {
                debugLog('âš ï¸ Quick Start button not found');
                return;
            }

            const isReady = appState.selectedRole && appState.selectedScenario && appState.selectedPersonality;

            quickStartBtn.disabled = !isReady || !appState.isConnected;

            if (!appState.isConnected) {
                quickStartBtn.innerHTML = '<span>âš ï¸</span><span>Connecting to Service...</span>';
            } else if (!isReady) {
                quickStartBtn.innerHTML = '<span>ðŸš€</span><span>Begin Practice Session</span>';
            } else {
                quickStartBtn.innerHTML = '<span>ðŸš€</span><span>Begin Practice Session</span>';
            }

            debugLog('Quick Start button updated', { ready: isReady, connected: appState.isConnected });
        }

        function loadColleaguesTab() {
            debugLog('ðŸ‘¥ Loading My Colleagues tab');

            const colleaguesGrid = document.getElementById('colleaguesGrid');
            const colleaguesEmpty = document.getElementById('colleaguesEmpty');

            if (!colleaguesGrid || !colleaguesEmpty) {
                debugLog('âŒ Colleagues tab elements not found');
                return;
            }

            const savedColleagues = getStoredColleagues();
            const colleagueCount = Object.keys(savedColleagues).length;

            if (colleagueCount === 0) {
                colleaguesGrid.style.display = 'none';
                colleaguesEmpty.classList.remove('hidden');
            } else {
                colleaguesEmpty.classList.add('hidden');
                colleaguesGrid.style.display = 'grid';

                // Clear existing content
                colleaguesGrid.innerHTML = '';

                // Load enhanced colleague cards
                Object.values(savedColleagues).forEach(colleague => {
                    const card = createEnhancedColleagueCard(colleague);
                    colleaguesGrid.appendChild(card);
                });
            }
        }

        function createEnhancedColleagueCard(colleague) {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'enhanced-colleague-card';

            const initials = colleague.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
            const createdDate = new Date(colleague.created || colleague.saved_at || Date.now()).toLocaleDateString();

            cardDiv.innerHTML = `
                <div class="enhanced-card-header">
                    <div class="enhanced-avatar">${initials}</div>
                    <div class="enhanced-info">
                        <h4>${colleague.name}</h4>
                        <p>${colleague.role}</p>
                    </div>
                    <div class="enhanced-badge">ðŸ’¾</div>
                </div>
                <div class="enhanced-description">
                    ${colleague.personality.length > 100 ? colleague.personality.substring(0, 100) + '...' : colleague.personality}
                </div>
                <div class="enhanced-metadata">
                    <span class="metadata-item">Created: ${createdDate}</span>
                    <span class="metadata-item">Type: Custom</span>
                </div>
                <div class="enhanced-actions">
                    <button class="action-btn primary" onclick="useColleagueForPractice('${colleague.id}')">
                        ðŸš€ Use in Practice
                    </button>
                    <button class="action-btn secondary" onclick="editColleague('${colleague.id}')">
                        âœï¸ Edit
                    </button>
                </div>
            `;

            return cardDiv;
        }

        function loadScenariosTab() {
            debugLog('ðŸ“‹ Loading My Scenarios tab');

            const scenariosGrid = document.getElementById('scenariosGrid');
            const scenariosEmpty = document.getElementById('scenariosEmpty');

            if (!scenariosGrid || !scenariosEmpty) {
                debugLog('âŒ Scenarios tab elements not found');
                return;
            }

            const savedScenarios = getStoredScenarios();
            const scenarioCount = Object.keys(savedScenarios).length;

            if (scenarioCount === 0) {
                scenariosGrid.style.display = 'none';
                scenariosEmpty.classList.remove('hidden');
            } else {
                scenariosEmpty.classList.add('hidden');
                scenariosGrid.style.display = 'grid';

                // Clear existing content
                scenariosGrid.innerHTML = '';

                // Load enhanced scenario cards
                Object.values(savedScenarios).forEach(scenario => {
                    const card = createEnhancedScenarioCard(scenario);
                    scenariosGrid.appendChild(card);
                });
            }
        }

        function createEnhancedScenarioCard(scenario) {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'enhanced-scenario-card';

            const createdDate = new Date(scenario.created || scenario.saved_at || Date.now()).toLocaleDateString();
            const scenarioType = scenario.type ? scenario.type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'General';

            cardDiv.innerHTML = `
                <div class="enhanced-card-header">
                    <div class="scenario-type-badge">${scenarioType}</div>
                    <div class="enhanced-badge">ðŸ’¾</div>
                </div>
                <div class="enhanced-title">
                    <h4>${scenario.title}</h4>
                </div>
                <div class="enhanced-description">
                    ${scenario.context.length > 120 ? scenario.context.substring(0, 120) + '...' : scenario.context}
                </div>
                <div class="enhanced-metadata">
                    <span class="metadata-item">Created: ${createdDate}</span>
                    <span class="metadata-item">Type: ${scenarioType}</span>
                </div>
                <div class="enhanced-actions">
                    <button class="action-btn primary" onclick="useScenarioForPractice('${scenario.id}')">
                        ðŸš€ Use in Practice
                    </button>
                    <button class="action-btn secondary" onclick="editScenario('${scenario.id}')">
                        âœï¸ Edit
                    </button>
                </div>
            `;

            return cardDiv;
        }

        function loadDiscExplorerTab() {
            debugLog('ðŸ§  Loading DISC Explorer tab');
            // DISC Explorer content is static for now
            // Future: Add interactive elements, quizzes, etc.
        }

        function updateTabCounts() {
            try {
                const colleagues = getStoredColleagues();
                const scenarios = getStoredScenarios();

                const colleagueCount = Object.keys(colleagues).length;
                const scenarioCount = Object.keys(scenarios).length;

                const colleaguesTabCount = document.getElementById('colleaguesTabCount');
                const scenariosTabCount = document.getElementById('scenariosTabCount');

                if (colleaguesTabCount) colleaguesTabCount.textContent = colleagueCount;
                if (scenariosTabCount) scenariosTabCount.textContent = scenarioCount;

            } catch (error) {
                debugLog('Error updating tab counts', error);
            }
        }

        // Quick action functions
        function useColleagueForPractice(colleagueId) {
            debugLog('ðŸš€ Using colleague for practice:', colleagueId);
            // Switch to Quick Start tab and select this colleague
            // Future implementation
            alert('Feature coming soon: Quick practice with selected colleague');
        }

        function editColleague(colleagueId) {
            debugLog('âœï¸ Editing colleague:', colleagueId);
            // Future implementation
            alert('Feature coming soon: Edit colleague in-place');
        }

        function useScenarioForPractice(scenarioId) {
            debugLog('ðŸš€ Using scenario for practice:', scenarioId);
            // Switch to Quick Start tab and select this scenario
            // Future implementation
            alert('Feature coming soon: Quick practice with selected scenario');
        }

        function editScenario(scenarioId) {
            debugLog('âœï¸ Editing scenario:', scenarioId);
            // Future implementation
            alert('Feature coming soon: Edit scenario in-place');
        }
// ============================================
// INITIALIZATION
// ============================================
// Update the existing initializeApp function
function initializeApp() {
    debugLog('ðŸš€ Initializing Professional Conversation Trainer with Tabs');

    // Initialize tab system FIRST
    initializeTabs();

    // Set up existing event listeners
    setupEventListeners();

    // Test API connection
    testAPIConnection();

    // Update storage counts (both old and new systems)
    updateStorageCounts();
    updateTabCounts();

    // Load saved content (Phase 1 functionality)
    loadSavedColleagues();
    loadSavedScenarios();

    debugLog('âœ… Full application initialized with tab system');
}

// Initialize Application
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();

    // Update storage counts periodically
    setInterval(updateStorageCounts, 2000);
});
// ============================================
// IMPORT FUNCTIONS - Add these to your script
// ============================================

function importColleagues() {
    debugLog('ðŸ“‚ Starting colleague import process');

    // Create file input element
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.json';
    fileInput.style.display = 'none';

    fileInput.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) {
            debugLog('âŒ No file selected');
            return;
        }

        debugLog('ðŸ“„ File selected:', file.name);

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importData = JSON.parse(e.target.result);
                debugLog('ðŸ“‹ Import data parsed:', importData);

                // Validate file structure
                if (!importData.type || importData.type !== 'conversation_trainer_colleagues') {
                    throw new Error('Invalid file format. Please select a valid colleagues export file.');
                }

                if (!importData.colleagues || typeof importData.colleagues !== 'object') {
                    throw new Error('No colleague data found in file.');
                }

                // Get existing colleagues
                const existingColleagues = getStoredColleagues();
                const importedColleagues = importData.colleagues;

                let importedCount = 0;
                let duplicateCount = 0;

                // Process each imported colleague
                Object.values(importedColleagues).forEach(colleague => {
                    // Check for duplicates by name and role
                    const isDuplicate = Object.values(existingColleagues).some(existing =>
                        existing.name === colleague.name && existing.role === colleague.role
                    );

                    if (isDuplicate) {
                        duplicateCount++;
                        debugLog('âš ï¸ Duplicate found, skipping:', colleague.name);
                    } else {
                        // Generate new ID and add to storage
                        const newId = `colleague_imported_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                        colleague.id = newId;
                        colleague.imported_at = new Date().toISOString();

                        existingColleagues[newId] = colleague;
                        importedCount++;
                        debugLog('âœ… Imported colleague:', colleague.name);
                    }
                });

                // Save updated colleagues to storage
                localStorage.setItem('conversation_trainer_colleagues', JSON.stringify(existingColleagues));
                updateStorageCounts();

                // Show success message
                let message = `Successfully imported ${importedCount} colleague${importedCount === 1 ? '' : 's'}!`;
                if (duplicateCount > 0) {
                    message += ` (${duplicateCount} duplicate${duplicateCount === 1 ? '' : 's'} skipped)`;
                }

                showSuccessMessage(message);
                debugLog('ðŸŽ‰ Import completed', { imported: importedCount, duplicates: duplicateCount });

            } catch (error) {
                debugLog('âŒ Import error:', error);
                showErrorMessage(`Import failed: ${error.message}`);
            }
        };

        reader.onerror = function() {
            debugLog('âŒ File reading error');
            showErrorMessage('Error reading file. Please try again.');
        };

        reader.readAsText(file);
    };

    // Trigger file selection
    document.body.appendChild(fileInput);
    fileInput.click();
    document.body.removeChild(fileInput);
}

function importScenarios() {
    debugLog('ðŸ“‚ Starting scenario import process');

    // Create file input element
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.json';
    fileInput.style.display = 'none';

    fileInput.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) {
            debugLog('âŒ No file selected');
            return;
        }

        debugLog('ðŸ“„ File selected:', file.name);

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importData = JSON.parse(e.target.result);
                debugLog('ðŸ“‹ Import data parsed:', importData);

                // Validate file structure
                if (!importData.type || importData.type !== 'conversation_trainer_scenarios') {
                    throw new Error('Invalid file format. Please select a valid scenarios export file.');
                }

                if (!importData.scenarios || typeof importData.scenarios !== 'object') {
                    throw new Error('No scenario data found in file.');
                }

                // Get existing scenarios
                const existingScenarios = getStoredScenarios();
                const importedScenarios = importData.scenarios;

                let importedCount = 0;
                let duplicateCount = 0;

                // Process each imported scenario
                Object.values(importedScenarios).forEach(scenario => {
                    // Check for duplicates by title
                    const isDuplicate = Object.values(existingScenarios).some(existing =>
                        existing.title === scenario.title
                    );

                    if (isDuplicate) {
                        duplicateCount++;
                        debugLog('âš ï¸ Duplicate found, skipping:', scenario.title);
                    } else {
                        // Generate new ID and add to storage
                        const newId = `scenario_imported_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                        scenario.id = newId;
                        scenario.imported_at = new Date().toISOString();

                        existingScenarios[newId] = scenario;
                        importedCount++;
                        debugLog('âœ… Imported scenario:', scenario.title);
                    }
                });

                // Save updated scenarios to storage
                localStorage.setItem('conversation_trainer_scenarios', JSON.stringify(existingScenarios));
                updateStorageCounts();

                // Show success message
                let message = `Successfully imported ${importedCount} scenario${importedCount === 1 ? '' : 's'}!`;
                if (duplicateCount > 0) {
                    message += ` (${duplicateCount} duplicate${duplicateCount === 1 ? '' : 's'} skipped)`;
                }

                showSuccessMessage(message);
                debugLog('ðŸŽ‰ Import completed', { imported: importedCount, duplicates: duplicateCount });

            } catch (error) {
                debugLog('âŒ Import error:', error);
                showErrorMessage(`Import failed: ${error.message}`);
            }
        };

        reader.onerror = function() {
            debugLog('âŒ File reading error');
            showErrorMessage('Error reading file. Please try again.');
        };

        reader.readAsText(file);
    };

    // Trigger file selection
    document.body.appendChild(fileInput);
    fileInput.click();
    document.body.removeChild(fileInput);
}
// Update the refreshSavedContent function to also refresh tab counts
function refreshSavedContent() {
    debugLog('ðŸ”„ Refreshing saved content in UI and tabs');

    try {
        // Remove existing saved colleague cards (from Phase 1 grid)
        document.querySelectorAll('.personality-card.saved-colleague').forEach(card => {
            card.remove();
        });

        // Remove existing saved scenario cards (from Phase 1 grid)
        document.querySelectorAll('.option-card.saved-scenario').forEach(card => {
            card.remove();
        });

        // Reload saved content into Phase 1 grids
        loadSavedColleagues();
        loadSavedScenarios();

        // Update tab counts and content
        updateTabCounts();

        // Refresh tab content if currently viewing those tabs
        const activeTab = document.querySelector('.tab-content.active');
        if (activeTab) {
            const tabId = activeTab.id.replace('-tab', '');
            if (tabId === 'my-colleagues') {
                loadColleaguesTab();
            } else if (tabId === 'my-scenarios') {
                loadScenariosTab();
            }
        }

        debugLog('âœ… Saved content and tabs refreshed successfully');

    } catch (error) {
        debugLog('âŒ Error refreshing saved content:', error);
    }
}
// ============================================
// BULK IMPORT FUNCTION (Import Both Types)
// ============================================

function importData() {
    debugLog('ðŸ“‚ Starting bulk data import process');

    // Create file input element
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.json';
    fileInput.style.display = 'none';

    fileInput.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) {
            debugLog('âŒ No file selected');
            return;
        }

        debugLog('ðŸ“„ File selected:', file.name);

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importData = JSON.parse(e.target.result);
                debugLog('ðŸ“‹ Import data parsed:', importData);

                // Determine file type and import accordingly
                if (importData.type === 'conversation_trainer_colleagues') {
                    // Import colleagues
                    importColleaguesData(importData);
                } else if (importData.type === 'conversation_trainer_scenarios') {
                    // Import scenarios
                    importScenariosData(importData);
                } else {
                    throw new Error('Unknown file format. Please select a valid export file.');
                }

            } catch (error) {
                debugLog('âŒ Import error:', error);
                showErrorMessage(`Import failed: ${error.message}`);
            }
        };

        reader.onerror = function() {
            debugLog('âŒ File reading error');
            showErrorMessage('Error reading file. Please try again.');
        };

        reader.readAsText(file);
    };

    // Trigger file selection
    document.body.appendChild(fileInput);
    fileInput.click();
    document.body.removeChild(fileInput);
}

// Helper functions for bulk import
function importColleaguesData(importData) {
    if (!importData.colleagues || typeof importData.colleagues !== 'object') {
        throw new Error('No colleague data found in file.');
    }

    const existingColleagues = getStoredColleagues();
    const importedColleagues = importData.colleagues;

    let importedCount = 0;
    let duplicateCount = 0;

    Object.values(importedColleagues).forEach(colleague => {
        const isDuplicate = Object.values(existingColleagues).some(existing =>
            existing.name === colleague.name && existing.role === colleague.role
        );

        if (isDuplicate) {
            duplicateCount++;
        } else {
            const newId = `colleague_imported_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            colleague.id = newId;
            colleague.imported_at = new Date().toISOString();
            existingColleagues[newId] = colleague;
            importedCount++;
        }
    });

    localStorage.setItem('conversation_trainer_colleagues', JSON.stringify(existingColleagues));
    updateStorageCounts();

    let message = `Successfully imported ${importedCount} colleague${importedCount === 1 ? '' : 's'}!`;
    if (duplicateCount > 0) {
        message += ` (${duplicateCount} duplicate${duplicateCount === 1 ? '' : 's'} skipped)`;
    }

    showSuccessMessage(message);
}

function importScenariosData(importData) {
    if (!importData.scenarios || typeof importData.scenarios !== 'object') {
        throw new Error('No scenario data found in file.');
    }

    const existingScenarios = getStoredScenarios();
    const importedScenarios = importData.scenarios;

    let importedCount = 0;
    let duplicateCount = 0;

    Object.values(importedScenarios).forEach(scenario => {
        const isDuplicate = Object.values(existingScenarios).some(existing =>
            existing.title === scenario.title
        );

        if (isDuplicate) {
            duplicateCount++;
        } else {
            const newId = `scenario_imported_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            scenario.id = newId;
            scenario.imported_at = new Date().toISOString();
            existingScenarios[newId] = scenario;
            importedCount++;
        }
    });

    localStorage.setItem('conversation_trainer_scenarios', JSON.stringify(existingScenarios));
    updateStorageCounts();

    let message = `Successfully imported ${importedCount} scenario${importedCount === 1 ? '' : 's'}!`;
    if (duplicateCount > 0) {
        message += ` (${duplicateCount} duplicate${duplicateCount === 1 ? '' : 's'} skipped)`;
    }

    showSuccessMessage(message);
}
// ============================================
// ADDITIONAL STORAGE MANAGEMENT FUNCTIONS
// ============================================

function clearAllStorage() {
    const colleagues = getStoredColleagues();
    const scenarios = getStoredScenarios();

    const colleagueCount = Object.keys(colleagues).length;
    const scenarioCount = Object.keys(scenarios).length;

    if (colleagueCount === 0 && scenarioCount === 0) {
        showSuccessMessage('No data to clear. Storage is already empty.');
        return;
    }

    const message = `Are you sure you want to delete all stored data?\n\nThis will permanently remove:\nâ€¢ ${colleagueCount} saved colleague${colleagueCount === 1 ? '' : 's'}\nâ€¢ ${scenarioCount} saved scenario${scenarioCount === 1 ? '' : 's'}\n\nThis action cannot be undone.`;

    if (confirm(message)) {
        try {
            localStorage.removeItem('conversation_trainer_colleagues');
            localStorage.removeItem('conversation_trainer_scenarios');
            updateStorageCounts();

            debugLog('ðŸ—‘ï¸ All storage cleared');
            showSuccessMessage('All stored data has been cleared successfully.');

        } catch (error) {
            debugLog('âŒ Error clearing storage:', error);
            showErrorMessage('Error clearing storage. Please try again.');
        }
    }
}

// Enhanced test storage function with more details
function testStorage() {
    const colleagues = getStoredColleagues();
    const scenarios = getStoredScenarios();

    console.log('ðŸ“Š === CONVERSATION TRAINER STORAGE REPORT ===');
    console.log('ðŸ“š Stored Colleagues:', colleagues);
    console.log('ðŸ“‹ Stored Scenarios:', scenarios);
    console.log('ðŸ“ˆ Storage Statistics:', {
        colleagues: {
            count: Object.keys(colleagues).length,
            totalSize: JSON.stringify(colleagues).length + ' characters'
        },
        scenarios: {
            count: Object.keys(scenarios).length,
            totalSize: JSON.stringify(scenarios).length + ' characters'
        },
        lastUpdated: new Date().toISOString()
    });

    // Test localStorage availability
    try {
        localStorage.setItem('test', 'test');
        localStorage.removeItem('test');
        console.log('âœ… localStorage is working properly');
    } catch (error) {
        console.log('âŒ localStorage error:', error);
    }

    console.log('================================================');

    showSuccessMessage('Storage report generated. Check browser console for detailed information.');
}

debugLog('ðŸŽ¨ Professional Conversation Trainer Loaded');
</script>
</body>
</html>